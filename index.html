<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Í∞ÄÏ°∞Ïø† - ÏπúÍµ¨Îì§ÎßåÏùò SNS</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fafafa;
            color: #262626;
        }

        /* Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ */
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding: 20px;
            overflow-y: auto;
        }

        .login-box {
            background: white;
            border: 1px solid #dbdbdb;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            width: 100%;
            max-width: 380px;
            margin-top: 50px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .login-box h1 {
            font-size: 32px;
            color: #262626;
            margin-bottom: 30px;
            font-family: 'Billabong', cursive; /* Instagram font style */
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        .login-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #dbdbdb;
            border-radius: 5px;
            font-size: 16px;
            background: #fafafa;
        }

        .login-box button {
            width: 100%;
            padding: 12px;
            background: #405de6;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.2s ease-in-out;
        }

        .login-box button:hover {
            background: #3449b8;
        }

        .toggle-mode {
            margin-top: 20px;
            font-size: 14px;
            color: #8e8e8e;
        }

        .toggle-mode a {
            color: #405de6;
            font-weight: bold;
            text-decoration: none;
        }

        /* Î©îÏù∏ Ïï± Î†àÏù¥ÏïÑÏõÉ */
        .main-app {
            display: none; /* Î°úÍ∑∏Ïù∏ Ï†ÑÏóêÎäî Ïà®ÍπÄ */
            flex-direction: column;
            min-height: 100vh;
            max-width: 600px; /* Ïù∏Ïä§ÌÉÄÍ∑∏Îû®Í≥º Ïú†ÏÇ¨Ìïú ÏµúÎåÄ ÎÑàÎπÑ */
            margin: 0 auto;
            background: #fff;
            border-left: 1px solid #efefef;
            border-right: 1px solid #efefef;
        }

        /* ÏÉÅÎã® Î∞î */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #efefef;
            background: white;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .top-bar .logo {
            font-family: 'Billabong', cursive;
            font-size: 28px;
            color: #262626;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        .top-bar .icons i {
            font-size: 24px;
            margin-left: 20px;
            color: #262626;
            cursor: pointer;
        }

        /* Ïª®ÌÖêÏ∏† ÏòÅÏó≠ */
        .content {
            flex: 1;
            padding-bottom: 60px; /* ÌïòÎã® ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò Î∞î ÎÜíÏù¥ÎßåÌÅº Ïó¨Î∞± */
            overflow-y: auto; /* Í∞Å ÌÉ≠ ÎÇ¥Î∂Ä Ïä§ÌÅ¨Î°§ ÌóàÏö© */
            -webkit-overflow-scrolling: touch; /* iOS Î∂ÄÎìúÎü¨Ïö¥ Ïä§ÌÅ¨Î°§ */
        }

        .tab-content {
            display: none;
            padding: 10px 0;
        }

        .tab-content.active {
            display: block;
        }

        /* Ïä§ÌÜ†Î¶¨ ÏòÅÏó≠ */
        .stories-container {
            border-bottom: 1px solid #efefef;
            padding: 10px 0;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }

        .stories-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari */
        }

        .stories-scroll {
            display: inline-flex;
            padding: 0 10px;
        }

        .story-item {
            display: inline-block;
            text-align: center;
            margin: 0 8px;
        }

        .story-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 5px;
            position: relative;
        }

        .story-circle.seen {
            background: #dbdbdb; /* Î≥∏ Ïä§ÌÜ†Î¶¨Îäî ÌöåÏÉâ ÌÖåÎëêÎ¶¨ */
        }

        .story-item img {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            border: 2px solid white;
            object-fit: cover;
        }

        .story-item .username {
            font-size: 12px;
            color: #262626;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60px;
        }

        /* Ìè¨Ïä§Ìä∏ ÏûëÏÑ± */
        .create-post {
            background: white;
            border-bottom: 1px solid #efefef;
            padding: 15px;
            margin-bottom: 10px;
        }

        .create-post .create-header {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .create-post .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #eee;
            margin-right: 10px;
            background-size: cover;
            background-position: center;
        }

        .create-post .post-type {
            display: flex;
            background-color: #eee;
            border-radius: 20px;
            overflow: hidden;
            flex-grow: 1; /* Make it take available space */
        }

        .create-post .post-type .type-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: none;
            font-size: 14px;
            cursor: pointer;
            color: #8e8e8e;
            font-weight: bold;
            transition: background-color 0.2s ease, color 0.2s ease;
        }

        .create-post .post-type .type-btn.active {
            background-color: #405de6;
            color: white;
        }

        .create-post .create-input {
            width: 100%;
            border: 1px solid #efefef;
            border-radius: 8px;
            padding: 10px;
            font-size: 16px;
            min-height: 80px;
            resize: vertical;
            margin-bottom: 10px;
        }

        .create-post .meeting-selector {
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .create-post .meeting-selector label {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .create-post .meeting-selector input[type="checkbox"] {
            margin-right: 8px;
            width: auto;
        }

        .create-post .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: contain;
            margin-top: 10px;
            border-radius: 8px;
        }
        
        .create-post #imagePreview {
            width: 100%;
            max-height: 200px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }

        .create-post #imagePreview img {
            width: 100%;
            height: auto;
            object-fit: contain;
            border-radius: 8px;
        }

        .create-post .create-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .create-post .attach-btn, .create-post .post-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background 0.2s ease;
        }

        .create-post .attach-btn {
            background: #efefef;
            color: #262626;
        }

        .create-post .attach-btn:hover {
            background: #e0e0e0;
        }

        .create-post .post-btn {
            background: #405de6;
            color: white;
        }

        .create-post .post-btn:hover {
            background: #3449b8;
        }

        .hidden-file-input {
            display: none;
        }


        /* Ìè¨Ïä§Ìä∏ ÌîºÎìú */
        .post-card {
            background: white;
            border: 1px solid #efefef;
            margin-bottom: 10px;
            border-radius: 8px;
            overflow: hidden;
        }

        .post-header {
            display: flex;
            align-items: center;
            padding: 12px 15px;
        }

        .post-header .profile-pic {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #eee;
            margin-right: 10px;
            background-size: cover;
            background-position: center;
        }

        .post-header .username {
            font-weight: bold;
            color: #262626;
            font-size: 14px;
        }

        .post-image img {
            width: 100%;
            display: block;
            object-fit: cover;
        }

        .post-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
        }

        .post-actions .left-icons i {
            font-size: 24px;
            margin-right: 15px;
            cursor: pointer;
            color: #262626;
        }

        .post-actions .right-icon i {
            font-size: 24px;
            cursor: pointer;
            color: #262626;
        }
        
        .post-actions .left-icons i.liked {
            color: #ff3040; /* Ï¢ãÏïÑÏöî ÎàÑÎ•∏ ÏÉÅÌÉú */
        }


        .post-likes {
            font-weight: bold;
            font-size: 14px;
            padding: 0 15px 8px;
        }

        .post-content {
            font-size: 14px;
            padding: 0 15px 8px;
            word-wrap: break-word;
            white-space: pre-wrap;
        }

        .post-content .username {
            font-weight: bold;
            margin-right: 5px;
        }

        .post-comments {
            font-size: 13px;
            color: #8e8e8e;
            padding: 0 15px 8px;
            cursor: pointer;
        }

        .post-timestamp {
            font-size: 12px;
            color: #8e8e8e;
            padding: 0 15px 12px;
        }

        /* ÌïòÎã® ÎÇ¥ÎπÑÍ≤åÏù¥ÏÖò Î∞î */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            align-items: center;
            height: 50px;
            border-top: 1px solid #efefef;
            background: white;
            position: fixed;
            bottom: 0;
            width: 100%;
            max-width: 600px; /* Î©îÏù∏ Ïï± ÎÑàÎπÑÏôÄ ÏùºÏπò */
            box-sizing: border-box;
            z-index: 1000;
        }

        .bottom-nav .nav-item {
            flex: 1;
            text-align: center;
            cursor: pointer;
            color: #8e8e8e;
            font-size: 22px;
            transition: color 0.2s ease;
        }

        .bottom-nav .nav-item.active {
            color: #262626;
        }

        /* Í≤ÄÏÉâ/Îû≠ÌÇπ ÌÉ≠ */
        .search-container {
            padding: 15px;
        }

        .search-input-wrapper {
            margin-bottom: 15px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 10px 10px 40px; /* ÏôºÏ™Ω ÏïÑÏù¥ÏΩò Í≥µÍ∞Ñ ÌôïÎ≥¥ */
            border: 1px solid #dbdbdb;
            border-radius: 8px;
            font-size: 16px;
            background-color: #efefef;
        }

        .search-input-wrapper i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #8e8e8e;
            font-size: 18px;
        }

        .search-tabs {
            display: flex;
            border-bottom: 1px solid #efefef;
            margin-bottom: 15px;
        }

        .search-tab {
            flex: 1;
            padding: 10px 0;
            border: none;
            background: none;
            font-size: 15px;
            font-weight: bold;
            color: #8e8e8e;
            cursor: pointer;
            position: relative;
        }

        .search-tab.active {
            color: #262626;
        }

        .search-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px; /* border-bottomÍ≥º Í≤πÏπòÏßÄ ÏïäÍ≤å */
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #262626;
        }

        .ranking-list {
            padding: 0;
            list-style: none;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .ranking-number {
            font-size: 18px;
            font-weight: bold;
            color: #262626;
            width: 30px;
            text-align: center;
            margin-right: 15px;
        }

        .ranking-item .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #eee;
            margin-right: 10px;
            background-size: cover;
            background-position: center;
        }

        .ranking-item .info {
            flex: 1;
        }

        .ranking-item .info .username {
            font-weight: bold;
            font-size: 15px;
            color: #262626;
        }

        .ranking-item .info .details {
            font-size: 13px;
            color: #8e8e8e;
        }

        .ranking-item .info .details span {
            margin-right: 10px;
        }

        /* ÌîÑÎ°úÌïÑ ÌÉ≠ */
        .profile-header {
            padding: 20px 15px;
            border-bottom: 1px solid #efefef;
        }

        .profile-top {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .profile-pic-large {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background-color: #eee;
            margin-right: 30px;
            background-size: cover;
            background-position: center;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .profile-bio {
            font-size: 14px;
            color: #262626;
            margin-bottom: 10px;
        }

        .edit-profile-btn {
            background: #efefef;
            color: #262626;
            border: none;
            border-radius: 5px;
            padding: 8px 15px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }

        .profile-stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-number {
            font-size: 18px;
            font-weight: bold;
        }

        .stat-label {
            font-size: 14px;
            color: #8e8e8e;
        }

        #myPosts {
            padding: 10px 0;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 2px;
        }

        #myPosts img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }

        /* Î™®Îã¨ */
        .modal {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 20px;
            color: #262626;
        }

        .modal-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #8e8e8e;
            cursor: pointer;
        }

        .modal-body label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #262626;
        }

        .modal-body input[type="text"],
        .modal-body textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #dbdbdb;
            border-radius: 5px;
            font-size: 16px;
            background: #fafafa;
            resize: vertical;
        }

        .modal-body .profile-pic-upload {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-body .profile-pic-upload .current-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #eee;
            margin-right: 20px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0;
        }

        .modal-body .profile-pic-upload button {
            padding: 8px 15px;
            background: #efefef;
            color: #262626;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
        }

        .modal-footer {
            text-align: right;
            margin-top: 20px;
        }

        .modal-footer button {
            padding: 10px 20px;
            background: #405de6;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        
        /* Î°úÎî© Ïä§ÌîºÎÑà */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px; /* Adjust as needed */
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #405de6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>Í∞ÄÏ°∞Ïø†</h1>
            <input type="email" id="email" placeholder="Ïù¥Î©îÏùº">
            <input type="password" id="password" placeholder="ÎπÑÎ∞ÄÎ≤àÌò∏">
            <button id="authButton" onclick="handleAuth()">Î°úÍ∑∏Ïù∏</button>
            <div class="toggle-mode">
                Í≥ÑÏ†ïÏù¥ ÏóÜÏúºÏã†Í∞ÄÏöî? <a href="#" onclick="toggleAuthMode()">ÌöåÏõêÍ∞ÄÏûÖ</a>
            </div>
        </div>
    </div>

    <div class="main-app" id="mainApp">
        <div class="top-bar">
            <div class="logo">Í∞ÄÏ°∞Ïø†</div>
            <div class="icons">
                <i class="far fa-bell"></i>
                <i class="far fa-paper-plane"></i>
            </div>
        </div>

        <div class="content">
            <div id="home" class="tab-content active">
                <div class="stories-container">
                    <div class="stories-scroll" id="storiesContainer">
                        </div>
                </div>
                <div id="postFeed"></div>
            </div>

            <div id="create" class="tab-content">
                <div class="create-post">
                    <div class="create-header">
                        <div class="profile-pic" id="createProfilePic"></div>
                        <div style="flex: 1;">
                            <div class="post-type">
                                <button class="type-btn active" data-type="diary" onclick="selectPostType('diary')">üìù ÏùºÍ∏∞</button>
                                <button class="type-btn" data-type="meeting" onclick="selectPostType('meeting')">üë• ÎßåÎÇ®</button>
                            </div>
                        </div>
                    </div>
                    
                    <textarea class="create-input" id="postContent" placeholder="Ïò§Îäò Ïñ¥Îñ§ ÌïòÎ£®Î•º Î≥¥ÎÇ¥ÏÖ®ÎÇòÏöî?"></textarea>
                    
                    <div class="meeting-selector" id="meetingSelector">
                        <div style="margin-bottom: 8px; font-size: 12px; color: #8e8e8e;">ÎßåÎÇú ÏπúÍµ¨Îì§ÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî (Ïó¨Îü¨Î™Ö Í∞ÄÎä•)</div>
                        <div id="friendCheckboxes" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; max-height: 120px; overflow-y: auto;">
                            </div>
                        <div id="selectedFriends" style="margin-top: 8px; font-size: 12px; color: #405de6;"></div>
                    </div>
                    
                    <div id="imagePreview"></div>
                    
                    <div class="create-actions">
                        <button class="attach-btn" onclick="document.getElementById('imageInput').click()">
                            üì∑ ÏÇ¨ÏßÑ Ï≤®Î∂Ä
                        </button>
                        <button class="post-btn" onclick="createPost()">Í≤åÏãú</button>
                    </div>
                    
                    <input type="file" id="imageInput" class="hidden-file-input" accept="image/*" onchange="previewImage(this)">
                </div>
            </div>

            <div id="search" class="tab-content">
                <div class="search-container">
                    <div class="search-tabs">
                        <button class="search-tab active" onclick="showRankingTab('meeting')">ÎßåÎÇ®ÌÇπ</button>
                        <button class="search-tab" onclick="showRankingTab('popular')">Ïù∏Í∏∞Í∏Ä</button>
                        <button class="search-tab" onclick="showRankingTab('biho')">ÏôïÎπÑÌò∏</button>
                        <button class="search-tab" onclick="showRankingTab('stats')">ÌÜµÍ≥Ñ</button>
                    </div>
                    <div id="rankingContent"></div>
                </div>
            </div>

            <div id="profile" class="tab-content">
                <div class="profile-header">
                    <div class="profile-top">
                        <div class="profile-pic-large" id="profilePicLarge"></div>
                        <div class="profile-info">
                            <div class="profile-name" id="profileName"></div>
                            <div class="profile-bio" id="profileBio">ÏïàÎÖïÌïòÏÑ∏Ïöî! Í∞ÄÏ°∞Ïø†Ïùò ÏùºÏõêÏûÖÎãàÎã§ ‚ú®</div>
                            <button class="edit-profile-btn" onclick="openEditProfileModal()">ÌîÑÎ°úÌïÑ Ìé∏Ïßë</button>
                        </div>
                    </div>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="postCount">0</span>
                            <span class="stat-label">Í≤åÏãúÎ¨º</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="meetingCount">0</span>
                            <span class="stat-label">ÎßåÎÇ®</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="likeCount">0</span>
                            <span class="stat-label">Ï¢ãÏïÑÏöî</span>
                        </div>
                    </div>
                </div>
                <div id="myPosts"></div>
            </div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" data-tab="home" onclick="switchTab('home')">
                <i class="fas fa-home"></i>
            </div>
            <div class="nav-item" data-tab="search" onclick="switchTab('search')">
                <i class="fas fa-search"></i>
            </div>
            <div class="nav-item" data-tab="create" onclick="switchTab('create')">
                <i class="fas fa-plus-square"></i> </div>
            <div class="nav-item" data-tab="profile" onclick="switchTab('profile')">
                <i class="fas fa-user-circle"></i>
            </div>
        </div>
    </div>

    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ÌîÑÎ°úÌïÑ Ìé∏Ïßë</h2>
                <button class="modal-close-btn" onclick="closeEditProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="profile-pic-upload">
                    <div class="current-pic" id="editProfilePic"></div>
                    <button onclick="document.getElementById('profileImageInput').click()">ÏÇ¨ÏßÑ Î≥ÄÍ≤Ω</button>
                    <input type="file" id="profileImageInput" class="hidden-file-input" accept="image/*" onchange="previewProfileImage(this)">
                </div>
                <label for="editProfileName">Ïù¥Î¶Ñ</label>
                <input type="text" id="editProfileName">
                <label for="editProfileBio">ÏÜåÍ∞ú</label>
                <textarea id="editProfileBio" rows="3"></textarea>
            </div>
            <div class="modal-footer">
                <button onclick="saveProfile()">Ï†ÄÏû•</button>
            </div>
        </div>
    </div>

    <div id="storyModal" class="modal">
        <div class="modal-content" style="max-width: 320px; padding: 0; border-radius: 0;">
            <div class="story-modal-image" style="width: 100%; height: 100%; background-color: black; display: flex; align-items: center; justify-content: center;">
                <img id="modalStoryImage" style="max-width: 100%; max-height: 100%; object-fit: contain;">
            </div>
            <div class="story-modal-info" style="position: absolute; top: 15px; left: 15px; right: 15px; display: flex; align-items: center; color: white; text-shadow: 0 0 5px rgba(0,0,0,0.5);">
                <div class="profile-pic" id="modalStoryProfilePic" style="width: 30px; height: 30px; margin-right: 10px; flex-shrink: 0;"></div>
                <span id="modalStoryUsername" style="font-weight: bold; margin-right: 10px;"></span>
                <span id="modalStoryTimestamp" style="font-size: 12px; opacity: 0.8;"></span>
            </div>
            <button class="modal-close-btn" onclick="closeStoryModal()" style="position: absolute; top: 10px; right: 10px; color: white; font-size: 30px; text-shadow: 0 0 5px rgba(0,0,0,0.5);">&times;</button>
        </div>
    </div>
    
    <div id="commentsModal" class="modal">
        <div class="modal-content" style="max-width: 500px; height: 90vh; display: flex; flex-direction: column; padding: 15px; border-radius: 8px;">
            <div class="modal-header" style="padding-bottom: 10px; border-bottom: 1px solid #efefef; margin-bottom: 10px;">
                <h2 style="font-size: 18px;">ÎåìÍ∏Ä</h2>
                <button class="modal-close-btn" onclick="closeCommentsModal()">&times;</button>
            </div>
            <div class="modal-body" style="flex: 1; overflow-y: auto; padding-right: 10px;">
                <ul id="commentsList" style="list-style: none; padding: 0;">
                    </ul>
                <div class="loading-spinner" id="commentsLoadingSpinner" style="display: none;">
                    <div class="spinner"></div>
                </div>
            </div>
            <div class="modal-footer" style="padding-top: 10px; border-top: 1px solid #efefef; margin-top: 10px; display: flex; align-items: center;">
                <input type="text" id="commentInput" placeholder="ÎåìÍ∏Ä Îã¨Í∏∞..." style="flex: 1; padding: 8px 12px; border: 1px solid #dbdbdb; border-radius: 20px; font-size: 14px; margin-right: 10px;">
                <button onclick="addComment()" style="background: #405de6; color: white; border: none; border-radius: 20px; padding: 8px 15px; font-size: 14px; font-weight: bold; cursor: pointer;">Í≤åÏãú</button>
            </div>
        </div>
    </div>

    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <script>
        // Your Firebase configuration
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let authMode = 'login'; // 'login' or 'signup'
        let currentUser = null;
        let selectedFriendsForMeeting = [];
        let currentOpenPostId = null; // ÎåìÍ∏Ä Î™®Îã¨ÏóêÏÑú ÌòÑÏû¨ Ïó¥Î¶∞ Í≤åÏãúÎ¨ºÏùò IDÎ•º Ï∂îÏ†Å

        // Authentication State Change Listener
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                loadUserData();
                loadFriends(); // ÏπúÍµ¨ Î™©Î°ù Î°úÎìú
                loadStories(); // Ïä§ÌÜ†Î¶¨ Î°úÎìú
                loadPosts(); // Í≤åÏãúÎ¨º Î°úÎìú
                loadMyPosts(); // ÎÇ¥ Í≤åÏãúÎ¨º Î°úÎìú
                switchTab('home'); // Î°úÍ∑∏Ïù∏ ÌõÑ Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Ìôà ÌÉ≠ ÌôúÏÑ±Ìôî
            } else {
                currentUser = null;
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        });

        function toggleAuthMode() {
            authMode = authMode === 'login' ? 'signup' : 'login';
            const authButton = document.getElementById('authButton');
            const toggleLink = document.querySelector('.toggle-mode a');

            if (authMode === 'login') {
                authButton.textContent = 'Î°úÍ∑∏Ïù∏';
                toggleLink.textContent = 'ÌöåÏõêÍ∞ÄÏûÖ';
                toggleLink.parentNode.firstChild.nodeValue = 'Í≥ÑÏ†ïÏù¥ ÏóÜÏúºÏã†Í∞ÄÏöî? ';
            } else {
                authButton.textContent = 'ÌöåÏõêÍ∞ÄÏûÖ';
                toggleLink.textContent = 'Î°úÍ∑∏Ïù∏';
                toggleLink.parentNode.firstChild.nodeValue = 'Ïù¥ÎØ∏ Í≥ÑÏ†ïÏù¥ ÏûàÏúºÏã†Í∞ÄÏöî? ';
            }
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (authMode === 'login') {
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    alert('Î°úÍ∑∏Ïù∏ ÏÑ±Í≥µ!');
                } catch (error) {
                    alert('Î°úÍ∑∏Ïù∏ Ïã§Ìå®: ' + error.message);
                }
            } else {
                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                    await db.collection('users').doc(userCredential.user.uid).set({
                        email: email,
                        username: email.split('@')[0], // Ï¥àÍ∏∞ ÏÇ¨Ïö©Ïûê Ïù¥Î¶ÑÏùÄ Ïù¥Î©îÏùº ÏïûÎ∂ÄÎ∂ÑÏúºÎ°ú ÏÑ§Ï†ï
                        bio: 'ÏïàÎÖïÌïòÏÑ∏Ïöî! Í∞ÄÏ°∞Ïø†Ïùò ÏùºÏõêÏûÖÎãàÎã§ ‚ú®',
                        profilePicUrl: '' // Ï¥àÍ∏∞ ÌîÑÎ°úÌïÑ ÏÇ¨ÏßÑ ÏóÜÏùå
                    });
                    alert('ÌöåÏõêÍ∞ÄÏûÖ ÏÑ±Í≥µ!');
                } catch (error) {
                    alert('ÌöåÏõêÍ∞ÄÏûÖ Ïã§Ìå®: ' + error.message);
                }
            }
        }

        async function loadUserData() {
            if (!currentUser) return;
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            if (userDoc.exists) {
                const userData = userDoc.data();
                document.getElementById('profileName').textContent = userData.username || 'ÏÇ¨Ïö©Ïûê';
                document.getElementById('profileBio').textContent = userData.bio || 'ÏïàÎÖïÌïòÏÑ∏Ïöî! Í∞ÄÏ°∞Ïø†Ïùò ÏùºÏõêÏûÖÎãàÎã§ ‚ú®';
                updateProfilePic(userData.profilePicUrl);
                document.getElementById('editProfileName').value = userData.username || '';
                document.getElementById('editProfileBio').value = userData.bio || '';
            }
        }

        function updateProfilePic(url) {
            const defaultPic = 'https://via.placeholder.com/150/EEEEEE/888888?text=;)'; // Í∏∞Î≥∏ Ïù¥ÎØ∏ÏßÄ
            const picUrl = url || defaultPic;
            const profilePics = document.querySelectorAll('.profile-pic, .profile-pic-large, #createProfilePic, #editProfilePic, #modalStoryProfilePic');
            profilePics.forEach(picElement => {
                picElement.style.backgroundImage = `url('${picUrl}')`;
            });
        }

        // ÌîÑÎ°úÌïÑ Ìé∏Ïßë Î™®Îã¨
        function openEditProfileModal() {
            document.getElementById('editProfileModal').classList.add('active');
            // ÌòÑÏû¨ ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥Î•º Î™®Îã¨Ïóê ÎØ∏Î¶¨ Ï±ÑÏõÅÎãàÎã§.
            document.getElementById('editProfileName').value = document.getElementById('profileName').textContent;
            document.getElementById('editProfileBio').textContent = document.getElementById('profileBio').textContent;
            const currentProfilePicUrl = document.getElementById('profilePicLarge').style.backgroundImage.slice(5, -2);
            document.getElementById('editProfilePic').style.backgroundImage = `url('${currentProfilePicUrl}')`;
        }

        function closeEditProfileModal() {
            document.getElementById('editProfileModal').classList.remove('active');
        }

        async function previewProfileImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('editProfilePic').style.backgroundImage = `url('${e.target.result}')`;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        async function saveProfile() {
            if (!currentUser) return;

            const newName = document.getElementById('editProfileName').value;
            const newBio = document.getElementById('editProfileBio').value;
            const profileImageFile = document.getElementById('profileImageInput').files[0];

            try {
                let profilePicUrl = document.getElementById('editProfilePic').style.backgroundImage.slice(5, -2); // ÌòÑÏû¨ Î™®Îã¨Ïóê ÌëúÏãúÎêú Ïù¥ÎØ∏ÏßÄ URL

                if (profileImageFile) {
                    const storageRef = firebase.storage().ref();
                    const imageRef = storageRef.child(`profile_pics/${currentUser.uid}/${profileImageFile.name}`);
                    await imageRef.put(profileImageFile);
                    profilePicUrl = await imageRef.getDownloadURL();
                }

                await db.collection('users').doc(currentUser.uid).update({
                    username: newName,
                    bio: newBio,
                    profilePicUrl: profilePicUrl
                });
                alert('ÌîÑÎ°úÌïÑÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
                closeEditProfileModal();
                loadUserData(); // Î≥ÄÍ≤ΩÎêú ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥ Îã§Ïãú Î°úÎìú
            } catch (error) {
                alert('ÌîÑÎ°úÌïÑ Ï†ÄÏû• Ïã§Ìå®: ' + error.message);
                console.error("Error saving profile: ", error);
            }
        }
        
        // Í≤åÏãúÎ¨º ÏûëÏÑ±
        let currentPostType = 'diary';
        let selectedFriendsData = []; // ÏÑ†ÌÉùÎêú ÏπúÍµ¨Îì§Ïùò UIDÏôÄ username Ï†ÄÏû•

        function selectPostType(type) {
            currentPostType = type;
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.type-btn[data-type="${type}"]`).classList.add('active');

            const meetingSelector = document.getElementById('meetingSelector');
            if (type === 'meeting') {
                meetingSelector.style.display = 'block';
            } else {
                meetingSelector.style.display = 'none';
            }
        }

        async function loadFriends() {
            if (!currentUser) return;
            const friendsSnapshot = await db.collection('users').get(); // Î™®Îì† ÏÇ¨Ïö©Ïûê Í∞ÄÏ†∏Ïò§Í∏∞
            const friendCheckboxesDiv = document.getElementById('friendCheckboxes');
            friendCheckboxesDiv.innerHTML = '';
            selectedFriendsData = []; // ÏπúÍµ¨ Î™©Î°ù Î°úÎìú Ïãú Ï¥àÍ∏∞Ìôî

            friendsSnapshot.forEach(doc => {
                if (doc.id !== currentUser.uid) { // Î≥∏Ïù∏ Ï†úÏô∏
                    const friendData = doc.data();
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'friend-checkbox-item';
                    checkboxDiv.innerHTML = `
                        <input type="checkbox" id="friend-${doc.id}" value="${doc.id}" data-username="${friendData.username}" onclick="toggleFriendSelection('${doc.id}', '${friendData.username}', this.checked)">
                        <label for="friend-${doc.id}">${friendData.username}</label>
                    `;
                    friendCheckboxesDiv.appendChild(checkboxDiv);
                }
            });
            updateSelectedFriendsDisplay();
        }

        function toggleFriendSelection(uid, username, isChecked) {
            if (isChecked) {
                selectedFriendsData.push({ uid, username });
            } else {
                selectedFriendsData = selectedFriendsData.filter(friend => friend.uid !== uid);
            }
            updateSelectedFriendsDisplay();
        }

        function updateSelectedFriendsDisplay() {
            const selectedFriendsDiv = document.getElementById('selectedFriends');
            if (selectedFriendsData.length > 0) {
                selectedFriendsDiv.textContent = `ÏÑ†ÌÉùÎêú ÏπúÍµ¨: ${selectedFriendsData.map(f => f.username).join(', ')}`;
            } else {
                selectedFriendsDiv.textContent = '';
            }
        }

        async function createPost() {
            if (!currentUser) {
                alert('Î°úÍ∑∏Ïù∏ ÌõÑ Í≤åÏãúÎ¨ºÏùÑ ÏûëÏÑ±Ìï† Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }

            const postContent = document.getElementById('postContent').value;
            const imageInput = document.getElementById('imageInput');
            const imageFile = imageInput.files[0];

            if (!postContent && !imageFile) {
                alert('ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•ÌïòÍ±∞ÎÇò ÏÇ¨ÏßÑÏùÑ Ï≤®Î∂ÄÌï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            let imageUrl = '';
            if (imageFile) {
                try {
                    const storageRef = firebase.storage().ref();
                    const imageRef = storageRef.child(`post_images/${currentUser.uid}/${Date.now()}_${imageFile.name}`);
                    await imageRef.put(imageFile);
                    imageUrl = await imageRef.getDownloadURL();
                } catch (error) {
                    alert('Ïù¥ÎØ∏ÏßÄ ÏóÖÎ°úÎìú Ïã§Ìå®: ' + error.message);
                    console.error("Error uploading image: ", error);
                    return;
                }
            }

            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                const postData = {
                    userId: currentUser.uid,
                    username: userData.username,
                    profilePicUrl: userData.profilePicUrl || '',
                    content: postContent,
                    imageUrl: imageUrl,
                    type: currentPostType,
                    likes: 0,
                    commentsCount: 0,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (currentPostType === 'meeting') {
                    if (selectedFriendsData.length === 0) {
                        alert('ÎßåÎÇ® Í≤åÏãúÎ¨ºÏùÄ ÎßåÎÇú ÏπúÍµ¨Î•º 1Î™Ö Ïù¥ÏÉÅ ÏÑ†ÌÉùÌï¥Ïïº Ìï©ÎãàÎã§.');
                        return;
                    }
                    postData.metFriends = selectedFriendsData;
                }

                await db.collection('posts').add(postData);
                alert('Í≤åÏãúÎ¨ºÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏûëÏÑ±ÎêòÏóàÏäµÎãàÎã§!');
                document.getElementById('postContent').value = '';
                imageInput.value = ''; // ÌååÏùº ÏûÖÎ†• Ï¥àÍ∏∞Ìôî
                document.getElementById('imagePreview').innerHTML = ''; // Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞ Ï¥àÍ∏∞Ìôî
                selectedFriendsData = []; // ÏÑ†ÌÉù ÏπúÍµ¨ Î™©Î°ù Ï¥àÍ∏∞Ìôî
                document.querySelectorAll('#friendCheckboxes input[type="checkbox"]').forEach(checkbox => checkbox.checked = false);
                updateSelectedFriendsDisplay();
                selectPostType('diary'); // Í∏∞Î≥∏Í∞íÏúºÎ°ú ÎêòÎèåÎ¶¨Í∏∞
                loadPosts(); // Í≤åÏãúÎ¨º Îã§Ïãú Î°úÎìú
                loadMyPosts(); // ÎÇ¥ Í≤åÏãúÎ¨º Îã§Ïãú Î°úÎìú
            } catch (error) {
                alert('Í≤åÏãúÎ¨º ÏûëÏÑ± Ïã§Ìå®: ' + error.message);
                console.error("Error creating post: ", error);
            }
        }

        function previewImage(input) {
            const imagePreview = document.getElementById('imagePreview');
            imagePreview.innerHTML = ''; // Í∏∞Ï°¥ ÎØ∏Î¶¨Î≥¥Í∏∞ Ï¥àÍ∏∞Ìôî
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.className = 'image-preview'; // CSS ÌÅ¥ÎûòÏä§ Ï†ÅÏö©
                    imagePreview.appendChild(img);
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // ÌÉ≠ Ï†ÑÌôò Ìï®Ïàò
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.nav-item[data-tab="${tabId}"]`).classList.add('active');

            // ÌÉ≠ Ï†ÑÌôò Ïãú Ïä§ÌÅ¨Î°§ÏùÑ Îß® ÏúÑÎ°ú
            document.querySelector('.content').scrollTo(0, 0);
        }

        // Ïä§ÌÜ†Î¶¨ Î°úÎìú
        async function loadStories() {
            const storiesContainer = document.getElementById('storiesContainer');
            storiesContainer.innerHTML = ''; // Í∏∞Ï°¥ Ïä§ÌÜ†Î¶¨ ÏßÄÏö∞Í∏∞

            // ÎçîÎØ∏ Ïä§ÌÜ†Î¶¨ Îç∞Ïù¥ÌÑ∞ (Ïã§Ï†ú Ïï±ÏóêÏÑúÎäî FirebaseÏóêÏÑú Í∞ÄÏ†∏Ïò¨ Í≤É)
            const dummyStories = [
                { id: 'story1', userId: 'user1', username: 'ÏÉàÎ°úÏö¥ÏπúÍµ¨', profilePicUrl: 'https://via.placeholder.com/150/0000FF/FFFFFF?text=NEW', imageUrl: 'https://via.placeholder.com/300/FFFF00/000000?text=Story1', timestamp: new Date(Date.now() - 3600000).toISOString(), seen: false },
                { id: 'story2', userId: 'user2', username: 'ÏΩîÎî©ÎßàÏä§ÌÑ∞', profilePicUrl: 'https://via.placeholder.com/150/FF0000/FFFFFF?text=COD', imageUrl: 'https://via.placeholder.com/300/00FFFF/000000?text=Story2', timestamp: new Date(Date.now() - 7200000).toISOString(), seen: false },
                { id: 'story3', userId: 'user3', username: 'ÎîîÏûêÏù∏Ï≤úÏû¨', profilePicUrl: 'https://via.placeholder.com/150/00FF00/FFFFFF?text=DES', imageUrl: 'https://via.placeholder.com/300/FF00FF/000000?text=Story3', timestamp: new Date(Date.now() - 10800000).toISOString(), seen: true },
                { id: 'story4', userId: 'user4', username: 'Í∞úÎ∞úÌïòÎäîÍ∞ïÏïÑÏßÄ', profilePicUrl: 'https://via.placeholder.com/150/FFA500/FFFFFF?text=DOG', imageUrl: 'https://via.placeholder.com/300/800080/FFFFFF?text=Story4', timestamp: new Date(Date.now() - 14400000).toISOString(), seen: false },
                { id: 'story5', userId: 'user5', username: 'ÌîÑÎ°†Ìä∏ÏóîÎìúÏû•Ïù∏', profilePicUrl: 'https://via.placeholder.com/150/800080/FFFFFF?text=FE', imageUrl: 'https://via.placeholder.com/300/008080/FFFFFF?text=Story5', timestamp: new Date(Date.now() - 18000000).toISOString(), seen: true },
                { id: 'story6', userId: 'user6', username: 'Î∞±ÏóîÎìúÍ≥†Ïàò', profilePicUrl: 'https://via.placeholder.com/150/008080/FFFFFF?text=BE', imageUrl: 'https://via.placeholder.com/300/A52A2A/FFFFFF?text=Story6', timestamp: new Date(Date.now() - 21600000).toISOString(), seen: false }
            ];

            // ÏûêÏã†Ïùò Ïä§ÌÜ†Î¶¨ Ï∂îÍ∞Ä (ÏòàÏãú)
            if (currentUser) {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();
                if (userData) {
                    const myStory = {
                        id: 'myStory',
                        userId: currentUser.uid,
                        username: 'ÎÇ¥ Ïä§ÌÜ†Î¶¨',
                        profilePicUrl: userData.profilePicUrl || 'https://via.placeholder.com/150/EEEEEE/888888?text=;)',
                        imageUrl: 'https://via.placeholder.com/300/32CD32/000000?text=MyStory', // ÏûÑÏãú Ïù¥ÎØ∏ÏßÄ
                        timestamp: new Date().toISOString(),
                        seen: false // Ìï≠ÏÉÅ Ïïà Î≥∏ Í≤ÉÏúºÎ°ú ÌëúÏãú
                    };
                    storiesContainer.appendChild(createStoryElement(myStory));
                }
            }

            dummyStories.forEach(story => {
                storiesContainer.appendChild(createStoryElement(story));
            });
        }

        function createStoryElement(story) {
            const storyItem = document.createElement('div');
            storyItem.className = 'story-item';
            storyItem.onclick = () => openStoryModal(story);

            const storyCircle = document.createElement('div');
            storyCircle.className = `story-circle ${story.seen ? 'seen' : ''}`;
            
            const profileImg = document.createElement('img');
            profileImg.src = story.profilePicUrl || 'https://via.placeholder.com/150/EEEEEE/888888?text=;)';
            profileImg.alt = story.username;

            const usernameSpan = document.createElement('span');
            usernameSpan.className = 'username';
            usernameSpan.textContent = story.username;

            storyCircle.appendChild(profileImg);
            storyItem.appendChild(storyCircle);
            storyItem.appendChild(usernameSpan);

            return storyItem;
        }

        function openStoryModal(story) {
            document.getElementById('modalStoryImage').src = story.imageUrl;
            document.getElementById('modalStoryProfilePic').style.backgroundImage = `url('${story.profilePicUrl || 'https://via.placeholder.com/150/EEEEEE/888888?text=;)'}')`;
            document.getElementById('modalStoryUsername').textContent = story.username;
            document.getElementById('modalStoryTimestamp').textContent = formatTimeAgo(story.timestamp);
            document.getElementById('storyModal').classList.add('active');
        }

        function closeStoryModal() {
            document.getElementById('storyModal').classList.remove('active');
        }


        // Í≤åÏãúÎ¨º Î°úÎìú
        async function loadPosts() {
            const postFeed = document.getElementById('postFeed');
            postFeed.innerHTML = ''; // Í∏∞Ï°¥ Í≤åÏãúÎ¨º ÏßÄÏö∞Í∏∞

            const postsSnapshot = await db.collection('posts').orderBy('timestamp', 'desc').get();
            postsSnapshot.forEach(doc => {
                const post = { id: doc.id, ...doc.data() };
                postFeed.appendChild(createPostElement(post));
            });

            // Í≤åÏãúÎ¨º Ïàò ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('postCount').textContent = postsSnapshot.size;
        }

        async function createPostElement(post) {
            const postCard = document.createElement('div');
            postCard.className = 'post-card';

            const userDoc = await db.collection('users').doc(post.userId).get();
            const userData = userDoc.data();
            const username = userData ? userData.username : 'Ïïå Ïàò ÏóÜÎäî ÏÇ¨Ïö©Ïûê';
            const profilePicUrl = userData ? (userData.profilePicUrl || 'https://via.placeholder.com/150/EEEEEE/888888?text=;)') : 'https://via.placeholder.com/150/EEEEEE/888888?text=;)';
            
            let postContentHtml = ``;
            if (post.type === 'meeting' && post.metFriends && post.metFriends.length > 0) {
                const friendNames = post.metFriends.map(f => `<span style="font-weight: bold;">@${f.username}</span>`).join(', ');
                postContentHtml += `<div style="margin-bottom: 5px;">${username}ÎãòÍ≥º ${friendNames}ÎãòÍ≥ºÏùò ÎßåÎÇ® ‚ú®</div>`;
            } else {
                postContentHtml += `<span class="username">${username}</span> `;
            }
            postContentHtml += post.content.replace(/\n/g, '<br>'); // Ï§ÑÎ∞îÍøà Ï†ÅÏö©

            postCard.innerHTML = `
                <div class="post-header">
                    <div class="profile-pic" style="background-image: url('${profilePicUrl}');"></div>
                    <div class="username">${username}</div>
                </div>
                ${post.imageUrl ? `<div class="post-image"><img src="${post.imageUrl}" alt="Post Image"></div>` : ''}
                <div class="post-actions">
                    <div class="left-icons">
                        <i class="far fa-heart" data-post-id="${post.id}" onclick="toggleLike('${post.id}')"></i>
                        <i class="far fa-comment" onclick="openCommentsModal('${post.id}')"></i>
                    </div>
                    <div class="right-icon">
                        <i class="far fa-bookmark"></i>
                    </div>
                </div>
                <div class="post-likes" id="likes-${post.id}">Ï¢ãÏïÑÏöî ${post.likes || 0}Í∞ú</div>
                <div class="post-content">${postContentHtml}</div>
                <div class="post-comments" onclick="openCommentsModal('${post.id}')">ÎåìÍ∏Ä ${post.commentsCount || 0}Í∞ú Î™®Îëê Î≥¥Í∏∞</div>
                <div class="post-timestamp">${formatTimeAgo(post.timestamp ? post.timestamp.toDate() : new Date())}</div>
            `;
            
            // Ï¢ãÏïÑÏöî ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
            if (currentUser) {
                const likeDoc = await db.collection('likes').doc(`${post.id}_${currentUser.uid}`).get();
                if (likeDoc.exists) {
                    postCard.querySelector(`.fa-heart`).classList.add('fas', 'liked');
                    postCard.querySelector(`.fa-heart`).classList.remove('far');
                }
            }

            return postCard;
        }

        async function toggleLike(postId) {
            if (!currentUser) {
                alert('Î°úÍ∑∏Ïù∏ ÌõÑ Ï¢ãÏïÑÏöîÎ•º ÎàÑÎ•º Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }

            const likeRef = db.collection('likes').doc(`${postId}_${currentUser.uid}`);
            const postRef = db.collection('posts').doc(postId);

            try {
                const likeDoc = await likeRef.get();
                const postDoc = await postRef.get();
                if (!postDoc.exists) return; // Í≤åÏãúÎ¨ºÏù¥ ÏóÜÎäî Í≤ΩÏö∞

                let newLikes = postDoc.data().likes || 0;

                if (likeDoc.exists) {
                    // Ï¢ãÏïÑÏöî Ï∑®ÏÜå
                    await likeRef.delete();
                    newLikes--;
                    document.querySelector(`.post-card [data-post-id="${postId}"]`).classList.remove('fas', 'liked');
                    document.querySelector(`.post-card [data-post-id="${postId}"]`).classList.add('far');
                } else {
                    // Ï¢ãÏïÑÏöî
                    await likeRef.set({ userId: currentUser.uid, postId: postId, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
                    newLikes++;
                    document.querySelector(`.post-card [data-post-id="${postId}"]`).classList.add('fas', 'liked');
                    document.querySelector(`.post-card [data-post-id="${postId}"]`).classList.remove('far');
                }
                
                await postRef.update({ likes: newLikes });
                document.getElementById(`likes-${postId}`).textContent = `Ï¢ãÏïÑÏöî ${newLikes}Í∞ú`;

                // ÎÇ¥ Ï¢ãÏïÑÏöî Ïàò ÏóÖÎç∞Ïù¥Ìä∏
                updateMyLikeCount();

            } catch (error) {
                console.error("Error toggling like: ", error);
            }
        }
        
        async function updateMyLikeCount() {
            if (!currentUser) return;
            const myPostsSnapshot = await db.collection('posts').where('userId', '==', currentUser.uid).get();
            let totalLikes = 0;
            myPostsSnapshot.forEach(doc => {
                totalLikes += (doc.data().likes || 0);
            });
            document.getElementById('likeCount').textContent = totalLikes;
        }


        // ÎÇ¥ Í≤åÏãúÎ¨º Î°úÎìú
        async function loadMyPosts() {
            if (!currentUser) return;
            const myPostsDiv = document.getElementById('myPosts');
            myPostsDiv.innerHTML = '';

            const postsSnapshot = await db.collection('posts')
                                        .where('userId', '==', currentUser.uid)
                                        .orderBy('timestamp', 'desc')
                                        .get();
            postsSnapshot.forEach(doc => {
                const post = doc.data();
                if (post.imageUrl) {
                    const imgElement = document.createElement('img');
                    imgElement.src = post.imageUrl;
                    imgElement.alt = 'My Post';
                    myPostsDiv.appendChild(imgElement);
                }
            });
            
            // ÎÇ¥ Í≤åÏãúÎ¨º Ïàò Î∞è ÎßåÎÇ® ÌöüÏàò ÏóÖÎç∞Ïù¥Ìä∏
            document.getElementById('postCount').textContent = postsSnapshot.size;
            const meetingPostsSnapshot = await db.collection('posts')
                                                .where('userId', '==', currentUser.uid)
                                                .where('type', '==', 'meeting')
                                                .get();
            document.getElementById('meetingCount').textContent = meetingPostsSnapshot.size;
            updateMyLikeCount(); // ÎÇ¥ Ï¢ãÏïÑÏöî Ïàò Î°úÎìú Ïãú ÏóÖÎç∞Ïù¥Ìä∏
        }


        // Îû≠ÌÇπ ÌÉ≠ Í¥ÄÎ†®
        async function showRankingTab(tabType) {
            document.querySelectorAll('.search-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`.search-tab[onclick="showRankingTab('${tabType}')"]`).classList.add('active');

            const rankingContent = document.getElementById('rankingContent');
            rankingContent.innerHTML = '<div class="loading-spinner"><div class="spinner"></div></div>'; // Î°úÎî© Ïä§ÌîºÎÑà ÌëúÏãú

            if (tabType === 'meeting') {
                await loadMeetingRanking(rankingContent);
            } else if (tabType === 'popular') {
                await loadPopularPosts(rankingContent);
            } else if (tabType === 'biho') {
                loadBihoRanking(rankingContent);
            } else if (tabType === 'stats') {
                loadStats(rankingContent);
            }
        }

        async function loadMeetingRanking(element) {
            // ÎßåÎÇ® Í≤åÏãúÎ¨ºÏóêÏÑú ÎßåÎÇ® ÌöüÏàòÎ•º Í∏∞Ï§ÄÏúºÎ°ú Îû≠ÌÇπ ÏßëÍ≥Ñ
            const usersMeetingCounts = {};
            const postsSnapshot = await db.collection('posts').where('type', '==', 'meeting').get();

            postsSnapshot.forEach(doc => {
                const post = doc.data();
                const userId = post.userId;
                usersMeetingCounts[userId] = (usersMeetingCounts[userId] || 0) + 1;
                
                // ÎßåÎÇú ÏπúÍµ¨Îì§Ïùò ÎßåÎÇ® ÌöüÏàòÎèÑ Ìï®Íªò ÏßëÍ≥Ñ (ÏÑ†ÌÉùÏÇ¨Ìï≠)
                if (post.metFriends && Array.isArray(post.metFriends)) {
                    post.metFriends.forEach(friend => {
                        usersMeetingCounts[friend.uid] = (usersMeetingCounts[friend.uid] || 0) + 1;
                    });
                }
            });

            // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ÏôÄ Ìï®Íªò Ï†ïÎ†¨
            const ranking = [];
            for (const userId in usersMeetingCounts) {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    ranking.push({
                        username: userData.username,
                        profilePicUrl: userData.profilePicUrl,
                        meetingCount: usersMeetingCounts[userId]
                    });
                }
            }

            ranking.sort((a, b) => b.meetingCount - a.meetingCount);

            element.innerHTML = '<ul class="ranking-list"></ul>';
            const ul = element.querySelector('.ranking-list');
            ranking.slice(0, 10).forEach((item, index) => { // ÏÉÅÏúÑ 10Î™ÖÎßå ÌëúÏãú
                const li = document.createElement('li');
                li.className = 'ranking-item';
                li.innerHTML = `
                    <span class="ranking-number">${index + 1}.</span>
                    <div class="profile-pic" style="background-image: url('${item.profilePicUrl || 'https://via.placeholder.com/150/EEEEEE/888888?text=;)'}');"></div>
                    <div class="info">
                        <div class="username">${item.username}</div>
                        <div class="details"><span>Ï¥ù ${item.meetingCount}Ìöå ÎßåÎÇ®</span></div>
                    </div>
                `;
                ul.appendChild(li);
            });

            if (ranking.length === 0) {
                element.innerHTML = '<p style="text-align: center; color: #8e8e8e; padding: 20px;">ÎßåÎÇ® Îû≠ÌÇπ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
            }
        }

        async function loadPopularPosts(element) {
            // Ï¢ãÏïÑÏöî ÏàòÍ∞Ä ÎßéÏùÄ Í≤åÏãúÎ¨º ÏàúÏúºÎ°ú Ï†ïÎ†¨
            const postsSnapshot = await db.collection('posts').orderBy('likes', 'desc').limit(10).get();
            element.innerHTML = '<div class="post-feed"></div>';
            const postFeedDiv = element.querySelector('.post-feed');

            if (postsSnapshot.empty) {
                element.innerHTML = '<p style="text-align: center; color: #8e8e8e; padding: 20px;">Ïù∏Í∏∞Í∏Ä Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }

            for (const doc of postsSnapshot.docs) {
                const post = { id: doc.id, ...doc.data() };
                postFeedDiv.appendChild(await createPostElement(post));
            }
        }

        function loadBihoRanking(element) {
            element.innerHTML = '<p style="text-align: center; color: #8e8e8e; padding: 20px;">ÏôïÎπÑÌò∏ Îû≠ÌÇπÏùÄ ÏïÑÏßÅ Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§. (Í∞ÄÏû• Ï†ÅÍ≤å ÎßåÎÇú ÏπúÍµ¨Îì§?)</p>';
            // Ïã§Ï†ú Íµ¨ÌòÑ Ïãú: ÎßåÎÇ® ÌöüÏàòÍ∞Ä Í∞ÄÏû• Ï†ÅÏùÄ ÏπúÍµ¨Îì§, ÎòêÎäî ÌôúÎèôÏù¥ Í∞ÄÏû• Ï†ÅÏùÄ ÏπúÍµ¨Îì§ Îì±ÏùÑ Í∏∞Ï§ÄÏúºÎ°ú Îû≠ÌÇπ ÏßëÍ≥Ñ
        }

        function loadStats(element) {
            element.innerHTML = '<p style="text-align: center; color: #8e8e8e; padding: 20px;">ÌÜµÍ≥ÑÎäî ÏïÑÏßÅ Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§. (Ï†ÑÏ≤¥ Í≤åÏãúÎ¨º Ïàò, Ï¢ãÏïÑÏöî Ïàò Îì±)</p>';
            // Ïã§Ï†ú Íµ¨ÌòÑ Ïãú: Ï†ÑÏ≤¥ ÏÇ¨Ïö©Ïûê Ïàò, Ï†ÑÏ≤¥ Í≤åÏãúÎ¨º Ïàò, Ï†ÑÏ≤¥ Ï¢ãÏïÑÏöî Ïàò, Í∞ÄÏû• ÎßéÏù¥ ÏÇ¨Ïö©Îêú ÌÉúÍ∑∏ Îì± ÌÜµÍ≥Ñ Ï†ïÎ≥¥ ÌëúÏãú
        }
        
        // ÎåìÍ∏Ä Í¥ÄÎ†® Ìï®Ïàò
        function openCommentsModal(postId) {
            currentOpenPostId = postId;
            document.getElementById('commentsModal').classList.add('active');
            loadComments(postId);
        }

        function closeCommentsModal() {
            document.getElementById('commentsModal').classList.remove('active');
            document.getElementById('commentsList').innerHTML = ''; // ÎåìÍ∏Ä Î™©Î°ù Ï¥àÍ∏∞Ìôî
            document.getElementById('commentInput').value = ''; // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
            currentOpenPostId = null;
        }

        async function loadComments(postId) {
            const commentsList = document.getElementById('commentsList');
            const commentsSpinner = document.getElementById('commentsLoadingSpinner');
            commentsList.innerHTML = '';
            commentsSpinner.style.display = 'flex'; // Ïä§ÌîºÎÑà ÌëúÏãú

            try {
                const commentsSnapshot = await db.collection('comments')
                                                .where('postId', '==', postId)
                                                .orderBy('timestamp', 'asc')
                                                .get();
                commentsSpinner.style.display = 'none'; // Ïä§ÌîºÎÑà Ïà®ÍπÄ

                if (commentsSnapshot.empty) {
                    commentsList.innerHTML = '<li style="text-align: center; color: #8e8e8e; padding: 20px;">ÏïÑÏßÅ ÎåìÍ∏ÄÏù¥ ÏóÜÏäµÎãàÎã§.</li>';
                } else {
                    for (const doc of commentsSnapshot.docs) {
                        const comment = doc.data();
                        const userDoc = await db.collection('users').doc(comment.userId).get();
                        const userData = userDoc.data();
                        const username = userData ? userData.username : 'Ïïå Ïàò ÏóÜÎäî ÏÇ¨Ïö©Ïûê';
                        const profilePicUrl = userData ? (userData.profilePicUrl || 'https://via.placeholder.com/150/EEEEEE/888888?text=;)') : 'https://via.placeholder.com/150/EEEEEE/888888?text=;)';

                        const li = document.createElement('li');
                        li.style.display = 'flex';
                        li.style.alignItems = 'flex-start';
                        li.style.marginBottom = '10px';
                        li.style.fontSize = '14px';
                        li.innerHTML = `
                            <div class="profile-pic" style="width: 28px; height: 28px; margin-right: 10px; flex-shrink: 0; background-image: url('${profilePicUrl}');"></div>
                            <div style="flex: 1;">
                                <span style="font-weight: bold; margin-right: 5px;">${username}</span>
                                <span>${comment.text}</span>
                                <div style="font-size: 12px; color: #8e8e8e; margin-top: 2px;">${formatTimeAgo(comment.timestamp ? comment.timestamp.toDate() : new Date())}</div>
                            </div>
                        `;
                        commentsList.appendChild(li);
                    }
                }
            } catch (error) {
                commentsSpinner.style.display = 'none';
                commentsList.innerHTML = '<li style="text-align: center; color: red; padding: 20px;">ÎåìÍ∏Ä Î°úÎìú Ï§ë Ïò§Î•ò Î∞úÏÉù: ' + error.message + '</li>';
                console.error("Error loading comments: ", error);
            }
        }

        async function addComment() {
            if (!currentUser || !currentOpenPostId) {
                alert('Î°úÍ∑∏Ïù∏ ÌõÑ ÎåìÍ∏ÄÏùÑ ÏûëÏÑ±Ìï† Ïàò ÏûàÏäµÎãàÎã§.');
                return;
            }

            const commentInput = document.getElementById('commentInput');
            const commentText = commentInput.value.trim();

            if (commentText === '') {
                alert('ÎåìÍ∏Ä ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.');
                return;
            }

            try {
                // ÎåìÍ∏Ä Ï∂îÍ∞Ä
                await db.collection('comments').add({
                    postId: currentOpenPostId,
                    userId: currentUser.uid,
                    text: commentText,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                // Í≤åÏãúÎ¨º ÎåìÍ∏Ä Ïàò ÏóÖÎç∞Ïù¥Ìä∏
                const postRef = db.collection('posts').doc(currentOpenPostId);
                await postRef.update({
                    commentsCount: firebase.firestore.FieldValue.increment(1)
                });

                commentInput.value = ''; // ÏûÖÎ†• ÌïÑÎìú Ï¥àÍ∏∞Ìôî
                loadComments(currentOpenPostId); // ÎåìÍ∏Ä Î™©Î°ù Îã§Ïãú Î°úÎìú
                loadPosts(); // Í≤åÏãúÎ¨º ÌîºÎìúÎèÑ ÏóÖÎç∞Ïù¥Ìä∏ÌïòÏó¨ ÎåìÍ∏Ä Ïàò Î∞òÏòÅ
            } catch (error) {
                alert('ÎåìÍ∏Ä ÏûëÏÑ± Ïã§Ìå®: ' + error.message);
                console.error("Error adding comment: ", error);
            }
        }

        // ÌäπÏ†ï ÎÇ†ÏßúÍπåÏßÄ ÎÇ®ÏùÄ ÏùºÏàò Í≥ÑÏÇ∞ Ìï®Ïàò (Îû≠ÌÇπ Î°úÏßÅÏóê ÏÇ¨Ïö©Îê† Ïàò ÏûàÏùå)
        function getDaysUntil(targetDateString) {
            const targetDate = new Date(targetDateString);
            const now = new Date();
            const diffTime = targetDate.getTime() - now.getTime();
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays > 0 ? diffDays : 0;
        }

        // Ï£ºÏñ¥ÏßÑ ÎÇ†Ïßú Î∞∞Ïó¥ÏóêÏÑú Í∞ÄÏû• Í∞ÄÍπåÏö¥ ÎØ∏Îûò ÎÇ†ÏßúÎ•º Ï∞æÎäî Ìï®Ïàò
        function findNearestFutureDate(dateStrings) {
            const now = new Date();
            return dateStrings
                .map(dateString => {
                    const targetDate = new Date(dateString);
                    const daysUntil = Math.ceil((targetDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
                    return { date: targetDate, daysUntil: daysUntil };
                })
                .filter(item => item.daysUntil >= 0) // Ïò§Îäò ÎòêÎäî ÎØ∏Îûò ÎÇ†ÏßúÎßå Ìè¨Ìï®
                .sort((a, b) => a.daysUntil - b.daysUntil)[0];
        }

        function formatTimeAgo(dateObj) {
            const date = new Date(dateObj); // Date Í∞ùÏ≤¥Î°ú Î≥ÄÌôò
            const now = new Date();
            const diffTime = now - date;
            const diffMinutes = Math.floor(diffTime / (1000 * 60));
            const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffMinutes < 1) {
                return 'Î∞©Í∏à Ï†Ñ';
            } else if (diffMinutes < 60) {
                return `${diffMinutes}Î∂Ñ Ï†Ñ`;
            } else if (diffHours < 24) {
                return `${diffHours}ÏãúÍ∞Ñ Ï†Ñ`;
            } else if (diffDays === 1) {
                return 'Ïñ¥Ï†ú';
            } else if (diffDays < 7) {
                return `${diffDays}Ïùº Ï†Ñ`;
            } else {
                return `${date.getMonth() + 1}Ïõî ${date.getDate()}Ïùº`;
            }
        }

        // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠Ïãú Îã´Í∏∞
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });

        // ÌÇ§Î≥¥Îìú ESCÎ°ú Î™®Îã¨ Îã´Í∏∞
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });

    </script>
</body>
</html>
