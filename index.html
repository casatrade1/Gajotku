<html lang="ko">
<head>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
<title>ê°€ì¡°ì¿  - ì¹œêµ¬ë“¤ë§Œì˜ SNS</title>

<!-- Firebase SDK -->
@@ -910,6 +911,22 @@
.bottom-nav {
padding-bottom: env(safe-area-inset-bottom);
}
            
            /* iOSì—ì„œ í„°ì¹˜ ìµœì í™” */
            * {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
            }
            
            input, textarea {
                -webkit-user-select: text;
            }
            
            /* iOSì—ì„œ ìŠ¤í¬ë¡¤ ìµœì í™” */
            .content, .stories-scroll, .modal-content {
                -webkit-overflow-scrolling: touch;
            }
}

/* ìˆ¨ê¹€ íŒŒì¼ ì…ë ¥ */
@@ -1141,11 +1158,27 @@
</div>
</div>

    <!-- ìŠ¤í† ë¦¬ ì—¬ëŸ¬ ê°œ ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <div id="multiStoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ìŠ¤í† ë¦¬ ì—…ë¡œë“œ</div>
                <button class="close-btn" onclick="closeMultiStoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="storyPreviewContainer" style="max-height: 60vh; overflow-y: auto;"></div>
                <div style="margin-top: 16px; text-align: center;">
                    <button id="uploadAllStoriesBtn" class="save-btn" onclick="uploadAllStories()" style="width: 100%;">ëª¨ë“  ìŠ¤í† ë¦¬ ì—…ë¡œë“œ</button>
                </div>
            </div>
        </div>
    </div>

<!-- ì‚¬ì§„ì²©ìš© ìˆ¨ê¹€ íŒŒì¼ ì…ë ¥ -->
<input type="file" id="galleryImageInput" class="hidden-file-input" accept="image/*" onchange="previewGalleryImage(this)">

    <!-- ìŠ¤í† ë¦¬ìš© ìˆ¨ê¹€ íŒŒì¼ ì…ë ¥ (ìŠ¤í† ë¦¬ëŠ” ê²Œì‹œê¸€ ì´ë¯¸ì§€ ì…ë ¥ê³¼ ë™ì¼í•œ ê²ƒ ì‚¬ìš©) -->
    <!-- ê¸°ì¡´ imageInputì„ ìŠ¤í† ë¦¬ì—ì„œë„ ê³µìš©ìœ¼ë¡œ ì‚¬ìš© -->
    <!-- ìŠ¤í† ë¦¬ìš© ìˆ¨ê¹€ íŒŒì¼ ì…ë ¥ (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥) -->
    <input type="file" id="storyImageInput" class="hidden-file-input" accept="image/*" multiple onchange="previewMultipleStoryImages(this)">

<script>
// Firebase ì„¤ì •
@@ -1164,6 +1197,16 @@
try {
firebase.initializeApp(firebaseConfig);
db = firebase.firestore();
            
            // iOS Safariì—ì„œ Firebase ì—°ê²° ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ì„¤ì •
            if (db) {
                db.enableNetwork();
                // iOSì—ì„œ ì˜¤í”„ë¼ì¸ ì§€ì› ë¹„í™œì„±í™” (ì—°ê²° ë¬¸ì œ ë°©ì§€)
                db.disableNetwork().then(() => {
                    return db.enableNetwork();
                });
            }
            
console.log('âœ… Firebase ì´ˆê¸°í™” ì„±ê³µ!');
} catch (error) {
console.error('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
@@ -1213,6 +1256,7 @@
let currentRankingTab = 'meeting';
let currentPostId = null;
let isCreatingPost = false; // ê²Œì‹œë¬¼ ì¤‘ë³µ ìƒì„± ë°©ì§€
        let selectedStoryImages = []; // ì„ íƒëœ ìŠ¤í† ë¦¬ ì´ë¯¸ì§€ë“¤

// ë¡œì»¬ ìºì‹œ
let posts = [];
@@ -1812,6 +1856,14 @@
const now = new Date();
const currentMonth = `${now.getFullYear()}-${now.getMonth()}`;

            // Firebaseì—ì„œ ìµœì‹  íˆ¬í‘œ ë°ì´í„° ë¨¼ì € ê°€ì ¸ì˜¤ê¸°
            try {
                await FirebaseManager.getBihoVotes();
            } catch (error) {
                console.log('íˆ¬í‘œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }
            
            // Firebaseì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ í™•ì¸í•œ í›„ ì´ˆê¸°í™” ì—¬ë¶€ ê²°ì •
if (!bihoVotes[currentMonth]) {
const initialVotes = {
votes: {},
@@ -1826,11 +1878,35 @@
}
}

        // iOS ì „ìš© ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // iOSì—ì„œ ê²Œì‹œ ë²„íŠ¼ í„°ì¹˜ ì´ë²¤íŠ¸ ì¶”ê°€
            const postBtn = document.querySelector('.post-btn');
            if (postBtn) {
                // í„°ì¹˜ ì´ë²¤íŠ¸ë„ í•¨ê»˜ ì²˜ë¦¬ (iOS Safari í˜¸í™˜ì„±)
                postBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    if (!isCreatingPost) {
                        createPost();
                    }
                });
            }
            
            // iOSì—ì„œ ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ ë¬¸ì œ í•´ê²°
            const textInputs = document.querySelectorAll('input, textarea');
            textInputs.forEach(input => {
                input.addEventListener('touchstart', function() {
                    this.focus();
                });
            });
        }

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
// ìƒˆë¡œê³ ì¹¨ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
checkLoginStatus();
renderFriendGrid();
            setupEventListeners();
});

function checkLoginStatus() {
@@ -1992,14 +2068,22 @@

async function initializeApp() {
try {
                await Promise.all([
                // iOSì—ì„œ Firebase ë¡œë”© ì‹œê°„ ì´ˆê³¼ ë°©ì§€ (10ì´ˆ timeout)
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('iOS Firebase timeout')), 10000)
                );
                
                const dataPromise = Promise.all([
FirebaseManager.getPosts(),
FirebaseManager.getComments(),
FirebaseManager.getBihoVotes(),
FirebaseManager.getProfiles(),
FirebaseManager.getGalleryPhotos(),
FirebaseManager.getStories()
]);
                
                // timeoutê³¼ ë°ì´í„° ë¡œë”© ì¤‘ ë¨¼ì € ì™„ë£Œë˜ëŠ” ê²ƒì„ ê¸°ë‹¤ë¦¼
                await Promise.race([dataPromise, timeoutPromise]);

setupRealtimeListeners();

@@ -2209,21 +2293,15 @@ <h3>ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤</h3>

let storiesHtml = '';

            // ë‚´ ìŠ¤í† ë¦¬ (í•­ìƒ ì²«ë²ˆì§¸) - ìŠ¤í† ë¦¬ê°€ ìˆì–´ë„ + ë²„íŠ¼ ìœ ì§€
            // ë‚´ ìŠ¤í† ë¦¬ (í•­ìƒ ì²«ë²ˆì§¸)
const myStories = storiesByUser[currentUser] || [];
            const userProfile = profiles[currentUser] || {};
            const myProfilePic = userProfile.profileImage ? 
                `style="background-image: url(${userProfile.profileImage}); background-size: cover; background-position: center;"` :
                ``;
            const myInitials = userProfile.profileImage ? '' : currentUser.substring(0, 2);
            
storiesHtml += `
                <div class="story-item" onclick="handleMyStoryClick()">
                <div class="story-item" onclick="viewUserStories('${currentUser}')">
                   <div class="story-ring ${myStories.length > 0 ? '' : 'viewed'}">
                        <div class="story-pic" ${myProfilePic}>${myInitials}</div>
                        <div class="story-badge" style="background: #405de6; color: white;">+</div>
                        <div class="story-pic">${currentUser.substring(0, 2)}</div>
                        ${myStories.length === 0 ? '<div class="story-badge" style="background: #405de6;">+</div>' : ''}
                   </div>
                    <div class="story-username">${myStories.length > 0 ? `ë‚´ ìŠ¤í† ë¦¬ (${myStories.length})` : 'ìŠ¤í† ë¦¬ ì¶”ê°€'}</div>
                    <div class="story-username">${myStories.length > 0 ? 'ë‚´ ìŠ¤í† ë¦¬' : 'ìŠ¤í† ë¦¬ ì¶”ê°€'}</div>
               </div>
           `;

@@ -2232,18 +2310,12 @@ <h3>ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤</h3>
.filter(user => user !== currentUser)
.forEach(user => {
const userStories = storiesByUser[user];
                    const otherUserProfile = profiles[user] || {};
                    const otherProfilePic = otherUserProfile.profileImage ? 
                        `style="background-image: url(${otherUserProfile.profileImage}); background-size: cover; background-position: center;"` :
                        ``;
                    const otherInitials = otherUserProfile.profileImage ? '' : user.substring(0, 2);
                    
storiesHtml += `
                       <div class="story-item" onclick="viewUserStories('${user}')">
                           <div class="story-ring">
                                <div class="story-pic" ${otherProfilePic}>${otherInitials}</div>
                                <div class="story-pic">${user.substring(0, 2)}</div>
                           </div>
                            <div class="story-username">${user} (${userStories.length})</div>
                            <div class="story-username">${user}</div>
                       </div>
                   `;
});
@@ -2255,44 +2327,16 @@ <h3>ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤</h3>
           `;
}

        // ë‚´ ìŠ¤í† ë¦¬ í´ë¦­ í•¸ë“¤ëŸ¬ (ìŠ¤í† ë¦¬ ì¶”ê°€ ë˜ëŠ” ë³´ê¸°)
        function handleMyStoryClick() {
            const myStories = stories.filter(story => story.author === currentUser);
            
            if (myStories.length === 0) {
                // ìŠ¤í† ë¦¬ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
                addStory();
            } else {
                // ìŠ¤í† ë¦¬ê°€ ìˆìœ¼ë©´ ì„ íƒ ë©”ë‰´ í‘œì‹œ
                showMyStoryMenu(myStories);
            }
        }

        // ë‚´ ìŠ¤í† ë¦¬ ë©”ë‰´ í‘œì‹œ
        function showMyStoryMenu(myStories) {
            const content = `
                <div style="text-align: center;">
                    <h3 style="margin-bottom: 20px; color: #405de6;">ë‚´ ìŠ¤í† ë¦¬ ê´€ë¦¬</h3>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        <button onclick="viewUserStories('${currentUser}'); closeLikesModal();" style="background: #405de6; color: white; border: none; border-radius: 8px; padding: 12px 24px; font-size: 14px; cursor: pointer;">
                            ğŸ“– ë‚´ ìŠ¤í† ë¦¬ ë³´ê¸° (${myStories.length}ê°œ)
                        </button>
                        <button onclick="addStory(); closeLikesModal();" style="background: #4caf50; color: white; border: none; border-radius: 8px; padding: 12px 24px; font-size: 14px; cursor: pointer;">
                            â• ìƒˆ ìŠ¤í† ë¦¬ ì¶”ê°€
                        </button>
                        <button onclick="closeLikesModal()" style="background: #f5f5f5; color: #262626; border: none; border-radius: 8px; padding: 12px 24px; font-size: 14px; cursor: pointer;">
                            ì·¨ì†Œ
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('likesModalBody').innerHTML = content;
            document.getElementById('likesModal').querySelector('.modal-title').textContent = 'ë‚´ ìŠ¤í† ë¦¬';
            document.getElementById('likesModal').classList.add('active');
        }

function viewUserStories(userName) {
            if (userName === currentUser) {
                const myStories = stories.filter(story => story.author === currentUser);
                if (myStories.length === 0) {
                    // ìŠ¤í† ë¦¬ ì¶”ê°€
                    addStory();
                    return;
                }
            }
            
const userStories = stories.filter(story => story.author === userName);
if (userStories.length === 0) return;

@@ -2305,121 +2349,44 @@ <h3 style="margin-bottom: 20px; color: #405de6;">ë‚´ ìŠ¤í† ë¦¬ ê´€ë¦¬</h3>
const story = userStories[currentIndex];
const timeAgo = formatTimeAgo(story.date);

            // ì§„í–‰ ë°” ìƒì„± (ì—¬ëŸ¬ ìŠ¤í† ë¦¬ê°€ ìˆì„ ë•Œ)
            let progressBar = '';
            if (userStories.length > 1) {
                progressBar = `
                    <div style="position: absolute; top: 8px; left: 16px; right: 16px; z-index: 15; display: flex; gap: 4px;">
                        ${userStories.map((_, index) => `
                            <div style="flex: 1; height: 2px; background: ${index === currentIndex ? 'white' : 'rgba(255,255,255,0.3)'}; border-radius: 1px;"></div>
                        `).join('')}
                    </div>
                `;
            }
            
const content = `
                <div style="position: relative; background: black; border-radius: 12px; overflow: hidden; max-height: 80vh;" onclick="handleStoryClick(event, ${JSON.stringify(userStories).replace(/"/g, '&quot;')}, ${currentIndex})">
                    ${progressBar}
                    
                    <div style="position: absolute; top: ${userStories.length > 1 ? '24px' : '16px'}; left: 16px; right: 16px; z-index: 10; display: flex; align-items: center; gap: 12px;">
                <div style="position: relative; background: black; border-radius: 12px; overflow: hidden; max-height: 80vh;">
                    <div style="position: absolute; top: 16px; left: 16px; right: 16px; z-index: 10; display: flex; align-items: center; gap: 12px;">
                       <div class="profile-pic" style="width: 32px; height: 32px; font-size: 12px;">${story.author.substring(0, 2)}</div>
                       <div>
                           <div style="color: white; font-weight: 600; font-size: 14px;">${story.author}</div>
                           <div style="color: rgba(255,255,255,0.8); font-size: 12px;">${timeAgo}</div>
                       </div>
                        <div style="margin-left: auto; color: rgba(255,255,255,0.8); font-size: 12px;">
                            ${currentIndex + 1}/${userStories.length}
                        </div>
                       ${story.author === currentUser ? `
                            <button onclick="event.stopPropagation(); deleteStoryConfirm('${story.id}')" style="background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer;">Ã—</button>
                            <button onclick="deleteStoryConfirm('${story.id}')" style="margin-left: auto; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer;">Ã—</button>
                       ` : ''}
                   </div>
                   
                    <!-- ì¢Œì¸¡ í´ë¦­ ì˜ì—­ (ì´ì „ ìŠ¤í† ë¦¬) -->
                    ${currentIndex > 0 ? `
                        <div style="position: absolute; left: 0; top: 0; width: 30%; height: 100%; z-index: 5; cursor: pointer;" onclick="event.stopPropagation(); showStoryViewer(${JSON.stringify(userStories).replace(/"/g, '&quot;')}, ${currentIndex - 1})"></div>
                    ` : ''}
                    
                    <!-- ìš°ì¸¡ í´ë¦­ ì˜ì—­ (ë‹¤ìŒ ìŠ¤í† ë¦¬) -->
                    ${currentIndex < userStories.length - 1 ? `
                        <div style="position: absolute; right: 0; top: 0; width: 30%; height: 100%; z-index: 5; cursor: pointer;" onclick="event.stopPropagation(); showStoryViewer(${JSON.stringify(userStories).replace(/"/g, '&quot;')}, ${currentIndex + 1})"></div>
                    ` : ''}
                    
                   ${story.image ? `
                       <img src="${story.image}" style="width: 100%; height: auto; max-height: 60vh; object-fit: contain;" alt="ìŠ¤í† ë¦¬ ì´ë¯¸ì§€">
                   ` : ''}
                   
                    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ë“¤ -->
                   ${userStories.length > 1 ? `
                        <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 12px; align-items: center;">
                        <div style="position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px;">
                           ${currentIndex > 0 ? `
                                <button onclick="event.stopPropagation(); showStoryViewer(${JSON.stringify(userStories).replace(/"/g, '&quot;')}, ${currentIndex - 1})" style="background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 50%; width: 44px; height: 44px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;">â€¹</button>
                                <button onclick="showStoryViewer(${JSON.stringify(userStories).replace(/"/g, '&quot;')}, ${currentIndex - 1})" style="background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer;">â€¹</button>
                           ` : ''}
                            <div style="color: white; font-size: 14px; padding: 8px 16px; background: rgba(0,0,0,0.3); border-radius: 20px;">
                                ${currentIndex + 1} / ${userStories.length}
                            </div>
                           ${currentIndex < userStories.length - 1 ? `
                                <button onclick="event.stopPropagation(); showStoryViewer(${JSON.stringify(userStories).replace(/"/g, '&quot;')}, ${currentIndex + 1})" style="background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 50%; width: 44px; height: 44px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center;">â€º</button>
                                <button onclick="showStoryViewer(${JSON.stringify(userStories).replace(/"/g, '&quot;')}, ${currentIndex + 1})" style="background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer;">â€º</button>
                           ` : ''}
                       </div>
                   ` : ''}
               </div>
           `;

document.getElementById('likesModalBody').innerHTML = content;
            document.getElementById('likesModal').querySelector('.modal-title').textContent = `${story.author}ë‹˜ì˜ ìŠ¤í† ë¦¬ ${currentIndex + 1}/${userStories.length}`;
            document.getElementById('likesModal').querySelector('.modal-title').textContent = `${story.author}ë‹˜ì˜ ìŠ¤í† ë¦¬`;
document.getElementById('likesModal').classList.add('active');
}

        // ìŠ¤í† ë¦¬ í´ë¦­ í•¸ë“¤ëŸ¬ (í‚¤ë³´ë“œ ì§€ì›)
        function handleStoryClick(event, userStories, currentIndex) {
            // í´ë¦­í•œ ìœ„ì¹˜ì— ë”°ë¼ ì´ì „/ë‹¤ìŒ ìŠ¤í† ë¦¬ë¡œ ì´ë™
            const rect = event.currentTarget.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const width = rect.width;
            
            if (clickX < width * 0.3 && currentIndex > 0) {
                // ì¢Œì¸¡ 30% í´ë¦­ ì‹œ ì´ì „ ìŠ¤í† ë¦¬
                showStoryViewer(userStories, currentIndex - 1);
            } else if (clickX > width * 0.7 && currentIndex < userStories.length - 1) {
                // ìš°ì¸¡ 30% í´ë¦­ ì‹œ ë‹¤ìŒ ìŠ¤í† ë¦¬
                showStoryViewer(userStories, currentIndex + 1);
            }
        }

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.addEventListener('keydown', function(event) {
            const storyModal = document.getElementById('likesModal');
            if (!storyModal.classList.contains('active')) return;
            
            // í˜„ì¬ ìŠ¤í† ë¦¬ ì •ë³´ ì¶”ì¶œ (ëª¨ë‹¬ ì œëª©ì—ì„œ)
            const modalTitle = storyModal.querySelector('.modal-title').textContent;
            if (!modalTitle.includes('ìŠ¤í† ë¦¬')) return;
            
            // ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ ìŠ¤í† ë¦¬ ì •ë³´ ì €ì¥ í•„ìš”
            if (event.key === 'ArrowLeft' || event.key === 'ArrowRight') {
                event.preventDefault();
                // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜ì€ ë³µì¡í•˜ë¯€ë¡œ ë²„íŠ¼ í´ë¦­ìœ¼ë¡œ ëŒ€ì²´
                const buttons = storyModal.querySelectorAll('button');
                if (event.key === 'ArrowLeft') {
                    const prevBtn = Array.from(buttons).find(btn => btn.textContent === 'â€¹');
                    if (prevBtn) prevBtn.click();
                } else {
                    const nextBtn = Array.from(buttons).find(btn => btn.textContent === 'â€º');
                    if (nextBtn) nextBtn.click();
                }
            }
        });

function addStory() {
            // ë³„ë„ì˜ íŒŒì¼ ì…ë ¥ ìƒì„±í•´ì„œ ì‚¬ìš©
            const storyInput = document.createElement('input');
            storyInput.type = 'file';
            storyInput.accept = 'image/*';
            storyInput.onchange = function(e) {
                previewStoryImage(e.target);
            };
            storyInput.click();
            // ì—¬ëŸ¬ ì‚¬ì§„ ì„ íƒì´ ê°€ëŠ¥í•œ ìŠ¤í† ë¦¬ ì…ë ¥ìœ¼ë¡œ ì´ë™
            document.getElementById('storyImageInput').click();
}

function previewStoryImage(input) {
@@ -2430,12 +2397,6 @@ <h3 style="margin-bottom: 20px; color: #405de6;">ë‚´ ìŠ¤í† ë¦¬ ê´€ë¦¬</h3>
reader.onload = async function(e) {
const imageData = e.target.result;

                // ìŠ¤í† ë¦¬ ì—…ë¡œë“œ í™•ì¸
                if (!confirm('ì´ ì‚¬ì§„ì„ ìŠ¤í† ë¦¬ì— ì˜¬ë¦¬ì‹œê² ìŠµë‹ˆê¹Œ?\n24ì‹œê°„ í›„ ìë™ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.')) {
                    input.value = '';
                    return;
                }
                
// ë¡œë”© í‘œì‹œ (ìŠ¤í† ë¦¬ ì»¨í…Œì´ë„ˆì—)
const storiesContainer = document.getElementById('storiesContainer');
const originalContent = storiesContainer.innerHTML;
@@ -2492,14 +2453,8 @@ <h3 style="margin-bottom: 20px; color: #405de6;">ë‚´ ìŠ¤í† ë¦¬ ê´€ë¦¬</h3>
input.value = '';
}

        async function deleteStoryConfirm(storyId) {
            if (confirm('ìŠ¤í† ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await FirebaseManager.deleteStory(storyId);
                renderStories();
                closeLikesModal();
                console.log('âœ… ìŠ¤í† ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }
        // ì—¬ëŸ¬ ìŠ¤í† ë¦¬ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜
        function previewMultipleStoryImages(input) {
const files = Array.from(input.files);
if (!files.length) return;

@@ -2613,7 +2568,11 @@ <h3 style="margin-bottom: 20px; color: #405de6;">ë‚´ ìŠ¤í† ë¦¬ ê´€ë¦¬</h3>
}, 1500);
}


        // ë‹¤ì¤‘ ìŠ¤í† ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
        function closeMultiStoryModal() {
            document.getElementById('multiStoryModal').classList.remove('active');
            selectedStoryImages = [];
        }

async function deleteStoryConfirm(storyId) {
if (confirm('ìŠ¤í† ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
@@ -2718,15 +2677,54 @@ <h3 style="margin-bottom: 20px; color: #405de6;">ë‚´ ìŠ¤í† ë¦¬ ê´€ë¦¬</h3>
const file = input.files[0];
if (!file) return;

            // iOS Safarië¥¼ ìœ„í•œ ì´ë¯¸ì§€ ì••ì¶• ì²˜ë¦¬
const reader = new FileReader();
reader.onload = function(e) {
                currentImageData = e.target.result;
                document.getElementById('imagePreview').innerHTML = `
                    <div class="image-preview">
                        <img src="${currentImageData}" class="preview-img" alt="ë¯¸ë¦¬ë³´ê¸°">
                        <button class="remove-img" onclick="removeImage()">&times;</button>
                    </div>
                `;
                const img = new Image();
                img.onload = function() {
                    // ìº”ë²„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ í¬ê¸° ì••ì¶•
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ìµœëŒ€ í¬ê¸° ì„¤ì • (iOS Safari í˜¸í™˜ì„±ì„ ìœ„í•´)
                    const maxWidth = 800;
                    const maxHeight = 600;
                    
                    let { width, height } = img;
                    
                    // ë¹„ìœ¨ ìœ ì§€í•˜ë©´ì„œ í¬ê¸° ì¡°ì •
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // ì••ì¶•ëœ ì´ë¯¸ì§€ ë°ì´í„° ìƒì„± (í’ˆì§ˆ 0.8)
                    currentImageData = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                    document.getElementById('imagePreview').innerHTML = `
                        <div class="image-preview">
                            <img src="${currentImageData}" class="preview-img" alt="ë¯¸ë¦¬ë³´ê¸°">
                            <button class="remove-img" onclick="removeImage()">&times;</button>
                        </div>
                    `;
                    
                    console.log('ì´ë¯¸ì§€ ì••ì¶• ì™„ë£Œ:', currentImageData.length, 'ë°”ì´íŠ¸');
                };
                img.src = e.target.result;
};
reader.readAsDataURL(file);
}
@@ -2815,43 +2813,59 @@ <h3 style="margin-bottom: 20px; color: #405de6;">ë‚´ ìŠ¤í† ë¦¬ ê´€ë¦¬</h3>

console.log('ìƒì„±ëœ ê²Œì‹œë¬¼:', post);

            // iOS Safariì—ì„œëŠ” Firebase ëŒ€ì‹  ì¦‰ì‹œ ë¡œì»¬ ì €ì¥
try {
                // Firebaseì— ì €ì¥ ë¨¼ì € ì‹œë„
                await FirebaseManager.addPost(post);
                console.log('âœ… Firebase ì €ì¥ ì™„ë£Œ');
                // ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš° í¬ê¸° ì²´í¬
                if (currentImageData && currentImageData.length > 1000000) { // 1MB ì´ìƒ
                    console.log('ì´ë¯¸ì§€ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ì¶”ê°€ ì••ì¶• ì¤‘...');
                    // ì¶”ê°€ ì••ì¶•
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // ë” ì‘ì€ í¬ê¸°ë¡œ ì••ì¶•
                        const maxWidth = 600;
                        const maxHeight = 400;
                        
                        let { width, height } = img;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // ë” ë‚®ì€ í’ˆì§ˆë¡œ ì••ì¶•
                        post.image = canvas.toDataURL('image/jpeg', 0.6);
                        
                        // ì••ì¶•ëœ ì´ë¯¸ì§€ë¡œ ê²Œì‹œë¬¼ ì €ì¥
                        savePostToLocal(post, postBtn, originalBtnText);
                    };
                    img.src = currentImageData;
                } else {
                    // ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ í¬ê¸°ê°€ ì ë‹¹í•œ ê²½ìš° ë°”ë¡œ ì €ì¥
                    savePostToLocal(post, postBtn, originalBtnText);
                }

                // ì„±ê³µ ì‹œ ì¦‰ì‹œ ë¡œì»¬ì— ì¶”ê°€í•˜ê³  UI ì—…ë°ì´íŠ¸
                posts.unshift(post);
                renderPostFeed();
            } catch (error) {
                console.error('ê²Œì‹œë¬¼ ì €ì¥ ì‹¤íŒ¨:', error);

                // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                postBtn.textContent = 'ì—…ë¡œë“œ ì™„ë£Œ!';
                // ì‹¤íŒ¨ì‹œì—ë„ ê¸°ë³¸ ì²˜ë¦¬
                postBtn.textContent = 'ì—…ë¡œë“œ ì™„ë£Œ';
postBtn.style.background = '#4caf50';

                // í¼ ì™„ì „ ì´ˆê¸°í™”
setTimeout(() => {
                    document.getElementById('postContent').value = '';
                    document.querySelectorAll('#friendCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
                    updateSelectedFriends();
                    
                    // ë‚ ì§œ ì´ˆê¸°í™”
                    if (selectedPostType === 'meeting') {
                        const today = new Date().toISOString().split('T')[0];
                        document.getElementById('meetingDate').value = today;
                    }
                    
                    // ì´ë¯¸ì§€ ì™„ì „ ì œê±°
                    currentImageData = null;
                    document.getElementById('imagePreview').innerHTML = '';
                    document.getElementById('imageInput').value = '';
                    
                    // í¬ìŠ¤íŠ¸ íƒ€ì… ì´ˆê¸°í™”
                    selectedPostType = 'diary';
                    document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelector('[data-type="diary"]').classList.add('active');
                    document.getElementById('meetingSelector').classList.remove('active');
                    document.getElementById('postContent').placeholder = 'ì˜¤ëŠ˜ ì–´ë–¤ í•˜ë£¨ë¥¼ ë³´ë‚´ì…¨ë‚˜ìš”?';
                    
// ë²„íŠ¼ ìƒíƒœ ë³µì›
postBtn.textContent = originalBtnText;
postBtn.disabled = false;
@@ -2860,90 +2874,70 @@ <h3 style="margin-bottom: 20px; color: #405de6;">ë‚´ ìŠ¤í† ë¦¬ ê´€ë¦¬</h3>
// ì¤‘ë³µ ìƒì„± ë°©ì§€ í”Œë˜ê·¸ í•´ì œ
isCreatingPost = false;

                    console.log('âœ… í¼ ì´ˆê¸°í™” ì™„ë£Œ');
                    
                    // ê²Œì‹œê¸€ ì‘ì„± í›„ í™ˆ íƒ­ìœ¼ë¡œ ì´ë™
switchTab('home');
}, 1000);
            }
        }
        
        // ê²Œì‹œë¬¼ ë¡œì»¬ ì €ì¥ í•¨ìˆ˜ ë¶„ë¦¬
        function savePostToLocal(post, postBtn, originalBtnText) {
            // ì¦‰ì‹œ ë¡œì»¬ì— ì¶”ê°€
            posts.unshift(post);
            renderPostFeed();
            
            // iOS Safariì—ì„œ Firebase ì €ì¥ì€ ë°±ê·¸ë¼ìš´ë“œë¡œ ì²˜ë¦¬
            if (db) {
                setTimeout(() => {
                    FirebaseManager.addPost(post).catch(err => {
                        console.log('Firebase ì €ì¥ ì‹¤íŒ¨í•˜ì§€ë§Œ ë¡œì»¬ì—ëŠ” ì €ì¥ë¨:', err);
                    });
                }, 100);
            } else {
                // Firebase ì—†ìœ¼ë©´ localStorageì— ì €ì¥
                localStorage.setItem('posts', JSON.stringify(posts));
            }
            
            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            postBtn.textContent = 'ì—…ë¡œë“œ ì™„ë£Œ!';
            postBtn.style.background = '#4caf50';
            
            // í¼ ì™„ì „ ì´ˆê¸°í™”
            setTimeout(() => {
                document.getElementById('postContent').value = '';
                document.querySelectorAll('#friendCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
                updateSelectedFriends();

            } catch (error) {
                console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', error);
                // ë‚ ì§œ ì´ˆê¸°í™”
                if (selectedPostType === 'meeting') {
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('meetingDate').value = today;
                }

                // ì‹¤íŒ¨ì‹œ ì¬ì‹œë„ ì˜µì…˜ ì œê³µ
                postBtn.textContent = 'ì—…ë¡œë“œ ì‹¤íŒ¨';
                postBtn.style.background = '#ed4956';
                // ì´ë¯¸ì§€ ì™„ì „ ì œê±°
                currentImageData = null;
                document.getElementById('imagePreview').innerHTML = '';
                document.getElementById('imageInput').value = '';

                const retry = confirm('ê²Œì‹œë¬¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\në‹¤ì‹œ ì‹œë„í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                // í¬ìŠ¤íŠ¸ íƒ€ì… ì´ˆê¸°í™”
                selectedPostType = 'diary';
                document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('[data-type="diary"]').classList.add('active');
                document.getElementById('meetingSelector').classList.remove('active');
                document.getElementById('postContent').placeholder = 'ì˜¤ëŠ˜ ì–´ë–¤ í•˜ë£¨ë¥¼ ë³´ë‚´ì…¨ë‚˜ìš”?';

                if (retry) {
                    // ì¬ì‹œë„
                    postBtn.textContent = 'ì¬ì‹œë„ ì¤‘...';
                    postBtn.style.background = '#c7c7c7';
                    
                    try {
                        await FirebaseManager.addPost(post);
                        console.log('âœ… ì¬ì‹œë„ ì„±ê³µ');
                        
                        // ì„±ê³µ ì‹œ ë¡œì»¬ì— ì¶”ê°€
                        posts.unshift(post);
                        renderPostFeed();
                        
                        postBtn.textContent = 'ì—…ë¡œë“œ ì™„ë£Œ!';
                        postBtn.style.background = '#4caf50';
                        
                        setTimeout(() => {
                            // í¼ ì´ˆê¸°í™” (ìœ„ì™€ ë™ì¼)
                            document.getElementById('postContent').value = '';
                            document.querySelectorAll('#friendCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
                            updateSelectedFriends();
                            
                            if (selectedPostType === 'meeting') {
                                const today = new Date().toISOString().split('T')[0];
                                document.getElementById('meetingDate').value = today;
                            }
                            
                            currentImageData = null;
                            document.getElementById('imagePreview').innerHTML = '';
                            document.getElementById('imageInput').value = '';
                            
                            selectedPostType = 'diary';
                            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
                            document.querySelector('[data-type="diary"]').classList.add('active');
                            document.getElementById('meetingSelector').classList.remove('active');
                            document.getElementById('postContent').placeholder = 'ì˜¤ëŠ˜ ì–´ë–¤ í•˜ë£¨ë¥¼ ë³´ë‚´ì…¨ë‚˜ìš”?';
                            
                            postBtn.textContent = originalBtnText;
                            postBtn.disabled = false;
                            postBtn.style.background = '#405de6';
                            
                            // ì¤‘ë³µ ìƒì„± ë°©ì§€ í”Œë˜ê·¸ í•´ì œ
                            isCreatingPost = false;
                            
                            switchTab('home');
                        }, 1000);
                        
                    } catch (retryError) {
                        console.error('ì¬ì‹œë„ë„ ì‹¤íŒ¨:', retryError);
                        alert('ì¬ì‹œë„ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                        
                        // ë²„íŠ¼ ìƒíƒœ ë³µì›
                        postBtn.textContent = originalBtnText;
                        postBtn.disabled = false;
                        postBtn.style.background = '#405de6';
                        
                        // ì¤‘ë³µ ìƒì„± ë°©ì§€ í”Œë˜ê·¸ í•´ì œ
                        isCreatingPost = false;
                    }
                } else {
                    // ì¬ì‹œë„ ê±°ë¶€ì‹œ ë²„íŠ¼ ìƒíƒœë§Œ ë³µì›
                    postBtn.textContent = originalBtnText;
                    postBtn.disabled = false;
                    postBtn.style.background = '#405de6';
                    
                    // ì¤‘ë³µ ìƒì„± ë°©ì§€ í”Œë˜ê·¸ í•´ì œ
                    isCreatingPost = false;
                }
            }
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                postBtn.textContent = originalBtnText;
                postBtn.disabled = false;
                postBtn.style.background = '#405de6';
                
                // ì¤‘ë³µ ìƒì„± ë°©ì§€ í”Œë˜ê·¸ í•´ì œ
                isCreatingPost = false;
                
                console.log('âœ… í¼ ì´ˆê¸°í™” ì™„ë£Œ');
                
                // ê²Œì‹œê¸€ ì‘ì„± í›„ í™ˆ íƒ­ìœ¼ë¡œ ì´ë™
                switchTab('home');
            }, 1000);
}

function renderPostFeed() {
@@ -3185,6 +3179,11 @@ <h4>${post.author}</h4>
const now = new Date();
const currentMonth = `${now.getFullYear()}-${now.getMonth()}`;

                // Firebaseì—ì„œ ìµœì‹  íˆ¬í‘œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë¹„ë™ê¸°)
                FirebaseManager.getBihoVotes().catch(err => {
                    console.log('íˆ¬í‘œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨, ë¡œì»¬ ë°ì´í„° ì‚¬ìš©');
                });
                
if (!bihoVotes[currentMonth]) {
initializeBihoVotes();
}
@@ -3590,11 +3589,20 @@ <h4>${post.author}</h4>
}

// ì™•ë¹„í˜¸ íˆ¬í‘œ í•¨ìˆ˜ë“¤
        function openBihoVoteModal() {
        async function openBihoVoteModal() {
const now = new Date();
const currentMonth = `${now.getFullYear()}-${now.getMonth()}`;
            
            // Firebaseì—ì„œ ìµœì‹  íˆ¬í‘œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            try {
                await FirebaseManager.getBihoVotes();
            } catch (error) {
                console.log('íˆ¬í‘œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨, ë¡œì»¬ ë°ì´í„° ì‚¬ìš©');
            }
            
const currentVotes = bihoVotes[currentMonth] || { votes: {}, voters: {} };

            // í˜„ì¬ ì‚¬ìš©ìì˜ íˆ¬í‘œ ì—¬ë¶€ í™•ì¸
if (currentVotes.voters && currentVotes.voters[currentUser]) {
alert('ì´ë²ˆë‹¬ì— ì´ë¯¸ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤! ë‹¤ìŒë‹¬ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” ğŸ˜Š');
return;
