<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>ê°€ì¡°ì¿  - ì¹œêµ¬ë“¤ë§Œì˜ SNS</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #fafafa;
            color: #262626;
        }

        /* ë¡œê·¸ì¸ í™”ë©´ */
        .login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding: 20px;
            overflow-y: auto;
        }

        .login-box {
            background: white;
            border: 1px solid #dbdbdb;
            border-radius: 12px;
            padding: 30px 20px;
            max-width: 350px;
            width: 100%;
            text-align: center;
            margin-top: 10px;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
            background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584, #e1306c, #fd1d1d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .friend-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .friend-card {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 12px;
            padding: 12px 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .friend-card:hover {
            border-color: #405de6;
            background: #f0f2ff;
        }

        .friend-card.selected {
            border-color: #405de6;
            background: #405de6;
            color: white;
        }

        .friend-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .friend-birthday {
            font-size: 12px;
            opacity: 0.7;
        }

        .login-btn {
            background: #405de6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 30px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
        }

        .login-btn:hover {
            background: #3449d1;
        }

        .login-btn:disabled {
            background: #c7c7c7;
            cursor: not-allowed;
        }

        /* ë©”ì¸ ì•± í™”ë©´ */
        .main-app {
            display: none;
            max-width: 480px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        /* ìƒì¼ ì•Œë¦¼ ë  */
        .birthday-banner {
            background: #262626;
            color: white;
            padding: 8px 16px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
        }

        /* í—¤ë” */
        .header {
            background: white;
            border-bottom: 1px solid #dbdbdb;
            padding: 10px 16px;
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-title {
            font-size: 24px;
            font-weight: bold;
            font-family: 'Billabong', cursive;
        }

        .header-icons {
            display: flex;
            gap: 16px;
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
        }

        /* ìŠ¤í† ë¦¬ ì˜ì—­ */
        .stories-container {
            background: white;
            padding: 16px;
            border-bottom: 1px solid #dbdbdb;
            overflow-x: auto;
        }

        .stories-scroll {
            display: flex;
            gap: 16px;
            padding-bottom: 8px;
        }

        .story-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 60px;
            cursor: pointer;
        }

        .story-ring {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 4px;
            position: relative;
        }

        .story-ring.viewed {
            background: #c7c7c7;
        }

        .story-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            color: #405de6;
        }

        .story-username {
            font-size: 10px;
            text-align: center;
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .story-badge {
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
        }

        .story-badge.meeting {
            background: #e91e63;
            color: white;
        }

        .story-badge.diary {
            background: #4caf50;
            color: white;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë°” */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 480px;
            background: white;
            border-top: 1px solid #dbdbdb;
            display: flex;
            padding: 8px 0;
            z-index: 100;
        }

        .nav-item {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            font-size: 24px;
            color: #262626;
            transition: all 0.2s;
        }

        .nav-item.active {
            color: #405de6;
        }

        /* ì»¨í…ì¸  ì˜ì—­ */
        .content {
            padding-bottom: 60px;
            min-height: calc(100vh - 100px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* í¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .post {
            background: white;
            border: 1px solid #dbdbdb;
            margin-bottom: 16px;
        }

        .post-header {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .post-user {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .profile-pic {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .user-info h4 {
            font-size: 14px;
            font-weight: 600;
            margin: 0;
        }

        .post-time {
            font-size: 11px;
            color: #8e8e8e;
        }

        .post-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            display: block;
        }

        .post-actions {
            padding: 8px 16px;
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .action-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            padding: 4px;
            color: #262626;
            transition: all 0.2s;
        }

        .action-btn.liked {
            color: #ed4956;
        }

        .post-likes {
            padding: 0 16px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            cursor: pointer;
        }

        .post-content {
            padding: 0 16px 12px;
            font-size: 14px;
            line-height: 1.4;
        }

        .post-content .username {
            font-weight: 600;
            margin-right: 8px;
        }

        /* í¬ìŠ¤íŠ¸ ì‘ì„± */
        .create-post {
            background: white;
            border: 1px solid #dbdbdb;
            margin: 16px;
            border-radius: 12px;
            padding: 16px;
        }

        .create-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .create-input {
            width: 100%;
            border: none;
            font-size: 14px;
            resize: none;
            outline: none;
            min-height: 60px;
            margin-bottom: 12px;
        }

        .create-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .attach-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #8e8e8e;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .post-btn {
            background: #405de6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .post-btn:disabled {
            background: #c7c7c7;
            cursor: not-allowed;
        }

        /* ì´ë¯¸ì§€ í”„ë¦¬ë·° */
        .image-preview {
            position: relative;
            margin: 12px 0;
        }

        .preview-img {
            width: 100%;
            max-height: 300px;
            object-fit: cover;
            border-radius: 8px;
        }

        .remove-img {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
        }

        /* í¬ìŠ¤íŠ¸ íƒ€ì… ì„ íƒ */
        .post-type {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .type-btn {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #dbdbdb;
            background: white;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .type-btn.active {
            background: #405de6;
            color: white;
            border-color: #405de6;
        }

        .meeting-selector {
            display: none;
            margin-bottom: 12px;
        }

        .meeting-selector.active {
            display: block;
        }

        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #dbdbdb;
            border-radius: 8px;
            font-size: 14px;
        }

        /* ê²€ìƒ‰ í˜ì´ì§€ */
        .search-container {
            padding: 16px;
        }

        .search-tabs {
            display: flex;
            margin-bottom: 16px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 4px;
        }

        .search-tab {
            flex: 1;
            padding: 8px 12px;
            text-align: center;
            background: none;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .search-tab.active {
            background: white;
            font-weight: 600;
        }

        /* ë­í‚¹ */
        .ranking-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .ranking-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 16px;
            text-align: center;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .ranking-item:last-child {
            border-bottom: none;
        }

        .rank-position {
            font-weight: bold;
            font-size: 18px;
            width: 30px;
        }

        /* í”„ë¡œí•„ í˜ì´ì§€ */
        .profile-header {
            padding: 20px 16px;
            background: white;
            border-bottom: 1px solid #dbdbdb;
        }

        .profile-top {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 16px;
        }

        .profile-pic-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(45deg, #405de6, #5851db, #833ab4, #c13584);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 24px;
            flex-shrink: 0;
        }

        .profile-info {
            flex: 1;
        }

        .profile-name {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .profile-bio {
            font-size: 14px;
            color: #8e8e8e;
            line-height: 1.4;
            margin-bottom: 12px;
        }

        .edit-profile-btn {
            background: none;
            border: 1px solid #dbdbdb;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .profile-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 16px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 18px;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 12px;
            color: #8e8e8e;
        }

        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid #dbdbdb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 16px;
            font-weight: bold;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
        }

        .modal-body {
            padding: 16px;
        }

        .edit-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 600;
            font-size: 14px;
        }

        .form-input {
            padding: 12px;
            border: 1px solid #dbdbdb;
            border-radius: 8px;
            font-size: 14px;
        }

        .form-textarea {
            padding: 12px;
            border: 1px solid #dbdbdb;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 80px;
        }

        .save-btn {
            background: #405de6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ëŒ“ê¸€ ìŠ¤íƒ€ì¼ */
        .comment-item {
            display: flex;
            gap: 12px;
            padding: 8px 0;
        }

        .comment-content {
            flex: 1;
        }

        .comment-author {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 2px;
        }

        .comment-text {
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 4px;
        }

        .comment-time {
            font-size: 12px;
            color: #8e8e8e;
        }

        .comment-delete {
            color: #ed4956;
            background: none;
            border: none;
            font-size: 12px;
            cursor: pointer;
            padding: 2px 4px;
        }

        /* ì™•ë¹„í˜¸ íˆ¬í‘œ ìŠ¤íƒ€ì¼ */
        .biho-vote-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid #dbdbdb;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .biho-vote-item:hover {
            background: #f8f9fa;
        }

        .biho-vote-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .vote-btn {
            background: #e91e63;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .vote-btn:hover {
            background: #d63447;
        }

        .vote-btn:disabled {
            background: #c7c7c7;
            cursor: not-allowed;
        }

        .biho-crown {
            font-size: 18px;
            margin-right: 8px;
        }

        /* ì‚­ì œ ë²„íŠ¼ */
        .delete-btn {
            color: #ed4956;
            background: none;
            border: none;
            font-size: 12px;
            cursor: pointer;
            padding: 4px;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 480px) {
            .friend-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .login-box {
                padding: 20px 15px;
                margin: 10px;
            }
            
            .logo {
                font-size: 24px;
                margin-bottom: 15px;
            }
            
            .friend-card {
                padding: 10px 6px;
                min-height: 50px;
                font-size: 13px;
            }
            
            .profile-top {
                gap: 16px;
            }
            
            .profile-pic-large {
                width: 70px;
                height: 70px;
                font-size: 20px;
            }

            /* ì…ë ¥ í•„ë“œ í™•ëŒ€ ë°©ì§€ */
            input, textarea, select {
                font-size: 16px !important;
                transform-origin: left top;
                transform: scale(1);
            }

            /* í„°ì¹˜ ì˜ì—­ ìµœì í™” */
            .action-btn {
                min-width: 44px;
                min-height: 44px;
            }

            .nav-item {
                min-height: 44px;
            }
        }

        /* iOS Safari ìµœì í™” */
        @supports (-webkit-touch-callout: none) {
            .main-app {
                min-height: -webkit-fill-available;
            }
            
            .content {
                padding-bottom: calc(60px + env(safe-area-inset-bottom));
            }
            
            .bottom-nav {
                padding-bottom: env(safe-area-inset-bottom);
            }
            
            /* iOSì—ì„œ í„°ì¹˜ ìµœì í™” */
            * {
                -webkit-tap-highlight-color: transparent;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
            }
            
            input, textarea {
                -webkit-user-select: text;
            }
            
            /* iOSì—ì„œ ìŠ¤í¬ë¡¤ ìµœì í™” */
            .content, .stories-scroll, .modal-content {
                -webkit-overflow-scrolling: touch;
            }
        }

        /* ìˆ¨ê¹€ íŒŒì¼ ì…ë ¥ */
        .hidden-file-input {
            display: none;
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-box">
            <div class="logo">ê°€ì¡°ì¿ </div>
            <p style="margin-bottom: 30px; color: #8e8e8e;">ì¹œêµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</p>
            
            <div class="friend-grid" id="friendGrid">
                <!-- ì¹œêµ¬ ëª©ë¡ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
            
            <button class="login-btn" id="loginBtn" onclick="login()" disabled>ì…ì¥í•˜ê¸°</button>
        </div>
    </div>

    <!-- ë©”ì¸ ì•± í™”ë©´ -->
    <div id="mainApp" class="main-app">
        <!-- ìƒì¼ ì•Œë¦¼ ë  -->
        <div class="birthday-banner" id="birthdayBanner">
            <span id="birthdayMessage">ğŸ—“ï¸ ë‹¤ìŒ ìƒì¼ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</span>
        </div>

        <!-- í—¤ë” -->
        <div class="header">
            <div class="header-title">ê°€ì¡°ì¿ </div>
            <div class="header-icons">
                <button class="icon-btn" onclick="showProfile()">ğŸ‘¤</button>
                <button class="icon-btn" onclick="logout()" title="ë¡œê·¸ì•„ì›ƒ">ğŸšª</button>
            </div>
        </div>

        <!-- ì»¨í…ì¸  ì˜ì—­ -->
        <div class="content">
            <!-- í™ˆ í”¼ë“œ -->
            <div id="home" class="tab-content active">
                <!-- ìŠ¤í† ë¦¬ ì˜ì—­ -->
                <div class="stories-container">
                    <div class="stories-scroll" id="storiesContainer">
                        <!-- ìŠ¤í† ë¦¬ê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                    </div>
                </div>

                <!-- í¬ìŠ¤íŠ¸ í”¼ë“œ -->
                <div id="postFeed"></div>
            </div>

            <!-- ê²€ìƒ‰/ë­í‚¹ íƒ­ -->
            <div id="search" class="tab-content">
                <div class="search-container">
                    <div class="search-tabs">
                        <button class="search-tab active" onclick="showRankingTab('meeting')">ë§Œë‚¨í‚¹</button>
                        <button class="search-tab" onclick="showRankingTab('popular')">ì¸ê¸°ê¸€</button>
                        <button class="search-tab" onclick="showRankingTab('biho')">ì™•ë¹„í˜¸</button>
                        <button class="search-tab" onclick="showRankingTab('stats')">í†µê³„</button>
                    </div>
                    <div id="rankingContent"></div>
                </div>
            </div>

            <!-- ê²Œì‹œê¸€ ì‘ì„± íƒ­ -->
            <div id="create" class="tab-content">
                <!-- í¬ìŠ¤íŠ¸ ì‘ì„± -->
                <div class="create-post">
                    <div class="create-header">
                        <div class="profile-pic" id="createProfilePic"></div>
                        <div style="flex: 1;">
                            <div class="post-type">
                                <button class="type-btn active" data-type="diary" onclick="selectPostType('diary')">ğŸ“ ì¼ê¸°</button>
                                <button class="type-btn" data-type="meeting" onclick="selectPostType('meeting')">ğŸ‘¥ ë§Œë‚¨</button>
                            </div>
                        </div>
                    </div>
                    
                    <textarea class="create-input" id="postContent" placeholder="ì˜¤ëŠ˜ ì–´ë–¤ í•˜ë£¨ë¥¼ ë³´ë‚´ì…¨ë‚˜ìš”?"></textarea>
                    
                    <div class="meeting-selector" id="meetingSelector">
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 12px; color: #8e8e8e;">ë§Œë‚œ ë‚ ì§œ</label>
                            <input type="date" id="meetingDate" style="width: 100%; padding: 8px; border: 1px solid #dbdbdb; border-radius: 6px; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 8px; font-size: 12px; color: #8e8e8e;">ë§Œë‚œ ì¹œêµ¬ë“¤ì„ ì„ íƒí•˜ì„¸ìš” (ì—¬ëŸ¬ëª… ê°€ëŠ¥)</div>
                        <div id="friendCheckboxes" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; max-height: 120px; overflow-y: auto;">
                            <!-- ì¹œêµ¬ ì²´í¬ë°•ìŠ¤ë“¤ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                        </div>
                        <div id="selectedFriends" style="margin-top: 8px; font-size: 12px; color: #405de6;"></div>
                    </div>
                    
                    <div id="imagePreview"></div>
                    
                    <div class="create-actions">
                        <button class="attach-btn" onclick="document.getElementById('imageInput').click()">
                            ğŸ“· ì‚¬ì§„ ì²¨ë¶€
                        </button>
                        <button class="post-btn" onclick="createPost()">ê²Œì‹œ</button>
                    </div>
                    
                    <input type="file" id="imageInput" class="hidden-file-input" accept="image/*" onchange="previewImage(this)">
                </div>
            </div>

            <!-- í”„ë¡œí•„ íƒ­ -->
            <div id="profile" class="tab-content">
                <div class="profile-header">
                    <div class="profile-top">
                        <div class="profile-pic-large" id="profilePicLarge"></div>
                        <div class="profile-info">
                            <div class="profile-name" id="profileName"></div>
                            <div class="profile-bio" id="profileBio">ì•ˆë…•í•˜ì„¸ìš”! ê°€ì¡°ì¿ ì˜ ì¼ì›ì…ë‹ˆë‹¤ âœ¨</div>
                            <button class="edit-profile-btn" onclick="openEditProfileModal()">í”„ë¡œí•„ í¸ì§‘</button>
                        </div>
                    </div>
                    <div class="profile-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="postCount">0</span>
                            <span class="stat-label">ê²Œì‹œë¬¼</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="meetingCount">0</span>
                            <span class="stat-label">ë§Œë‚¨</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="likeCount">0</span>
                            <span class="stat-label">ì¢‹ì•„ìš”</span>
                        </div>
                    </div>
                </div>
                <div id="myPosts"></div>
            </div>
        </div>

        <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="bottom-nav">
            <div class="nav-item active" data-tab="home" onclick="switchTab('home')">ğŸ </div>
            <div class="nav-item" data-tab="create" onclick="switchTab('create')">âœï¸</div>
            <div class="nav-item" data-tab="search" onclick="switchTab('search')">ğŸ”</div>
            <div class="nav-item" data-tab="profile" onclick="switchTab('profile')">ğŸ‘¤</div>
        </div>
    </div>

    <!-- ì¢‹ì•„ìš” ëª©ë¡ ëª¨ë‹¬ -->
    <div id="likesModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ì¢‹ì•„ìš”</div>
                <button class="close-btn" onclick="closeLikesModal()">&times;</button>
            </div>
            <div class="modal-body" id="likesModalBody"></div>
        </div>
    </div>

    <!-- ëŒ“ê¸€ ëª¨ë‹¬ -->
    <div id="commentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ëŒ“ê¸€</div>
                <button class="close-btn" onclick="closeCommentModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="commentsList"></div>
                <div style="border-top: 1px solid #dbdbdb; padding: 16px; margin-top: 16px;">
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <div class="profile-pic" id="commentProfilePic"></div>
                        <input type="text" id="commentInput" placeholder="ëŒ“ê¸€ ë‹¬ê¸°..." 
                               style="flex: 1; border: none; outline: none; font-size: 14px;"
                               onkeypress="handleCommentKeyPress(event)">
                        <button onclick="addComment()" style="background: #405de6; color: white; border: none; border-radius: 4px; padding: 6px 12px; font-size: 12px; cursor: pointer;">ê²Œì‹œ</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ì™•ë¹„í˜¸ íˆ¬í‘œ ëª¨ë‹¬ -->
    <div id="bihoVoteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ğŸ‘‘ ì™•ë¹„í˜¸ íˆ¬í‘œ</div>
                <button class="close-btn" onclick="closeBihoVoteModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px; color: #8e8e8e; font-size: 14px;">
                    ì´ë²ˆë‹¬ ê°€ì¥ ë§˜ì— ì•ˆ ë“œëŠ” ì¹œêµ¬ë¥¼ ì„ íƒí•˜ì„¸ìš” ğŸ˜ˆ<br>
                    <span style="color: #e91e63; font-weight: bold;">í•œ ë‹¬ì— í•œ ë²ˆë§Œ íˆ¬í‘œ ê°€ëŠ¥!</span>
                </div>
                <div id="bihoVoteList"></div>
            </div>
        </div>
    </div>

    <!-- í”„ë¡œí•„ í¸ì§‘ ëª¨ë‹¬ -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">í”„ë¡œí•„ í¸ì§‘</div>
                <button class="close-btn" onclick="closeEditProfileModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="edit-form">
                    <div class="form-group">
                        <label class="form-label">í”„ë¡œí•„ ì‚¬ì§„</label>
                        <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px;">
                            <div class="profile-pic-large" id="editProfilePic" style="width: 60px; height: 60px; font-size: 18px; cursor: pointer;" onclick="document.getElementById('profileImageInput').click()"></div>
                            <div>
                                <button type="button" onclick="document.getElementById('profileImageInput').click()" style="background: #405de6; color: white; border: none; border-radius: 6px; padding: 8px 12px; font-size: 12px; cursor: pointer;">ì‚¬ì§„ ë³€ê²½</button>
                                <br><small style="color: #8e8e8e; margin-top: 4px;">í´ë¦­í•˜ì—¬ í”„ë¡œí•„ ì‚¬ì§„ì„ ë³€ê²½í•˜ì„¸ìš”</small>
                            </div>
                        </div>
                        <input type="file" id="profileImageInput" class="hidden-file-input" accept="image/*" onchange="previewProfileImage(this)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ì´ë¦„</label>
                        <input type="text" class="form-input" id="editName" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ìê¸°ì†Œê°œ</label>
                        <textarea class="form-textarea" id="editBio" placeholder="ìì‹ ì„ ì†Œê°œí•´ë³´ì„¸ìš”..."></textarea>
                    </div>
                    <button class="save-btn" onclick="saveProfile()">ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ìŠ¤í† ë¦¬ ì—¬ëŸ¬ ê°œ ì—…ë¡œë“œ ëª¨ë‹¬ -->
    <div id="multiStoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ìŠ¤í† ë¦¬ ì—…ë¡œë“œ</div>
                <button class="close-btn" onclick="closeMultiStoryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="storyPreviewContainer" style="max-height: 60vh; overflow-y: auto;"></div>
                <div style="margin-top: 16px; text-align: center;">
                    <button id="uploadAllStoriesBtn" class="save-btn" onclick="uploadAllStories()" style="width: 100%;">ëª¨ë“  ìŠ¤í† ë¦¬ ì—…ë¡œë“œ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ì‚¬ì§„ì²©ìš© ìˆ¨ê¹€ íŒŒì¼ ì…ë ¥ -->
    <input type="file" id="galleryImageInput" class="hidden-file-input" accept="image/*" onchange="previewGalleryImage(this)">
    
    <!-- ìŠ¤í† ë¦¬ìš© ìˆ¨ê¹€ íŒŒì¼ ì…ë ¥ (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥) -->
    <input type="file" id="storyImageInput" class="hidden-file-input" accept="image/*" multiple onchange="previewMultipleStoryImages(this)">

    <script>
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyDVGZZ6JumYWpFF82d7RW-8DHmzqzNVGoo",
            authDomain: "gazoku-91025.firebaseapp.com",
            projectId: "gazoku-91025",
            storageBucket: "gazoku-91025.firebasestorage.app",
            messagingSenderId: "295977381584",
            appId: "1:295977381584:web:f21ffb806ae7f82918b8d5"
        };

        // Firebase ì´ˆê¸°í™”
        let db = null;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            
            // iOS Safariì—ì„œ Firebase ì—°ê²° ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ ì„¤ì •
            if (db) {
                db.enableNetwork();
                // iOSì—ì„œ ì˜¤í”„ë¼ì¸ ì§€ì› ë¹„í™œì„±í™” (ì—°ê²° ë¬¸ì œ ë°©ì§€)
                db.disableNetwork().then(() => {
                    return db.enableNetwork();
                });
            }
            
            console.log('âœ… Firebase ì´ˆê¸°í™” ì„±ê³µ!');
        } catch (error) {
            console.error('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            console.log('ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤.');
        }

        // ì¹œêµ¬ ë°ì´í„°
        const friends = [
            { name: "í™©ìŠ¹í•˜", birthday: "2001-07-11" },
            { name: "ì´ì„œí˜„", birthday: "2001-01-24" },
            { name: "í•œí¬ì¤€", birthday: "2001-12-21" },
            { name: "ë³µì§€í˜„", birthday: "2001-01-15" },
            { name: "ì–‘ì •í›„", birthday: "2001-10-18" },
            { name: "ìœ¤í¬íƒœ", birthday: "2001-10-15" },
            { name: "ê³½ë„ìœ¤", birthday: "2001-07-31" },
            { name: "ê°•ìˆœê±´", birthday: "2001-04-18" },
            { name: "ì–‘ê·œí˜„", birthday: "2001-04-19" },
            { name: "ì´í•™ì¤€", birthday: "2002-02-22" },
            { name: "ê°•ì •í˜„", birthday: "2001-08-07" },
            { name: "ë°•ì£¼í˜¸", birthday: "2001-06-01" },
            { name: "ì „ìƒí˜", birthday: "2001-08-18" },
            { name: "ì‹¬ì¬í˜„", birthday: "2001-10-05" },
            { name: "ì‹ ë¯¼í˜¸", birthday: "2001-03-03" }
        ];

        let currentProfileImageData = null;

        function previewProfileImage(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                currentProfileImageData = e.target.result;
                const editProfilePic = document.getElementById('editProfilePic');
                editProfilePic.style.backgroundImage = `url(${currentProfileImageData})`;
                editProfilePic.style.backgroundSize = 'cover';
                editProfilePic.style.backgroundPosition = 'center';
                editProfilePic.textContent = '';
            };
            reader.readAsDataURL(file);
        }
        let currentUser = null;
        let selectedFriend = null;
        let selectedPostType = 'diary';
        let currentImageData = null;
        let currentRankingTab = 'meeting';
        let currentPostId = null;
        let isCreatingPost = false; // ê²Œì‹œë¬¼ ì¤‘ë³µ ìƒì„± ë°©ì§€
        let selectedStoryImages = []; // ì„ íƒëœ ìŠ¤í† ë¦¬ ì´ë¯¸ì§€ë“¤

        // ë¡œì»¬ ìºì‹œ
        let posts = [];
        let profiles = {};
        let bihoVotes = {};
        let comments = {};
        let galleryPhotos = []; // ì‚¬ì§„ì²© ì „ìš© ì‚¬ì§„ë“¤
        let stories = []; // ìŠ¤í† ë¦¬ ì „ìš© (24ì‹œê°„)

        // Firebase ë°ì´í„° ê´€ë¦¬
        class FirebaseManager {
            static async addPost(post) {
                if (!db) {
                    console.log('ì˜¤í”„ë¼ì¸ ëª¨ë“œ: ë¡œì»¬ ì €ì¥ë§Œ');
                    // ë¡œì»¬ì—ëŠ” ì´ë¯¸ ì¶”ê°€ë˜ì–´ ìˆìœ¼ë¯€ë¡œ localStorageì—ë§Œ ì €ì¥
                    localStorage.setItem('posts', JSON.stringify(posts));
                    return true;
                }

                try {
                    // Firebaseì— ì €ì¥í•  ë•ŒëŠ” id í•„ë“œ ì œì™¸ (Firestoreê°€ ìë™ ìƒì„±)
                    const { id, ...postData } = post;
                    const docRef = await db.collection('posts').add(postData);
                    console.log('Firebase ë¬¸ì„œ ID:', docRef.id);
                    
                    // ë¡œì»¬ posts ë°°ì—´ì—ì„œ í•´ë‹¹ ê²Œì‹œë¬¼ì˜ idë¥¼ Firebase IDë¡œ ì—…ë°ì´íŠ¸
                    const localPostIndex = posts.findIndex(p => p.id === post.id);
                    if (localPostIndex !== -1) {
                        posts[localPostIndex].id = docRef.id;
                    }
                    
                    return true;
                } catch (error) {
                    console.error('í¬ìŠ¤íŠ¸ ì €ì¥ ì‹¤íŒ¨:', error);
                    // ì‹¤íŒ¨í•´ë„ ë¡œì»¬ì—ëŠ” ì €ì¥ë˜ì–´ ìˆìŒ
                    localStorage.setItem('posts', JSON.stringify(posts));
                    return true;
                }
            }

            static async getPosts() {
                if (!db) {
                    posts = JSON.parse(localStorage.getItem('posts') || '[]');
                    return posts;
                }

                try {
                    const snapshot = await db.collection('posts').orderBy('date', 'desc').get();
                    posts = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    console.log(`âœ… Firebaseì—ì„œ ${posts.length}ê°œ ê²Œì‹œë¬¼ ë¡œë“œ`);
                    return posts;
                } catch (error) {
                    console.error('í¬ìŠ¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                    posts = JSON.parse(localStorage.getItem('posts') || '[]');
                    return posts;
                }
            }

            static async updatePost(postId, updates) {
                if (!db) {
                    const postIndex = posts.findIndex(p => p.id === postId);
                    if (postIndex !== -1) {
                        posts[postIndex] = { ...posts[postIndex], ...updates };
                        localStorage.setItem('posts', JSON.stringify(posts));
                    }
                    return true;
                }

                try {
                    await db.collection('posts').doc(postId).update(updates);
                    return true;
                } catch (error) {
                    console.error('í¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                    const postIndex = posts.findIndex(p => p.id === postId);
                    if (postIndex !== -1) {
                        posts[postIndex] = { ...posts[postIndex], ...updates };
                        localStorage.setItem('posts', JSON.stringify(posts));
                    }
                    return true;
                }
            }

            static async deletePost(postId) {
                if (!db) {
                    posts = posts.filter(p => p.id !== postId);
                    localStorage.setItem('posts', JSON.stringify(posts));
                    return true;
                }

                try {
                    await db.collection('posts').doc(postId).delete();
                    return true;
                } catch (error) {
                    console.error('í¬ìŠ¤íŠ¸ ì‚­ì œ ì‹¤íŒ¨:', error);
                    posts = posts.filter(p => p.id !== postId);
                    localStorage.setItem('posts', JSON.stringify(posts));
                    return true;
                }
            }

            static async addComment(postId, comment) {
                if (!db) {
                    if (!comments[postId]) comments[postId] = [];
                    comments[postId].push(comment);
                    localStorage.setItem('comments', JSON.stringify(comments));
                    return true;
                }

                try {
                    await db.collection('comments').add({
                        postId: postId,
                        ...comment
                    });
                    return true;
                } catch (error) {
                    console.error('ëŒ“ê¸€ ì €ì¥ ì‹¤íŒ¨:', error);
                    if (!comments[postId]) comments[postId] = [];
                    comments[postId].push(comment);
                    localStorage.setItem('comments', JSON.stringify(comments));
                    return true;
                }
            }

            static async getComments() {
                if (!db) {
                    comments = JSON.parse(localStorage.getItem('comments') || '{}');
                    return comments;
                }

                try {
                    const snapshot = await db.collection('comments').get();
                    const firestoreComments = {};
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (!firestoreComments[data.postId]) {
                            firestoreComments[data.postId] = [];
                        }
                        firestoreComments[data.postId].push({
                            id: doc.id,
                            author: data.author,
                            text: data.text,
                            date: data.date
                        });
                    });
                    comments = firestoreComments;
                    return firestoreComments;
                } catch (error) {
                    console.error('ëŒ“ê¸€ ë¡œë“œ ì‹¤íŒ¨:', error);
                    comments = JSON.parse(localStorage.getItem('comments') || '{}');
                    return comments;
                }
            }

            static async updateBihoVotes(monthKey, voteData) {
                if (!db) {
                    bihoVotes[monthKey] = voteData;
                    localStorage.setItem('bihoVotes', JSON.stringify(bihoVotes));
                    return true;
                }

                try {
                    await db.collection('bihoVotes').doc(monthKey).set(voteData);
                    return true;
                } catch (error) {
                    console.error('ì™•ë¹„í˜¸ íˆ¬í‘œ ì €ì¥ ì‹¤íŒ¨:', error);
                    bihoVotes[monthKey] = voteData;
                    localStorage.setItem('bihoVotes', JSON.stringify(bihoVotes));
                    return true;
                }
            }

            static async getBihoVotes() {
                if (!db) {
                    bihoVotes = JSON.parse(localStorage.getItem('bihoVotes') || '{}');
                    return bihoVotes;
                }

                try {
                    const snapshot = await db.collection('bihoVotes').get();
                    const firestoreBihoVotes = {};
                    snapshot.docs.forEach(doc => {
                        firestoreBihoVotes[doc.id] = doc.data();
                    });
                    bihoVotes = firestoreBihoVotes;
                    return firestoreBihoVotes;
                } catch (error) {
                    console.error('ì™•ë¹„í˜¸ íˆ¬í‘œ ë¡œë“œ ì‹¤íŒ¨:', error);
                    bihoVotes = JSON.parse(localStorage.getItem('bihoVotes') || '{}');
                    return bihoVotes;
                }
            }

            static async updateProfile(userId, profileData) {
                if (!db) {
                    profiles[userId] = profileData;
                    localStorage.setItem('profiles', JSON.stringify(profiles));
                    return true;
                }

                try {
                    await db.collection('profiles').doc(userId).set(profileData);
                    return true;
                } catch (error) {
                    console.error('í”„ë¡œí•„ ì €ì¥ ì‹¤íŒ¨:', error);
                    profiles[userId] = profileData;
                    localStorage.setItem('profiles', JSON.stringify(profiles));
                    return true;
                }
            }

            static async getProfiles() {
                if (!db) {
                    profiles = JSON.parse(localStorage.getItem('profiles') || '{}');
                    return profiles;
                }

                try {
                    const snapshot = await db.collection('profiles').get();
                    const firestoreProfiles = {};
                    snapshot.docs.forEach(doc => {
                        firestoreProfiles[doc.id] = doc.data();
                    });
                    profiles = firestoreProfiles;
                    return firestoreProfiles;
                } catch (error) {
                    console.error('í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:', error);
                    profiles = JSON.parse(localStorage.getItem('profiles') || '{}');
                    return profiles;
                }
            }

            static async addGalleryPhoto(photo) {
                if (!db) {
                    galleryPhotos.unshift(photo);
                    localStorage.setItem('galleryPhotos', JSON.stringify(galleryPhotos));
                    return true;
                }

                try {
                    // Firebaseì— ì €ì¥í•  ë•ŒëŠ” id í•„ë“œ ì œì™¸
                    const { id, ...photoData } = photo;
                    const docRef = await db.collection('galleryPhotos').add(photoData);
                    console.log('Firebase ì‚¬ì§„ ë¬¸ì„œ ID:', docRef.id);
                    
                    // ë¡œì»¬ ë°°ì—´ì—ì„œëŠ” Firebase IDë¡œ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
                    // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•¨
                    
                    return true;
                } catch (error) {
                    console.error('ì‚¬ì§„ì²© ì‚¬ì§„ ì €ì¥ ì‹¤íŒ¨:', error);
                    // ì‹¤íŒ¨ ì‹œì—ë§Œ ë¡œì»¬ì— ì €ì¥
                    galleryPhotos.unshift(photo);
                    localStorage.setItem('galleryPhotos', JSON.stringify(galleryPhotos));
                    throw error; // ì—ëŸ¬ë¥¼ ë‹¤ì‹œ ë˜ì ¸ì„œ UIì—ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡
                }
            }

            static async getGalleryPhotos() {
                if (!db) {
                    galleryPhotos = JSON.parse(localStorage.getItem('galleryPhotos') || '[]');
                    return galleryPhotos;
                }

                try {
                    const snapshot = await db.collection('galleryPhotos').orderBy('date', 'desc').get();
                    galleryPhotos = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    return galleryPhotos;
                } catch (error) {
                    console.error('ì‚¬ì§„ì²© ì‚¬ì§„ ë¡œë“œ ì‹¤íŒ¨:', error);
                    galleryPhotos = JSON.parse(localStorage.getItem('galleryPhotos') || '[]');
                    return galleryPhotos;
                }
            }

            static async deleteGalleryPhoto(photoId) {
                if (!db) {
                    galleryPhotos = galleryPhotos.filter(p => p.id !== photoId);
                    localStorage.setItem('galleryPhotos', JSON.stringify(galleryPhotos));
                    return true;
                }

                try {
                    await db.collection('galleryPhotos').doc(photoId).delete();
                    return true;
                } catch (error) {
                    console.error('ì‚¬ì§„ì²¨ ì‚¬ì§„ ì‚­ì œ ì‹¤íŒ¨:', error);
                    galleryPhotos = galleryPhotos.filter(p => p.id !== photoId);
                    localStorage.setItem('galleryPhotos', JSON.stringify(galleryPhotos));
                    return true;
                }
            }

            static async addStory(story) {
                if (!db) {
                    stories.unshift(story);
                    localStorage.setItem('stories', JSON.stringify(stories));
                    return true;
                }

                try {
                    // Firebaseì— ì €ì¥í•  ë•ŒëŠ” id í•„ë“œ ì œì™¸
                    const { id, ...storyData } = story;
                    const docRef = await db.collection('stories').add(storyData);
                    console.log('Firebase ìŠ¤í† ë¦¬ ë¬¸ì„œ ID:', docRef.id);
                    
                    // ë¡œì»¬ ë°°ì—´ì—ì„œëŠ” Firebase IDë¡œ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
                    // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬í•¨
                    
                    return true;
                } catch (error) {
                    console.error('ìŠ¤í† ë¦¬ ì €ì¥ ì‹¤íŒ¨:', error);
                    // ì‹¤íŒ¨ ì‹œì—ë§Œ ë¡œì»¬ì— ì €ì¥
                    stories.unshift(story);
                    localStorage.setItem('stories', JSON.stringify(stories));
                    throw error; // ì—ëŸ¬ë¥¼ ë‹¤ì‹œ ë˜ì ¸ì„œ UIì—ì„œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡
                }
            }

            static async getStories() {
                if (!db) {
                    stories = JSON.parse(localStorage.getItem('stories') || '[]');
                    // 24ì‹œê°„ ì§€ë‚œ ìŠ¤í† ë¦¬ ì œê±°
                    stories = stories.filter(story => {
                        const storyDate = new Date(story.date);
                        const now = new Date();
                        const hoursDiff = (now - storyDate) / (1000 * 60 * 60);
                        return hoursDiff < 24;
                    });
                    localStorage.setItem('stories', JSON.stringify(stories));
                    return stories;
                }

                try {
                    const snapshot = await db.collection('stories').orderBy('date', 'desc').get();
                    const allStories = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    
                    // 24ì‹œê°„ ì§€ë‚œ ìŠ¤í† ë¦¬ í•„í„°ë§ ë° ì‚­ì œ
                    const validStories = [];
                    const expiredStories = [];
                    
                    allStories.forEach(story => {
                        const storyDate = new Date(story.date);
                        const now = new Date();
                        const hoursDiff = (now - storyDate) / (1000 * 60 * 60);
                        
                        if (hoursDiff < 24) {
                            validStories.push(story);
                        } else {
                            expiredStories.push(story.id);
                        }
                    });
                    
                    // ë§Œë£Œëœ ìŠ¤í† ë¦¬ ì‚­ì œ
                    expiredStories.forEach(async (storyId) => {
                        await db.collection('stories').doc(storyId).delete();
                    });
                    
                    stories = validStories;
                    return validStories;
                } catch (error) {
                    console.error('ìŠ¤í† ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
                    stories = JSON.parse(localStorage.getItem('stories') || '[]');
                    return stories;
                }
            }

            static async deleteStory(storyId) {
                if (!db) {
                    stories = stories.filter(s => s.id !== storyId);
                    localStorage.setItem('stories', JSON.stringify(stories));
                    return true;
                }

                try {
                    await db.collection('stories').doc(storyId).delete();
                    return true;
                } catch (error) {
                    console.error('ìŠ¤í† ë¦¬ ì‚­ì œ ì‹¤íŒ¨:', error);
                    stories = stories.filter(s => s.id !== storyId);
                    localStorage.setItem('stories', JSON.stringify(stories));
                    return true;
                }
            }
        }

        // ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ ë¦¬ìŠ¤ë„ˆ
        function setupRealtimeListeners() {
            if (!db) return;

            try {
                db.collection('posts').onSnapshot((snapshot) => {
                    console.log('Firebase ê²Œì‹œë¬¼ ì—…ë°ì´íŠ¸ ê°ì§€');
                    
                    const updatedPosts = [];
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        updatedPosts.push({
                            id: doc.id,
                            ...data
                        });
                    });
                    
                    // ë‚ ì§œìˆœ ì •ë ¬
                    updatedPosts.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    // ê¸°ì¡´ postsì™€ ë¹„êµí•´ì„œ ì‹¤ì œë¡œ ë³€ê²½ëœ ê²½ìš°ë§Œ ì—…ë°ì´íŠ¸
                    const postsChanged = JSON.stringify(posts) !== JSON.stringify(updatedPosts);
                    
                    if (postsChanged) {
                        console.log('ê²Œì‹œë¬¼ ëª©ë¡ ì—…ë°ì´íŠ¸:', updatedPosts.length, 'ê°œ');
                        posts = updatedPosts;
                        
                        // UI ì—…ë°ì´íŠ¸ëŠ” debounce ì ìš©
                        clearTimeout(window.updateUITimeout);
                        window.updateUITimeout = setTimeout(() => {
                            if (document.getElementById('postFeed')) {
                                renderPostFeed();
                                renderStories();
                                if (currentUser && document.getElementById('profile').classList.contains('active')) {
                                    renderProfile();
                                }
                            }
                        }, 100);
                    }
                });

                db.collection('comments').onSnapshot((snapshot) => {
                    const updatedComments = {};
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        if (!updatedComments[data.postId]) {
                            updatedComments[data.postId] = [];
                        }
                        updatedComments[data.postId].push({
                            id: doc.id,
                            author: data.author,
                            text: data.text,
                            date: data.date
                        });
                    });
                    
                    const commentsChanged = JSON.stringify(comments) !== JSON.stringify(updatedComments);
                    if (commentsChanged) {
                        comments = updatedComments;
                        
                        if (currentPostId && document.getElementById('commentModal').classList.contains('active')) {
                            renderComments(currentPostId);
                        }
                        if (document.getElementById('postFeed')) {
                            renderPostFeed();
                        }
                    }
                });

                db.collection('bihoVotes').onSnapshot((snapshot) => {
                    const updatedBihoVotes = {};
                    snapshot.docs.forEach(doc => {
                        updatedBihoVotes[doc.id] = doc.data();
                    });
                    bihoVotes = updatedBihoVotes;
                    
                    if (currentRankingTab === 'biho' && document.getElementById('search').classList.contains('active')) {
                        renderRanking();
                    }
                });

                db.collection('galleryPhotos').onSnapshot((snapshot) => {
                    console.log('Firebase ì‚¬ì§„ì²© ì—…ë°ì´íŠ¸ ê°ì§€');
                    
                    const updatedGalleryPhotos = [];
                    snapshot.docs.forEach(doc => {
                        updatedGalleryPhotos.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                    
                    updatedGalleryPhotos.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    const galleryChanged = JSON.stringify(galleryPhotos) !== JSON.stringify(updatedGalleryPhotos);
                    if (galleryChanged) {
                        console.log('ì‚¬ì§„ì²© ëª©ë¡ ì—…ë°ì´íŠ¸:', updatedGalleryPhotos.length, 'ê°œ');
                        galleryPhotos = updatedGalleryPhotos;
                        
                        // UI ì—…ë°ì´íŠ¸ëŠ” debounce ì ìš©
                        clearTimeout(window.updateGalleryTimeout);
                        window.updateGalleryTimeout = setTimeout(() => {
                            if (currentRankingTab === 'gallery' && document.getElementById('search').classList.contains('active')) {
                                renderRanking();
                            }
                        }, 100);
                    }
                });

                db.collection('stories').onSnapshot((snapshot) => {
                    console.log('Firebase ìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸ ê°ì§€');
                    
                    const updatedStories = [];
                    snapshot.docs.forEach(doc => {
                        const data = doc.data();
                        const storyDate = new Date(data.date);
                        const now = new Date();
                        const hoursDiff = (now - storyDate) / (1000 * 60 * 60);
                        
                        // 24ì‹œê°„ ì´ë‚´ ìŠ¤í† ë¦¬ë§Œ í¬í•¨
                        if (hoursDiff < 24) {
                            updatedStories.push({
                                id: doc.id,
                                ...data
                            });
                        }
                    });
                    
                    updatedStories.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    const storiesChanged = JSON.stringify(stories) !== JSON.stringify(updatedStories);
                    if (storiesChanged) {
                        console.log('ìŠ¤í† ë¦¬ ëª©ë¡ ì—…ë°ì´íŠ¸:', updatedStories.length, 'ê°œ');
                        stories = updatedStories;
                        
                        // UI ì—…ë°ì´íŠ¸ëŠ” debounce ì ìš©
                        clearTimeout(window.updateStoriesTimeout);
                        window.updateStoriesTimeout = setTimeout(() => {
                            renderStories();
                        }, 100);
                    }
                });
                
                console.log('ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
            } catch (error) {
                console.log('ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹¤íŒ¨:', error);
            }
        }

        function checkBirthdays() {
            const today = new Date();
            const todayMonth = today.getMonth() + 1;
            const todayDate = today.getDate();
            
            // ì™•ë¹„í˜¸ 1ìˆœìœ„ í™•ì¸
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${now.getMonth()}`;
            const currentVotes = bihoVotes[currentMonth] || { votes: {}, voters: {} };
            const bihoRanking = Object.entries(currentVotes.votes || {})
                .map(([name, votes]) => ({ name, votes }))
                .sort((a, b) => b.votes - a.votes);
            const bihoKing = bihoRanking.length > 0 && bihoRanking[0].votes > 0 ? bihoRanking[0] : null;
            
            // ì˜¤ëŠ˜ì´ ìƒì¼ì¸ ì¹œêµ¬ ì°¾ê¸°
            const birthdayFriends = friends.filter(friend => {
                const birthday = new Date(friend.birthday);
                return birthday.getMonth() + 1 === todayMonth && birthday.getDate() === todayDate;
            });
            
            const banner = document.getElementById('birthdayBanner');
            const message = document.getElementById('birthdayMessage');
            
            if (birthdayFriends.length > 0) {
                // ì˜¤ëŠ˜ì´ ìƒì¼ì¸ ê²½ìš°
                const names = birthdayFriends.map(f => f.name).join(', ');
                const bihoText = bihoKing ? ` | ğŸ‘‘ ì™•ë¹„í˜¸: ${bihoKing.name} (${bihoKing.votes}í‘œ)` : '';
                message.textContent = `ğŸ‰ ${names}ë‹˜ ìƒì¼!${bihoText}`;
                banner.style.display = 'block';
                banner.style.background = '#e91e63';
            } else {
                // ë‹¤ìŒ ìƒì¼ê¹Œì§€ ë©°ì¹  ë‚¨ì•˜ëŠ”ì§€ í‘œì‹œ (í•­ìƒ í‘œì‹œ)
                const upcomingBirthdays = friends
                    .map(friend => ({
                        ...friend,
                        daysUntil: getDaysUntilBirthday(friend.birthday)
                    }))
                    .sort((a, b) => a.daysUntil - b.daysUntil);
                
                const nextBirthday = upcomingBirthdays[0];
                const bihoText = bihoKing ? ` | ğŸ‘‘ ì™•ë¹„í˜¸: ${bihoKing.name} (${bihoKing.votes}í‘œ)` : '';
                
                if (nextBirthday.daysUntil === 0) {
                    message.textContent = `ğŸ‚ ${nextBirthday.name}ë‹˜ ìƒì¼ D-DAY!${bihoText}`;
                    banner.style.background = '#e91e63';
                } else {
                    message.textContent = `ğŸ—“ï¸ ë‹¤ìŒ ìƒì¼: ${nextBirthday.name} (D-${nextBirthday.daysUntil})${bihoText}`;
                    banner.style.background = '#262626';
                }
                banner.style.display = 'block';
            }
        }
        async function initializeBihoVotes() {
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${now.getMonth()}`;
            
            // Firebaseì—ì„œ ìµœì‹  íˆ¬í‘œ ë°ì´í„° ë¨¼ì € ê°€ì ¸ì˜¤ê¸°
            try {
                await FirebaseManager.getBihoVotes();
            } catch (error) {
                console.log('íˆ¬í‘œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
            }
            
            // Firebaseì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ í™•ì¸í•œ í›„ ì´ˆê¸°í™” ì—¬ë¶€ ê²°ì •
            if (!bihoVotes[currentMonth]) {
                const initialVotes = {
                    votes: {},
                    voters: {}
                };
                
                friends.forEach(friend => {
                    initialVotes.votes[friend.name] = 0;
                });
                
                await FirebaseManager.updateBihoVotes(currentMonth, initialVotes);
            }
        }

        // iOS ì „ìš© ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        function setupEventListeners() {
            // iOSì—ì„œ ê²Œì‹œ ë²„íŠ¼ í„°ì¹˜ ì´ë²¤íŠ¸ ì¶”ê°€
            const postBtn = document.querySelector('.post-btn');
            if (postBtn) {
                // í„°ì¹˜ ì´ë²¤íŠ¸ë„ í•¨ê»˜ ì²˜ë¦¬ (iOS Safari í˜¸í™˜ì„±)
                postBtn.addEventListener('touchend', function(e) {
                    e.preventDefault();
                    if (!isCreatingPost) {
                        createPost();
                    }
                });
            }
            
            // iOSì—ì„œ ì…ë ¥ í•„ë“œ í¬ì»¤ìŠ¤ ë¬¸ì œ í•´ê²°
            const textInputs = document.querySelectorAll('input, textarea');
            textInputs.forEach(input => {
                input.addEventListener('touchstart', function() {
                    this.focus();
                });
            });
        }

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            // ìƒˆë¡œê³ ì¹¨ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            checkLoginStatus();
            renderFriendGrid();
            setupEventListeners();
        });

        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            const lastLoginTime = localStorage.getItem('lastLoginTime');
            
            // ë¡œê·¸ì¸í•œ ì§€ 24ì‹œê°„ ì´ë‚´ë¼ë©´ ìë™ ë¡œê·¸ì¸
            if (savedUser && lastLoginTime) {
                const timeDiff = Date.now() - parseInt(lastLoginTime);
                const hoursDiff = timeDiff / (1000 * 60 * 60);
                
                if (hoursDiff < 24) {
                    currentUser = savedUser;
                    selectedFriend = savedUser;
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainApp').style.display = 'block';
                    
                    showLoadingMessage();
                    initializeApp();
                    return;
                }
            }
            
            // ìë™ ë¡œê·¸ì¸ ì‹¤íŒ¨ì‹œ ë¡œê·¸ì¸ í™”ë©´ í‘œì‹œ
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        function renderFriendGrid() {
            const grid = document.getElementById('friendGrid');
            grid.innerHTML = friends.map(friend => `
                <div class="friend-card" data-name="${friend.name}" onclick="selectFriend('${friend.name}')">
                    <div class="friend-name">${friend.name}</div>
                </div>
            `).join('');
        }

        function selectFriend(name) {
            document.querySelectorAll('.friend-card').forEach(card => {
                card.classList.remove('selected');
            });

            const selectedCard = document.querySelector(`[data-name="${name}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
                selectedFriend = name;
                
                // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œ í‘œì‹œ
                showPasswordInput();
            }
        }

        function showPasswordInput() {
            const loginBox = document.querySelector('.login-box');
            
            // ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œê°€ ìˆìœ¼ë©´ ì œê±°
            const existingPasswordDiv = document.getElementById('passwordSection');
            if (existingPasswordDiv) {
                existingPasswordDiv.remove();
            }
            
            // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì„¹ì…˜ ì¶”ê°€
            const passwordSection = document.createElement('div');
            passwordSection.id = 'passwordSection';
            passwordSection.innerHTML = `
                <div style="margin: 20px 0;">
                    <input type="password" id="passwordInput" placeholder="${selectedFriend}ë‹˜ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" 
                           style="width: 100%; padding: 12px; border: 1px solid #dbdbdb; border-radius: 8px; font-size: 14px; margin-bottom: 10px;"
                           onkeypress="handlePasswordKeyPress(event)">
                    <div style="font-size: 12px; color: #8e8e8e; text-align: left;">
                        ğŸ’¡ íŒíŠ¸: ë³¸ì¸ë§Œ ì•„ëŠ” ê°„ë‹¨í•œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì„¤ì •í•˜ì„¸ìš”
                    </div>
                </div>
            `;
            
            // ë¡œê·¸ì¸ ë²„íŠ¼ ìœ„ì— ì‚½ì…
            const loginBtn = document.getElementById('loginBtn');
            loginBox.insertBefore(passwordSection, loginBtn);
            
            // ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
            document.getElementById('passwordInput').focus();
            
            // ë¡œê·¸ì¸ ë²„íŠ¼ í™œì„±í™”
            document.getElementById('loginBtn').disabled = false;
        }

        function handlePasswordKeyPress(event) {
            if (event.key === 'Enter') {
                login();
            }
        }

        async function login() {
            if (!selectedFriend) {
                alert('ì¹œêµ¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            const passwordInput = document.getElementById('passwordInput');
            const password = passwordInput ? passwordInput.value.trim() : '';
            
            if (!password) {
                alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            // ê°„ë‹¨í•œ ë¹„ë°€ë²ˆí˜¸ ê²€ì¦ (ìµœì†Œ 3ìë¦¬)
            if (password.length < 3) {
                alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 3ìë¦¬ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            
            // ì‚¬ìš©ìë³„ ë¹„ë°€ë²ˆí˜¸ ì €ì¥/í™•ì¸
            const savedPasswords = JSON.parse(localStorage.getItem('userPasswords') || '{}');
            
            if (savedPasswords[selectedFriend]) {
                // ê¸°ì¡´ ì‚¬ìš©ì - ë¹„ë°€ë²ˆí˜¸ í™•ì¸
                if (savedPasswords[selectedFriend] !== password) {
                    alert('ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤!');
                    passwordInput.value = '';
                    passwordInput.focus();
                    return;
                }
            } else {
                // ì‹ ê·œ ì‚¬ìš©ì - ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
                if (confirm(`${selectedFriend}ë‹˜ì˜ ë¹„ë°€ë²ˆí˜¸ë¥¼ "${password}"ë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në‹¤ìŒ ì ‘ì†ì‹œë¶€í„° ì´ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.`)) {
                    savedPasswords[selectedFriend] = password;
                    localStorage.setItem('userPasswords', JSON.stringify(savedPasswords));
                } else {
                    passwordInput.value = '';
                    passwordInput.focus();
                    return;
                }
            }
            
            currentUser = selectedFriend;
            
            // ë¡œê·¸ì¸ ìƒíƒœ ì €ì¥
            localStorage.setItem('currentUser', currentUser);
            localStorage.setItem('lastLoginTime', Date.now().toString());
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            showLoadingMessage();
            await initializeApp();
        }

        function showLoadingMessage() {
            const content = document.querySelector('.content');
            content.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 50vh; gap: 20px;">
                    <div style="font-size: 24px;">ğŸ”¥</div>
                    <div style="font-size: 18px; font-weight: bold;">ê°€ì¡°ì¿  ë¡œë”©ì¤‘...</div>
                    <div style="font-size: 14px; color: #8e8e8e;">ì¹œêµ¬ë“¤ê³¼ ì‹¤ì‹œê°„ ì—°ê²°í•˜ëŠ” ì¤‘ì´ì—ìš”!</div>
                </div>
            `;
        }

        async function initializeApp() {
            try {
                // iOSì—ì„œ Firebase ë¡œë”© ì‹œê°„ ì´ˆê³¼ ë°©ì§€ (10ì´ˆ timeout)
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('iOS Firebase timeout')), 10000)
                );
                
                const dataPromise = Promise.all([
                    FirebaseManager.getPosts(),
                    FirebaseManager.getComments(),
                    FirebaseManager.getBihoVotes(),
                    FirebaseManager.getProfiles(),
                    FirebaseManager.getGalleryPhotos(),
                    FirebaseManager.getStories()
                ]);
                
                // timeoutê³¼ ë°ì´í„° ë¡œë”© ì¤‘ ë¨¼ì € ì™„ë£Œë˜ëŠ” ê²ƒì„ ê¸°ë‹¤ë¦¼
                await Promise.race([dataPromise, timeoutPromise]);

                setupRealtimeListeners();
                
                // ë¡œë”© ì™„ë£Œ í›„ ì •ìƒ í™”ë©´ ë³µì›
                document.querySelector('.content').innerHTML = `
                    <!-- í™ˆ í”¼ë“œ -->
                    <div id="home" class="tab-content active">
                        <!-- ìŠ¤í† ë¦¬ ì˜ì—­ -->
                        <div class="stories-container">
                            <div class="stories-scroll" id="storiesContainer">
                                <!-- ìŠ¤í† ë¦¬ê°€ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                            </div>
                        </div>

                        <!-- í¬ìŠ¤íŠ¸ í”¼ë“œ -->
                        <div id="postFeed"></div>
                    </div>

                    <!-- ê²€ìƒ‰/ë­í‚¹ íƒ­ -->
                    <div id="search" class="tab-content">
                        <div class="search-container">
                            <div class="search-tabs">
                                <button class="search-tab active" onclick="showRankingTab('meeting')">ë§Œë‚¨í‚¹</button>
                                <button class="search-tab" onclick="showRankingTab('popular')">ì¸ê¸°ê¸€</button>
                                <button class="search-tab" onclick="showRankingTab('biho')">ì™•ë¹„í˜¸</button>
                                <button class="search-tab" onclick="showRankingTab('gallery')">ì‚¬ì§„ì²©</button>
                                <button class="search-tab" onclick="showRankingTab('stats')">í†µê³„</button>
                            </div>
                            <div id="rankingContent"></div>
                        </div>
                    </div>

                    <!-- ê²Œì‹œê¸€ ì‘ì„± íƒ­ -->
                    <div id="create" class="tab-content">
                        <!-- í¬ìŠ¤íŠ¸ ì‘ì„± -->
                        <div class="create-post">
                            <div class="create-header">
                                <div class="profile-pic" id="createProfilePic"></div>
                                <div style="flex: 1;">
                                    <div class="post-type">
                                        <button class="type-btn active" data-type="diary" onclick="selectPostType('diary')">ğŸ“ ì¼ê¸°</button>
                                        <button class="type-btn" data-type="meeting" onclick="selectPostType('meeting')">ğŸ‘¥ ë§Œë‚¨</button>
                                    </div>
                                </div>
                            </div>
                            
                            <textarea class="create-input" id="postContent" placeholder="ì˜¤ëŠ˜ ì–´ë–¤ í•˜ë£¨ë¥¼ ë³´ë‚´ì…¨ë‚˜ìš”?"></textarea>
                            
                            <div class="meeting-selector" id="meetingSelector">
                                <div style="margin-bottom: 12px;">
                                    <label style="display: block; margin-bottom: 8px; font-size: 12px; color: #8e8e8e;">ë§Œë‚œ ë‚ ì§œ</label>
                                    <input type="date" id="meetingDate" style="width: 100%; padding: 8px; border: 1px solid #dbdbdb; border-radius: 6px; font-size: 14px;">
                                </div>
                                <div style="margin-bottom: 8px; font-size: 12px; color: #8e8e8e;">ë§Œë‚œ ì¹œêµ¬ë“¤ì„ ì„ íƒí•˜ì„¸ìš” (ì—¬ëŸ¬ëª… ê°€ëŠ¥)</div>
                                <div id="friendCheckboxes" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; max-height: 120px; overflow-y: auto;">
                                    <!-- ì¹œêµ¬ ì²´í¬ë°•ìŠ¤ë“¤ì´ ì—¬ê¸°ì— ìƒì„±ë©ë‹ˆë‹¤ -->
                                </div>
                                <div id="selectedFriends" style="margin-top: 8px; font-size: 12px; color: #405de6;"></div>
                            </div>
                            
                            <div id="imagePreview"></div>
                            
                            <div class="create-actions">
                                <button class="attach-btn" onclick="document.getElementById('imageInput').click()">
                                    ğŸ“· ì‚¬ì§„ ì²¨ë¶€
                                </button>
                                <button class="post-btn" onclick="createPost()">ê²Œì‹œ</button>
                            </div>
                            
                            <input type="file" id="imageInput" class="hidden-file-input" accept="image/*" onchange="previewImage(this)">
                        </div>
                    </div>

                    <!-- í”„ë¡œí•„ íƒ­ -->
                    <div id="profile" class="tab-content">
                        <div class="profile-header">
                            <div class="profile-top">
                                <div class="profile-pic-large" id="profilePicLarge"></div>
                                <div class="profile-info">
                                    <div class="profile-name" id="profileName"></div>
                                    <div class="profile-bio" id="profileBio">ì•ˆë…•í•˜ì„¸ìš”! ê°€ì¡°ì¿ ì˜ ì¼ì›ì…ë‹ˆë‹¤ âœ¨</div>
                                    <button class="edit-profile-btn" onclick="openEditProfileModal()">í”„ë¡œí•„ í¸ì§‘</button>
                                </div>
                            </div>
                            <div class="profile-stats">
                                <div class="stat-item">
                                    <span class="stat-number" id="postCount">0</span>
                                    <span class="stat-label">ê²Œì‹œë¬¼</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number" id="meetingCount">0</span>
                                    <span class="stat-label">ë§Œë‚¨</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number" id="likeCount">0</span>
                                    <span class="stat-label">ì¢‹ì•„ìš”</span>
                                </div>
                            </div>
                        </div>
                        <div id="myPosts"></div>
                    </div>
                `;
                
                setupSelectOptions();
                updateProfilePics();
                checkBirthdays(); // ìƒì¼ í™•ì¸ ì¶”ê°€
                renderStories();
                renderPostFeed();
                renderRanking();
                renderProfile();
                await initializeBihoVotes();

                console.log('âœ… ê°€ì¡°ì¿  ì´ˆê¸°í™” ì™„ë£Œ!');
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                // ì˜¤ë¥˜ ë°œìƒì‹œì—ë„ ê¸°ë³¸ í™”ë©´ í‘œì‹œ
                document.querySelector('.content').innerHTML = `
                    <div style="padding: 20px; text-align: center;">
                        <h3>ì˜¤í”„ë¼ì¸ ëª¨ë“œë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤</h3>
                        <p>Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆì§€ë§Œ ê¸°ë³¸ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                        <button onclick="location.reload()" style="margin-top: 10px; padding: 8px 16px; background: #405de6; color: white; border: none; border-radius: 4px;">ë‹¤ì‹œ ì‹œë„</button>
                    </div>
                `;
            }
        }

        function setupSelectOptions() {
            // ë§Œë‚¨ ì„ íƒìš© ì²´í¬ë°•ìŠ¤ ìƒì„±
            setupMeetingFriendCheckboxes();
        }

        function updateSelectedFriends() {
            const checkboxes = document.querySelectorAll('#friendCheckboxes input[type="checkbox"]:checked');
            const selectedNames = Array.from(checkboxes).map(cb => cb.value);
            
            const selectedDiv = document.getElementById('selectedFriends');
            if (selectedNames.length > 0) {
                selectedDiv.textContent = `ì„ íƒëœ ì¹œêµ¬: ${selectedNames.join(', ')}`;
            } else {
                selectedDiv.textContent = '';
            }
        }

        function updateProfilePics() {
            const initials = currentUser.substring(0, 2);
            const userProfile = profiles[currentUser] || {};
            
            // í”„ë¡œí•„ ì‚¬ì§„ì´ ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ ì´ë‹ˆì…œ
            if (userProfile.profileImage) {
                // ë©”ì¸ í”„ë¡œí•„ ì‚¬ì§„ë“¤
                document.getElementById('createProfilePic').style.backgroundImage = `url(${userProfile.profileImage})`;
                document.getElementById('createProfilePic').style.backgroundSize = 'cover';
                document.getElementById('createProfilePic').style.backgroundPosition = 'center';
                document.getElementById('createProfilePic').textContent = '';
                
                document.getElementById('profilePicLarge').style.backgroundImage = `url(${userProfile.profileImage})`;
                document.getElementById('profilePicLarge').style.backgroundSize = 'cover';
                document.getElementById('profilePicLarge').style.backgroundPosition = 'center';
                document.getElementById('profilePicLarge').textContent = '';
                
                const commentProfilePic = document.getElementById('commentProfilePic');
                if (commentProfilePic) {
                    commentProfilePic.style.backgroundImage = `url(${userProfile.profileImage})`;
                    commentProfilePic.style.backgroundSize = 'cover';
                    commentProfilePic.style.backgroundPosition = 'center';
                    commentProfilePic.textContent = '';
                }
            } else {
                // ì´ë‹ˆì…œ ì‚¬ìš©
                document.getElementById('createProfilePic').style.backgroundImage = '';
                document.getElementById('createProfilePic').textContent = initials;
                
                document.getElementById('profilePicLarge').style.backgroundImage = '';
                document.getElementById('profilePicLarge').textContent = initials;
                
                const commentProfilePic = document.getElementById('commentProfilePic');
                if (commentProfilePic) {
                    commentProfilePic.style.backgroundImage = '';
                    commentProfilePic.textContent = initials;
                }
            }
            
            document.getElementById('profileName').textContent = currentUser;
            document.getElementById('editName').value = currentUser;
            
            document.getElementById('profileBio').textContent = userProfile.bio || 'ì•ˆë…•í•˜ì„¸ìš”! ê°€ì¡°ì¿ ì˜ ì¼ì›ì…ë‹ˆë‹¤ âœ¨';
            document.getElementById('editBio').value = userProfile.bio || 'ì•ˆë…•í•˜ì„¸ìš”! ê°€ì¡°ì¿ ì˜ ì¼ì›ì…ë‹ˆë‹¤ âœ¨';
        }

        function renderStories() {
            // 24ì‹œê°„ ì´ë‚´ ìŠ¤í† ë¦¬ë§Œ í‘œì‹œ
            const validStories = stories.filter(story => {
                const storyDate = new Date(story.date);
                const now = new Date();
                const hoursDiff = (now - storyDate) / (1000 * 60 * 60);
                return hoursDiff < 24;
            });

            // ì‚¬ìš©ìë³„ë¡œ ìŠ¤í† ë¦¬ ê·¸ë£¹í™”
            const storiesByUser = {};
            validStories.forEach(story => {
                if (!storiesByUser[story.author]) {
                    storiesByUser[story.author] = [];
                }
                storiesByUser[story.author].push(story);
            });

            let storiesHtml = '';

            // ë‚´ ìŠ¤í† ë¦¬ (í•­ìƒ ì²«ë²ˆì§¸)
            const myStories = storiesByUser[currentUser] || [];
            storiesHtml += `
                <div class="story-item" onclick="viewUserStories('${currentUser}')">
                    <div class="story-ring ${myStories.length > 0 ? '' : 'viewed'}">
                        <div class="story-pic">${currentUser.substring(0, 2)}</div>
                        ${myStories.length === 0 ? '<div class="story-badge" style="background: #405de6;">+</div>' : ''}
                    </div>
                    <div class="story-username">${myStories.length > 0 ? 'ë‚´ ìŠ¤í† ë¦¬' : 'ìŠ¤í† ë¦¬ ì¶”ê°€'}</div>
                </div>
            `;

            // ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì˜ ìŠ¤í† ë¦¬
            Object.keys(storiesByUser)
                .filter(user => user !== currentUser)
                .forEach(user => {
                    const userStories = storiesByUser[user];
                    storiesHtml += `
                        <div class="story-item" onclick="viewUserStories('${user}')">
                            <div class="story-ring">
                                <div class="story-pic">${user.substring(0, 2)}</div>
                            </div>
                            <div class="story-username">${user}</div>
                        </div>
                    `;
                });

            document.getElementById('storiesContainer').innerHTML = storiesHtml || `
                <div style="padding: 20px; text-align: center; color: #8e8e8e; width: 100%;">
                    ì²« ë²ˆì§¸ ìŠ¤í† ë¦¬ë¥¼ ì˜¬ë ¤ë³´ì„¸ìš”! ğŸ“¸
                </div>
            `;
        }

        function viewUserStories(userName) {
            if (userName === currentUser) {
                const myStories = stories.filter(story => story.author === currentUser);
                if (myStories.length === 0) {
                    // ìŠ¤í† ë¦¬ ì¶”ê°€
                    addStory();
                    return;
                }
            }
            
            const userStories = stories.filter(story => story.author === userName);
            if (userStories.length === 0) return;
            
            showStoryViewer(userStories, 0);
        }

        function showStoryViewer(userStories, currentIndex) {
            if (currentIndex >= userStories.length) return;
            
            const story = userStories[currentIndex];
            const timeAgo = formatTimeAgo(story.date);
            
            const content = `
                <div style="position: relative; background: black; border-radius: 12px; overflow: hidden; max-height: 80vh;">
                    <div style="position: absolute; top: 16px; left: 16px; right: 16px; z-index: 10; display: flex; align-items: center; gap: 12px;">
                        <div class="profile-pic" style="width: 32px; height: 32px; font-size: 12px;">${story.author.substring(0, 2)}</div>
                        <div>
                            <div style="color: white; font-weight: 600; font-size: 14px;">${story.author}</div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 12px;">${timeAgo}</div>
                        </div>
                        ${story.author === currentUser ? `
                            <button onclick="deleteStoryConfirm('${story.id}')" style="margin-left: auto; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer;">Ã—</button>
                        ` : ''}
                    </div>
                    
                    ${story.image ? `
                        <img src="${story.image}" style="width: 100%; height: auto; max-height: 60vh; object-fit: contain;" alt="ìŠ¤í† ë¦¬ ì´ë¯¸ì§€">
                    ` : ''}
                    
                    ${userStories.length > 1 ? `
                        <div style="position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px;">
                            ${currentIndex > 0 ? `
                                <button onclick="showStoryViewer(${JSON.stringify(userStories).replace(/"/g, '&quot;')}, ${currentIndex - 1})" style="background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer;">â€¹</button>
                            ` : ''}
                            ${currentIndex < userStories.length - 1 ? `
                                <button onclick="showStoryViewer(${JSON.stringify(userStories).replace(/"/g, '&quot;')}, ${currentIndex + 1})" style="background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer;">â€º</button>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('likesModalBody').innerHTML = content;
            document.getElementById('likesModal').querySelector('.modal-title').textContent = `${story.author}ë‹˜ì˜ ìŠ¤í† ë¦¬`;
            document.getElementById('likesModal').classList.add('active');
        }

        function addStory() {
            // ì—¬ëŸ¬ ì‚¬ì§„ ì„ íƒì´ ê°€ëŠ¥í•œ ìŠ¤í† ë¦¬ ì…ë ¥ìœ¼ë¡œ ì´ë™
            document.getElementById('storyImageInput').click();
        }

        function previewStoryImage(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const imageData = e.target.result;
                
                // ë¡œë”© í‘œì‹œ (ìŠ¤í† ë¦¬ ì»¨í…Œì´ë„ˆì—)
                const storiesContainer = document.getElementById('storiesContainer');
                const originalContent = storiesContainer.innerHTML;
                storiesContainer.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; width: 100%; padding: 20px; color: #405de6;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 8px;">ğŸ“·</div>
                            <div style="font-size: 12px;">ìŠ¤í† ë¦¬ ì—…ë¡œë“œ ì¤‘...</div>
                        </div>
                    </div>
                `;
                
                // ë°”ë¡œ ìŠ¤í† ë¦¬ ì—…ë¡œë“œ
                const story = {
                    id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                    author: currentUser,
                    content: '', // ì‚¬ì§„ë§Œ ìˆê³  í…ìŠ¤íŠ¸ ì—†ìŒ
                    image: imageData,
                    date: new Date().toISOString()
                };

                console.log('ìŠ¤í† ë¦¬ ìƒì„±:', story);

                try {
                    // Firebaseì— ì €ì¥ ì™„ë£Œê¹Œì§€ ëŒ€ê¸° (ë¡œì»¬ì— ì¦‰ì‹œ ì¶”ê°€í•˜ì§€ ì•ŠìŒ)
                    await FirebaseManager.addStory(story);
                    console.log('âœ… ìŠ¤í† ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    
                    // ì„±ê³µ ë©”ì‹œì§€ ì ì‹œ í‘œì‹œ
                    storiesContainer.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; width: 100%; padding: 20px; color: #405de6;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; margin-bottom: 8px;">âœ…</div>
                                <div style="font-size: 12px;">ìŠ¤í† ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                            </div>
                        </div>
                    `;
                    
                    // ì ì‹œ í›„ ì •ìƒ í™”ë©´ìœ¼ë¡œ ë³µêµ¬ (ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆê°€ ìë™ìœ¼ë¡œ UI ì—…ë°ì´íŠ¸)
                    setTimeout(() => {
                        renderStories();
                    }, 1000);
                    
                } catch (error) {
                    console.error('ìŠ¤í† ë¦¬ ì €ì¥ ì‹¤íŒ¨:', error);
                    // ì‹¤íŒ¨ì‹œ ì›ë˜ í™”ë©´ ë³µêµ¬
                    storiesContainer.innerHTML = originalContent;
                    alert('ìŠ¤í† ë¦¬ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            };
            reader.readAsDataURL(file);
            
            // ì…ë ¥ ì´ˆê¸°í™”
            input.value = '';
        }

        // ì—¬ëŸ¬ ìŠ¤í† ë¦¬ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜
        function previewMultipleStoryImages(input) {
            const files = Array.from(input.files);
            if (!files.length) return;

            selectedStoryImages = [];
            const previewContainer = document.getElementById('storyPreviewContainer');
            previewContainer.innerHTML = '';

            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    selectedStoryImages.push({
                        id: Date.now() + '_' + index,
                        file: file,
                        data: imageData
                    });

                    // ë¯¸ë¦¬ë³´ê¸° ì¶”ê°€
                    const previewItem = document.createElement('div');
                    previewItem.style.cssText = 'margin-bottom: 16px; border: 1px solid #dbdbdb; border-radius: 8px; overflow: hidden; position: relative;';
                    previewItem.innerHTML = `
                        <img src="${imageData}" style="width: 100%; height: 200px; object-fit: cover;">
                        <button onclick="removeStoryImage(${index})" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;">Ã—</button>
                        <div style="padding: 8px; font-size: 12px; color: #8e8e8e;">
                            ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)
                        </div>
                    `;
                    previewContainer.appendChild(previewItem);
                };
                reader.readAsDataURL(file);
            });

            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('multiStoryModal').classList.add('active');
            
            // ì…ë ¥ ì´ˆê¸°í™”
            input.value = '';
        }

        // ìŠ¤í† ë¦¬ ì´ë¯¸ì§€ ì œê±°
        function removeStoryImage(index) {
            selectedStoryImages.splice(index, 1);
            
            // ë¯¸ë¦¬ë³´ê¸° ë‹¤ì‹œ ë Œë”ë§
            const previewContainer = document.getElementById('storyPreviewContainer');
            previewContainer.innerHTML = '';
            
            selectedStoryImages.forEach((imageObj, newIndex) => {
                const previewItem = document.createElement('div');
                previewItem.style.cssText = 'margin-bottom: 16px; border: 1px solid #dbdbdb; border-radius: 8px; overflow: hidden; position: relative;';
                previewItem.innerHTML = `
                    <img src="${imageObj.data}" style="width: 100%; height: 200px; object-fit: cover;">
                    <button onclick="removeStoryImage(${newIndex})" style="position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer;">Ã—</button>
                    <div style="padding: 8px; font-size: 12px; color: #8e8e8e;">
                        ${imageObj.file.name} (${(imageObj.file.size / 1024 / 1024).toFixed(2)}MB)
                    </div>
                `;
                previewContainer.appendChild(previewItem);
            });

            // ëª¨ë“  ì´ë¯¸ì§€ê°€ ì œê±°ë˜ë©´ ëª¨ë‹¬ ë‹«ê¸°
            if (selectedStoryImages.length === 0) {
                closeMultiStoryModal();
            }
        }

        // ëª¨ë“  ìŠ¤í† ë¦¬ ì—…ë¡œë“œ
        async function uploadAllStories() {
            if (selectedStoryImages.length === 0) return;

            const uploadBtn = document.getElementById('uploadAllStoriesBtn');
            const originalText = uploadBtn.textContent;
            
            for (let i = 0; i < selectedStoryImages.length; i++) {
                const imageObj = selectedStoryImages[i];
                
                // ì§„í–‰ë¥  í‘œì‹œ
                uploadBtn.textContent = `ì—…ë¡œë“œ ì¤‘... (${i + 1}/${selectedStoryImages.length})`;
                uploadBtn.disabled = true;

                const story = {
                    id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                    author: currentUser,
                    content: '',
                    image: imageObj.data,
                    date: new Date().toISOString()
                };

                try {
                    await FirebaseManager.addStory(story);
                    console.log(`âœ… ìŠ¤í† ë¦¬ ${i + 1}/${selectedStoryImages.length} ì—…ë¡œë“œ ì™„ë£Œ`);
                    
                    // ì§§ì€ ì§€ì—°ì‹œê°„ (ë„ˆë¬´ ë¹ ë¥´ê²Œ ì—…ë¡œë“œë˜ì§€ ì•Šë„ë¡)
                    await new Promise(resolve => setTimeout(resolve, 500));
                } catch (error) {
                    console.error(`ìŠ¤í† ë¦¬ ${i + 1} ì—…ë¡œë“œ ì‹¤íŒ¨:`, error);
                    alert(`ìŠ¤í† ë¦¬ ${i + 1} ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`);
                    break;
                }
            }

            // ì™„ë£Œ
            uploadBtn.textContent = 'ì—…ë¡œë“œ ì™„ë£Œ!';
            uploadBtn.style.background = '#4caf50';
            
            setTimeout(() => {
                closeMultiStoryModal();
                uploadBtn.textContent = originalText;
                uploadBtn.disabled = false;
                uploadBtn.style.background = '#405de6';
            }, 1500);
        }

        // ë‹¤ì¤‘ ìŠ¤í† ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
        function closeMultiStoryModal() {
            document.getElementById('multiStoryModal').classList.remove('active');
            selectedStoryImages = [];
        }

        async function deleteStoryConfirm(storyId) {
            if (confirm('ìŠ¤í† ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await FirebaseManager.deleteStory(storyId);
                renderStories();
                closeLikesModal();
                console.log('âœ… ìŠ¤í† ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }

        function switchTab(tabName) {
            // [ìˆ˜ì •] 'ê²Œì‹œê¸€ ì‘ì„±' íƒ­ì„ ëˆŒë €ì„ ë•Œì˜ íŠ¹ë³„ ì²˜ë¦¬
            if (tabName === 'create') {
                // 1. ëª¨ë“  ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ì„ ì¼ë‹¨ ìˆ¨ê¹ë‹ˆë‹¤.
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // 2. 'ê²Œì‹œê¸€ ì‘ì„±' ì»¨í…ì¸  ì˜ì—­ë§Œ í™œì„±í™”í•©ë‹ˆë‹¤.
                document.getElementById('create').classList.add('active');
                
                // 3. í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ì•„ì´ì½˜ì˜ í™œì„± ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-tab="create"]`).classList.add('active');

                // 'ê²Œì‹œê¸€ ì‘ì„±' íƒ­ì€ íŠ¹ë³„í•œ ë°ì´í„° ë¡œë”©ì´ í•„ìš” ì—†ìœ¼ë¯€ë¡œ ì—¬ê¸°ì„œ í•¨ìˆ˜ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.
                return; 
            }

            // --- ê¸°ì¡´ ë¡œì§ì€ ê·¸ëŒ€ë¡œ ì‚¬ìš© ---
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ì´ì œ idê°€ 'create'ê°€ ì•„ë‹ˆë¯€ë¡œ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            const targetTab = document.getElementById(tabName);
            if (targetTab) {
                targetTab.classList.add('active');
            }

            if (tabName === 'search') {
                renderRanking();
            } else if (tabName === 'profile') {
                renderProfile();
            } else if (tabName === 'home') {
                renderStories();
            }
        }

        function selectPostType(type) {
            selectedPostType = type;
            
            document.querySelectorAll('.type-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-type="${type}"]`).classList.add('active');

            const meetingSelector = document.getElementById('meetingSelector');
            if (type === 'meeting') {
                meetingSelector.classList.add('active');
                document.getElementById('postContent').placeholder = 'ì˜¤ëŠ˜ ëˆ„êµ¬ì™€ ë§Œë‚¬ë‚˜ìš”? ì–´ë–¤ ì‹œê°„ì„ ë³´ë‚´ì…¨ë‚˜ìš”?';
                
                // ì˜¤ëŠ˜ ë‚ ì§œë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('meetingDate').value = today;
                
                // ì¹œêµ¬ ì²´í¬ë°•ìŠ¤ ë‹¤ì‹œ ìƒì„± (í˜¹ì‹œ ëˆ„ë½ë˜ì—ˆì„ ê²½ìš°)
                setupMeetingFriendCheckboxes();
            } else {
                meetingSelector.classList.remove('active');
                document.getElementById('postContent').placeholder = 'ì˜¤ëŠ˜ ì–´ë–¤ í•˜ë£¨ë¥¼ ë³´ë‚´ì…¨ë‚˜ìš”?';
            }
        }

        function setupMeetingFriendCheckboxes() {
            const friendCheckboxes = document.getElementById('friendCheckboxes');
            if (!friendCheckboxes) return;
            
            console.log('ì¹œêµ¬ ì²´í¬ë°•ìŠ¤ ìƒì„±:', friends.length, 'ëª…');
            
            const checkboxHtml = friends
                .filter(f => f.name !== currentUser)
                .map(f => `
                    <label style="display: flex; align-items: center; gap: 8px; padding: 6px; border: 1px solid #dbdbdb; border-radius: 6px; cursor: pointer; font-size: 12px;">
                        <input type="checkbox" value="${f.name}" onchange="updateSelectedFriends()" style="margin: 0;">
                        <span>${f.name}</span>
                    </label>
                `).join('');
            
            friendCheckboxes.innerHTML = checkboxHtml;
            console.log('ì¹œêµ¬ ì²´í¬ë°•ìŠ¤ ìƒì„± ì™„ë£Œ');
        }

        function previewImage(input) {
            const file = input.files[0];
            if (!file) return;

            // iOS Safarië¥¼ ìœ„í•œ ì´ë¯¸ì§€ ì••ì¶• ì²˜ë¦¬
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    // ìº”ë²„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ í¬ê¸° ì••ì¶•
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // ìµœëŒ€ í¬ê¸° ì„¤ì • (iOS Safari í˜¸í™˜ì„±ì„ ìœ„í•´)
                    const maxWidth = 800;
                    const maxHeight = 600;
                    
                    let { width, height } = img;
                    
                    // ë¹„ìœ¨ ìœ ì§€í•˜ë©´ì„œ í¬ê¸° ì¡°ì •
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // ì••ì¶•ëœ ì´ë¯¸ì§€ ë°ì´í„° ìƒì„± (í’ˆì§ˆ 0.8)
                    currentImageData = canvas.toDataURL('image/jpeg', 0.8);
                    
                    // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                    document.getElementById('imagePreview').innerHTML = `
                        <div class="image-preview">
                            <img src="${currentImageData}" class="preview-img" alt="ë¯¸ë¦¬ë³´ê¸°">
                            <button class="remove-img" onclick="removeImage()">&times;</button>
                        </div>
                    `;
                    
                    console.log('ì´ë¯¸ì§€ ì••ì¶• ì™„ë£Œ:', currentImageData.length, 'ë°”ì´íŠ¸');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function removeImage() {
            currentImageData = null;
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('imageInput').value = '';
        }

        async function createPost() {
            // ì¤‘ë³µ ìƒì„± ë°©ì§€
            if (isCreatingPost) {
                console.log('ì´ë¯¸ ê²Œì‹œë¬¼ ìƒì„± ì¤‘...');
                return;
            }

            console.log('ê²Œì‹œë¬¼ ì‘ì„± ì‹œì‘');
            const content = document.getElementById('postContent').value.trim();
            
            if (!content) {
                alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }

            if (selectedPostType === 'meeting') {
                const checkboxes = document.querySelectorAll('#friendCheckboxes input[type="checkbox"]:checked');
                const selectedFriends = Array.from(checkboxes).map(cb => cb.value);
                const meetingDate = document.getElementById('meetingDate').value;
                
                if (selectedFriends.length === 0) {
                    alert('ë§Œë‚œ ì¹œêµ¬ë¥¼ ìµœì†Œ 1ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”!');
                    return;
                }
                
                if (!meetingDate) {
                    alert('ë§Œë‚œ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                    return;
                }
                
                // ë§Œë‚¨ ì¤‘ë³µ ê²€ì‚¬
                const meetingParticipants = [currentUser, ...selectedFriends].sort();
                const existingMeeting = posts.find(post => {
                    if (post.type !== 'meeting') return false;
                    if (!post.meetingDate) return false;
                    
                    const postDate = post.meetingDate.split('T')[0]; // YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    if (postDate !== meetingDate) return false;
                    
                    const postParticipants = [post.author, ...(post.partners || [])].sort();
                    return JSON.stringify(meetingParticipants) === JSON.stringify(postParticipants);
                });
                
                if (existingMeeting) {
                    alert(`${meetingDate}ì— ê°™ì€ ì¹œêµ¬ë“¤ê³¼ì˜ ë§Œë‚¨ì´ ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤!\nê¸°ì¡´ ê²Œì‹œë¬¼: "${existingMeeting.content.substring(0, 50)}..."`);
                    return;
                }
            }

            // ì¤‘ë³µ ìƒì„± ë°©ì§€ í”Œë˜ê·¸ ì„¤ì •
            isCreatingPost = true;

            // ë²„íŠ¼ ìƒíƒœ ì €ì¥ ë° ë¹„í™œì„±í™”
            const postBtn = document.querySelector('.post-btn');
            const originalBtnText = postBtn.textContent;
            postBtn.textContent = 'ì—…ë¡œë“œ ì¤‘...';
            postBtn.disabled = true;
            postBtn.style.background = '#c7c7c7';

            // ê³ ìœ  ID ìƒì„± (ë” ì•ˆì „í•œ ë°©ë²•)
            const postId = Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9);

            const post = {
                id: postId,
                author: currentUser,
                content: content,
                type: selectedPostType,
                partners: selectedPostType === 'meeting' ? 
                    Array.from(document.querySelectorAll('#friendCheckboxes input[type="checkbox"]:checked')).map(cb => cb.value) : 
                    null,
                meetingDate: selectedPostType === 'meeting' ? document.getElementById('meetingDate').value : null,
                image: currentImageData,
                likes: [],
                date: new Date().toISOString()
            };

            console.log('ìƒì„±ëœ ê²Œì‹œë¬¼:', post);

            // iOS Safariì—ì„œëŠ” Firebase ëŒ€ì‹  ì¦‰ì‹œ ë¡œì»¬ ì €ì¥
            try {
                // ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš° í¬ê¸° ì²´í¬
                if (currentImageData && currentImageData.length > 1000000) { // 1MB ì´ìƒ
                    console.log('ì´ë¯¸ì§€ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. ì¶”ê°€ ì••ì¶• ì¤‘...');
                    // ì¶”ê°€ ì••ì¶•
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        // ë” ì‘ì€ í¬ê¸°ë¡œ ì••ì¶•
                        const maxWidth = 600;
                        const maxHeight = 400;
                        
                        let { width, height } = img;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // ë” ë‚®ì€ í’ˆì§ˆë¡œ ì••ì¶•
                        post.image = canvas.toDataURL('image/jpeg', 0.6);
                        
                        // ì••ì¶•ëœ ì´ë¯¸ì§€ë¡œ ê²Œì‹œë¬¼ ì €ì¥
                        savePostToLocal(post, postBtn, originalBtnText);
                    };
                    img.src = currentImageData;
                } else {
                    // ì´ë¯¸ì§€ê°€ ì—†ê±°ë‚˜ í¬ê¸°ê°€ ì ë‹¹í•œ ê²½ìš° ë°”ë¡œ ì €ì¥
                    savePostToLocal(post, postBtn, originalBtnText);
                }
                
            } catch (error) {
                console.error('ê²Œì‹œë¬¼ ì €ì¥ ì‹¤íŒ¨:', error);
                
                // ì‹¤íŒ¨ì‹œì—ë„ ê¸°ë³¸ ì²˜ë¦¬
                postBtn.textContent = 'ì—…ë¡œë“œ ì™„ë£Œ';
                postBtn.style.background = '#4caf50';
                
                setTimeout(() => {
                    // ë²„íŠ¼ ìƒíƒœ ë³µì›
                    postBtn.textContent = originalBtnText;
                    postBtn.disabled = false;
                    postBtn.style.background = '#405de6';
                    
                    // ì¤‘ë³µ ìƒì„± ë°©ì§€ í”Œë˜ê·¸ í•´ì œ
                    isCreatingPost = false;
                    
                    switchTab('home');
                }, 1000);
            }
        }
        
        // ê²Œì‹œë¬¼ ë¡œì»¬ ì €ì¥ í•¨ìˆ˜ ë¶„ë¦¬
        function savePostToLocal(post, postBtn, originalBtnText) {
            // ì¦‰ì‹œ ë¡œì»¬ì— ì¶”ê°€
            posts.unshift(post);
            renderPostFeed();
            
            // iOS Safariì—ì„œ Firebase ì €ì¥ì€ ë°±ê·¸ë¼ìš´ë“œë¡œ ì²˜ë¦¬
            if (db) {
                setTimeout(() => {
                    FirebaseManager.addPost(post).catch(err => {
                        console.log('Firebase ì €ì¥ ì‹¤íŒ¨í•˜ì§€ë§Œ ë¡œì»¬ì—ëŠ” ì €ì¥ë¨:', err);
                    });
                }, 100);
            } else {
                // Firebase ì—†ìœ¼ë©´ localStorageì— ì €ì¥
                localStorage.setItem('posts', JSON.stringify(posts));
            }
            
            // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
            postBtn.textContent = 'ì—…ë¡œë“œ ì™„ë£Œ!';
            postBtn.style.background = '#4caf50';
            
            // í¼ ì™„ì „ ì´ˆê¸°í™”
            setTimeout(() => {
                document.getElementById('postContent').value = '';
                document.querySelectorAll('#friendCheckboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
                updateSelectedFriends();
                
                // ë‚ ì§œ ì´ˆê¸°í™”
                if (selectedPostType === 'meeting') {
                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('meetingDate').value = today;
                }
                
                // ì´ë¯¸ì§€ ì™„ì „ ì œê±°
                currentImageData = null;
                document.getElementById('imagePreview').innerHTML = '';
                document.getElementById('imageInput').value = '';
                
                // í¬ìŠ¤íŠ¸ íƒ€ì… ì´ˆê¸°í™”
                selectedPostType = 'diary';
                document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelector('[data-type="diary"]').classList.add('active');
                document.getElementById('meetingSelector').classList.remove('active');
                document.getElementById('postContent').placeholder = 'ì˜¤ëŠ˜ ì–´ë–¤ í•˜ë£¨ë¥¼ ë³´ë‚´ì…¨ë‚˜ìš”?';
                
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                postBtn.textContent = originalBtnText;
                postBtn.disabled = false;
                postBtn.style.background = '#405de6';
                
                // ì¤‘ë³µ ìƒì„± ë°©ì§€ í”Œë˜ê·¸ í•´ì œ
                isCreatingPost = false;
                
                console.log('âœ… í¼ ì´ˆê¸°í™” ì™„ë£Œ');
                
                // ê²Œì‹œê¸€ ì‘ì„± í›„ í™ˆ íƒ­ìœ¼ë¡œ ì´ë™
                switchTab('home');
            }, 1000);
        }

        function renderPostFeed() {
            const feed = document.getElementById('postFeed');
            
            feed.innerHTML = posts.map(post => {
                const authorProfile = profiles[post.author] || {};
                const authorProfilePic = authorProfile.profileImage ? 
                    `style="background-image: url(${authorProfile.profileImage}); background-size: cover; background-position: center;"` :
                    ``;
                const authorInitials = authorProfile.profileImage ? '' : post.author.substring(0, 2);
                
                // ëŒ“ê¸€ ë¯¸ë¦¬ë³´ê¸° (ìµœëŒ€ 2ê°œ)
                const postComments = comments[post.id] || [];
                const previewComments = postComments.slice(0, 2);
                const remainingComments = postComments.length - 2;
                
                return `
                <div class="post">
                    <div class="post-header">
                        <div class="post-user">
                            <div class="profile-pic" ${authorProfilePic}>${authorInitials}</div>
                            <div class="user-info">
                                <h4>${post.author}</h4>
                                <div class="post-time">${formatTimeAgo(post.date)}</div>
                            </div>
                        </div>
                        ${post.author === currentUser ? `
                            <button class="delete-btn" onclick="deletePost('${post.id}')">ì‚­ì œ</button>
                        ` : ''}
                    </div>
                    
                    ${post.image ? `
                        <img src="${post.image}" class="post-image" alt="ê²Œì‹œë¬¼ ì´ë¯¸ì§€">
                    ` : ''}
                    
                    <div class="post-content" style="padding: 12px 16px; order: 1;">
                        <span class="username">${post.author}</span>
                        ${post.content}
                        ${post.type === 'meeting' ? ' ğŸ‘¥' : ' ğŸ“'}
                        ${post.type === 'meeting' && post.meetingDate ? 
                            `<div style="font-size: 12px; color: #8e8e8e; margin-top: 4px;">ğŸ“… ${formatMeetingDate(post.meetingDate)}</div>` : 
                            ''}
                    </div>
                    
                    <div class="post-actions" style="order: 2;">
                        <button class="action-btn ${post.likes.includes(currentUser) ? 'liked' : ''}" 
                                onclick="toggleLike('${post.id}')">
                            ${post.likes.includes(currentUser) ? 'â¤ï¸' : 'ğŸ¤'}
                        </button>
                        <button class="action-btn" onclick="openCommentModal('${post.id}')">ğŸ’¬</button>
                    </div>
                    
                    ${post.likes.length > 0 ? `
                        <div class="post-likes" style="order: 3;" onclick="showLikes('${post.id}')">
                            ì¢‹ì•„ìš” ${post.likes.length}ê°œ
                        </div>
                    ` : ''}
                    
                    ${postComments.length > 0 ? `
                        <div style="padding: 0 16px; margin-bottom: 8px; order: 4;">
                            ${remainingComments > 0 ? `
                                <div style="color: #8e8e8e; font-size: 14px; cursor: pointer; margin-bottom: 8px;" onclick="openCommentModal('${post.id}')">
                                    ëŒ“ê¸€ ${postComments.length}ê°œ ëª¨ë‘ ë³´ê¸°
                                </div>
                            ` : ''}
                            ${previewComments.map(comment => {
                                const commentAuthorProfile = profiles[comment.author] || {};
                                return `
                                    <div style="display: flex; gap: 8px; margin-bottom: 6px; font-size: 14px;">
                                        <span style="font-weight: 600;">${comment.author}</span>
                                        <span>${comment.text}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
            }).join('');
        }

        async function toggleLike(postId) {
            console.log('ì¢‹ì•„ìš” í´ë¦­:', postId);
            
            const post = posts.find(p => p.id === postId);
            if (!post) {
                console.error('ê²Œì‹œë¬¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', postId);
                return;
            }

            const likeIndex = post.likes.indexOf(currentUser);
            let updatedLikes;
            
            if (likeIndex > -1) {
                updatedLikes = post.likes.filter(user => user !== currentUser);
                console.log('ì¢‹ì•„ìš” ì·¨ì†Œ');
            } else {
                updatedLikes = [...post.likes, currentUser];
                console.log('ì¢‹ì•„ìš” ì¶”ê°€');
            }

            // ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸ (ë‚™ê´€ì  ì—…ë°ì´íŠ¸)
            post.likes = updatedLikes;
            renderPostFeed();
            renderProfile();

            // Firebase ì—…ë°ì´íŠ¸
            try {
                await FirebaseManager.updatePost(postId, { likes: updatedLikes });
                console.log('âœ… ì¢‹ì•„ìš” ì—…ë°ì´íŠ¸ ì™„ë£Œ');
            } catch (error) {
                console.error('ì¢‹ì•„ìš” ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                // ì‹¤íŒ¨ ì‹œ ì›ë˜ ìƒíƒœë¡œ ë³µêµ¬
                if (likeIndex > -1) {
                    post.likes = [...post.likes, currentUser];
                } else {
                    post.likes = post.likes.filter(user => user !== currentUser);
                }
                renderPostFeed();
                renderProfile();
            }
        }

        async function deletePost(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) return;

            if (post.author !== currentUser) {
                alert('ìì‹ ì˜ ê²Œì‹œë¬¼ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!');
                return;
            }

            if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                await FirebaseManager.deletePost(postId);
                console.log('âœ… ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }

        function showLikes(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post || post.likes.length === 0) return;

            const likesHtml = post.likes.map(user => `
                <div style="display: flex; align-items: center; gap: 12px; padding: 8px 0;">
                    <div class="profile-pic">${user.substring(0, 2)}</div>
                    <div style="font-weight: 500;">${user}</div>
                </div>
            `).join('');

            document.getElementById('likesModalBody').innerHTML = likesHtml;
            document.getElementById('likesModal').querySelector('.modal-title').textContent = 'ì¢‹ì•„ìš”';
            document.getElementById('likesModal').classList.add('active');
        }

        function closeLikesModal() {
            document.getElementById('likesModal').classList.remove('active');
        }

        function showRankingTab(tab) {
            currentRankingTab = tab;
            
            document.querySelectorAll('.search-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="showRankingTab('${tab}')"]`).classList.add('active');
            
            renderRanking();
        }

        function renderRanking() {
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            let content = '';

            if (currentRankingTab === 'meeting') {
                const monthlyMeetings = posts.filter(post => {
                    const postDate = new Date(post.date);
                    return post.type === 'meeting' && 
                           postDate.getMonth() === currentMonth && 
                           postDate.getFullYear() === currentYear;
                });

                const meetingCounts = {};
                friends.forEach(friend => meetingCounts[friend.name] = 0);

                monthlyMeetings.forEach(post => {
                    meetingCounts[post.author]++;
                    if (post.partner) {
                        meetingCounts[post.partner]++;
                    }
                });

                const meetingRanking = Object.entries(meetingCounts)
                    .map(([name, count]) => ({ name, count }))
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 10);

                content = `
                    <div class="ranking-card">
                        <div class="ranking-title">ğŸ‘¥ ì´ë²ˆë‹¬ ë§Œë‚¨í‚¹ ë­í‚¹</div>
                        ${meetingRanking.map((item, index) => `
                            <div class="ranking-item">
                                <span class="rank-position">${index + 1}ìœ„</span>
                                <span>${item.name}</span>
                                <span>${item.count}ë²ˆ</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (currentRankingTab === 'popular') {
                const monthlyPosts = posts.filter(post => {
                    const postDate = new Date(post.date);
                    return postDate.getMonth() === currentMonth && 
                           postDate.getFullYear() === currentYear;
                });

                const popularPosts = monthlyPosts
                    .sort((a, b) => b.likes.length - a.likes.length)
                    .slice(0, 5);

                content = `
                    <div class="ranking-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <div class="ranking-title">ğŸ”¥ ì´ë²ˆë‹¬ ì¸ê¸°ê¸€ TOP 5</div>
                        ${popularPosts.map((post, index) => `
                            <div class="ranking-item" style="flex-direction: column; align-items: stretch; padding: 12px 0;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span class="rank-position">${index + 1}ìœ„</span>
                                    <span>${post.author}</span>
                                    <span>â¤ï¸ ${post.likes.length}</span>
                                </div>
                                <div style="font-size: 12px; opacity: 0.8; line-height: 1.3;">
                                    ${post.content.length > 50 ? post.content.substring(0, 50) + '...' : post.content}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else if (currentRankingTab === 'biho') {
                const now = new Date();
                const currentMonth = `${now.getFullYear()}-${now.getMonth()}`;
                
                // Firebaseì—ì„œ ìµœì‹  íˆ¬í‘œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë¹„ë™ê¸°)
                FirebaseManager.getBihoVotes().catch(err => {
                    console.log('íˆ¬í‘œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨, ë¡œì»¬ ë°ì´í„° ì‚¬ìš©');
                });
                
                if (!bihoVotes[currentMonth]) {
                    initializeBihoVotes();
                }
                
                const currentVotes = bihoVotes[currentMonth] || { votes: {}, voters: {} };
                const bihoRanking = Object.entries(currentVotes.votes || {})
                    .map(([name, votes]) => ({ name, votes }))
                    .sort((a, b) => b.votes - a.votes);

                const hasVoted = currentVotes.voters && currentVotes.voters[currentUser];

                content = `
                    <div class="ranking-card" style="background: linear-gradient(135deg, #e91e63 0%, #ad1457 100%);">
                        <div class="ranking-title">ğŸ‘‘ ì´ë²ˆë‹¬ ì™•ë¹„í˜¸ ë­í‚¹</div>
                        <div style="text-align: center; margin-bottom: 16px; font-size: 12px; opacity: 0.8;">
                            ${now.getMonth() + 1}ì›” ì™•ë¹„í˜¸ íˆ¬í‘œ í˜„í™©
                        </div>
                        ${bihoRanking.filter(item => item.votes > 0).length === 0 ? `
                            <div style="text-align: center; padding: 20px; opacity: 0.7;">
                                ì•„ì§ íˆ¬í‘œê°€ ì—†ì–´ìš”<br>ì²« íˆ¬í‘œì˜ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”! ğŸ˜ˆ
                            </div>
                        ` : bihoRanking.filter(item => item.votes > 0).map((item, index) => `
                            <div class="ranking-item">
                                <div style="display: flex; align-items: center;">
                                    <span class="rank-position">${index + 1}ìœ„</span>
                                    ${index === 0 ? '<span class="biho-crown">ğŸ‘‘</span>' : ''}
                                    <span>${item.name}</span>
                                </div>
                                <span>${item.votes}í‘œ</span>
                            </div>
                        `).join('')}
                        
                        <div style="text-align: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.2);">
                            ${hasVoted ? 
                                '<span style="font-size: 12px; opacity: 0.7;">ì´ë²ˆë‹¬ íˆ¬í‘œ ì™„ë£Œ! ğŸ‘</span>' : 
                                '<button class="vote-btn" onclick="openBihoVoteModal()">íˆ¬í‘œí•˜ëŸ¬ ê°€ê¸°</button>'
                            }
                        </div>
                    </div>
                `;
            } else if (currentRankingTab === 'gallery') {
                // ê²Œì‹œê¸€ì˜ ì‚¬ì§„ë“¤ê³¼ ì‚¬ì§„ì²© ì „ìš© ì‚¬ì§„ë“¤ í•©ì¹˜ê¸°
                const postPhotos = posts.filter(post => post.image).map(post => ({
                    id: post.id,
                    image: post.image,
                    author: post.author,
                    date: post.date,
                    likes: post.likes,
                    content: post.content,
                    type: 'post'
                }));
                
                const allPhotos = [...galleryPhotos.map(photo => ({...photo, type: 'gallery'})), ...postPhotos]
                    .sort((a, b) => new Date(b.date) - new Date(a.date));
                
                if (allPhotos.length === 0) {
                    content = `
                        <div class="ranking-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div class="ranking-title">ğŸ“¸ ê°€ì¡°ì¿  ì‚¬ì§„ì²©</div>
                            <div style="text-align: center; padding: 20px;">
                                <button onclick="addPhotoToGallery()" style="background: #405de6; color: white; border: none; border-radius: 8px; padding: 12px 24px; font-size: 14px; cursor: pointer; margin-bottom: 16px;">
                                    ğŸ“· ì‚¬ì§„ ì¶”ê°€í•˜ê¸°
                                </button>
                                <div style="opacity: 0.7;">
                                    ì²« ë²ˆì§¸ ì‚¬ì§„ì„ ì¶”ê°€í•´ë³´ì„¸ìš”!
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    content = `
                        <div class="ranking-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div class="ranking-title">ğŸ“¸ ê°€ì¡°ì¿  ì‚¬ì§„ì²© (${allPhotos.length}ì¥)</div>
                                <button onclick="addPhotoToGallery()" style="background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 12px; cursor: pointer;">
                                    + ì¶”ê°€
                                </button>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 16px;">
                            ${allPhotos.map(photo => `
                                <div style="aspect-ratio: 1; position: relative; overflow: hidden; border-radius: 8px; cursor: pointer;" onclick="viewPhoto('${photo.id}', '${photo.type}')">
                                    <img src="${photo.image}" style="width: 100%; height: 100%; object-fit: cover;" alt="${photo.author}ì˜ ì‚¬ì§„">
                                    <div style="position: absolute; bottom: 4px; right: 4px; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">
                                        ${photo.type === 'gallery' ? 'ğŸ“·' : 'ğŸ“'} ${photo.likes ? photo.likes.length : 0}
                                    </div>
                                    ${photo.author === currentUser ? `
                                        <div style="position: absolute; top: 4px; right: 4px; background: rgba(255,0,0,0.7); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center;" onclick="event.stopPropagation(); deletePhoto('${photo.id}', '${photo.type}')">
                                            Ã—
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
            } else if (currentRankingTab === 'stats') {
                const totalPosts = posts.length;
                const totalMeetings = posts.filter(p => p.type === 'meeting').length;
                const totalLikes = posts.reduce((sum, p) => sum + p.likes.length, 0);
                const mostActiveUser = friends.reduce((max, friend) => {
                    const friendPosts = posts.filter(p => p.author === friend.name).length;
                    return friendPosts > max.count ? { name: friend.name, count: friendPosts } : max;
                }, { name: '', count: 0 });

                content = `
                    <div class="ranking-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <div class="ranking-title">ğŸ“Š ê°€ì¡°ì¿  ì „ì²´ í†µê³„</div>
                        <div class="ranking-item">
                            <span>ì´ ê²Œì‹œë¬¼</span>
                            <span>${totalPosts}ê°œ</span>
                        </div>
                        <div class="ranking-item">
                            <span>ì´ ë§Œë‚¨</span>
                            <span>${totalMeetings}ë²ˆ</span>
                        </div>
                        <div class="ranking-item">
                            <span>ì´ ì¢‹ì•„ìš”</span>
                            <span>${totalLikes}ê°œ</span>
                        </div>
                        <div class="ranking-item">
                            <span>ìµœê³  í™œë™ëŸ¬</span>
                            <span>${mostActiveUser.name} (${mostActiveUser.count}ê°œ)</span>
                        </div>
                    </div>
                `;
            }

            document.getElementById('rankingContent').innerHTML = content;
        }

        function viewPhoto(photoId, photoType) {
            let photo;
            
            if (photoType === 'gallery') {
                photo = galleryPhotos.find(p => p.id === photoId);
            } else {
                photo = posts.find(p => p.id === photoId);
            }
            
            if (!photo || !photo.image) return;

            const content = `
                <div style="text-align: center;">
                    <img src="${photo.image}" style="width: 100%; max-height: 400px; object-fit: contain; border-radius: 8px; margin-bottom: 16px;" alt="ì‚¬ì§„">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; justify-content: center;">
                        <div class="profile-pic" style="width: 24px; height: 24px; font-size: 10px;">${photo.author.substring(0, 2)}</div>
                        <span style="font-weight: 600;">${photo.author}</span>
                        <span style="color: #8e8e8e; font-size: 12px;">${formatTimeAgo(photo.date)}</span>
                        ${photoType === 'gallery' ? '<span style="background: #405de6; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">ğŸ“· ì‚¬ì§„ì²©</span>' : '<span style="background: #5cb85c; color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px;">ğŸ“ ê²Œì‹œê¸€</span>'}
                    </div>
                    ${photo.content ? `
                        <div style="text-align: left; background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            ${photo.content}
                        </div>
                    ` : ''}
                    <div style="display: flex; justify-content: center; gap: 16px;">
                        <span style="color: #e91e63;">â¤ï¸ ${photo.likes ? photo.likes.length : 0}</span>
                        ${photoType === 'post' ? `<span style="color: #8e8e8e;">ğŸ’¬ ${comments[photo.id] ? comments[photo.id].length : 0}</span>` : ''}
                    </div>
                </div>
            `;

            document.getElementById('likesModalBody').innerHTML = content;
            document.getElementById('likesModal').querySelector('.modal-title').textContent = 'ì‚¬ì§„ ìƒì„¸ë³´ê¸°';
            document.getElementById('likesModal').classList.add('active');
        }

        function addPhotoToGallery() {
            document.getElementById('galleryImageInput').click();
        }

        function previewGalleryImage(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const imageData = e.target.result;
                
                if (confirm('ì´ ì‚¬ì§„ì„ ì‚¬ì§„ì²©ì— ì¶”ê°€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    // ë¡œë”© í‘œì‹œ
                    const loadingHtml = document.getElementById('rankingContent').innerHTML;
                    document.getElementById('rankingContent').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #405de6;">
                            <div style="font-size: 24px; margin-bottom: 16px;">ğŸ“·</div>
                            <div>ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ëŠ” ì¤‘...</div>
                        </div>
                    `;
                    
                    const photo = {
                        id: Date.now().toString() + '_' + Math.random().toString(36).substr(2, 9),
                        author: currentUser,
                        image: imageData,
                        content: '', // ì‚¬ì§„ì²©ì€ ë‚´ìš© ì—†ìŒ
                        likes: [],
                        date: new Date().toISOString()
                    };

                    try {
                        // Firebaseì— ì €ì¥ ì™„ë£Œê¹Œì§€ ëŒ€ê¸°
                        await FirebaseManager.addGalleryPhoto(photo);
                        console.log('âœ… ì‚¬ì§„ì²¨ì— ì‚¬ì§„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        
                        // ì„±ê³µ ë©”ì‹œì§€
                        document.getElementById('rankingContent').innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #405de6;">
                                <div style="font-size: 24px; margin-bottom: 16px;">âœ…</div>
                                <div>ì‚¬ì§„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
                            </div>
                        `;
                        
                        // ì ì‹œ í›„ ì •ìƒ í™”ë©´ìœ¼ë¡œ ë³µêµ¬ (ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆê°€ ìë™ìœ¼ë¡œ UI ì—…ë°ì´íŠ¸)
                        setTimeout(() => {
                            if (currentRankingTab === 'gallery') {
                                renderRanking();
                            }
                        }, 1000);
                        
                    } catch (error) {
                        console.error('ì‚¬ì§„ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
                        // ì‹¤íŒ¨ì‹œ ì›ë˜ í™”ë©´ ë³µêµ¬
                        document.getElementById('rankingContent').innerHTML = loadingHtml;
                        alert('ì‚¬ì§„ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    }
                }
            };
            reader.readAsDataURL(file);
            
            // ì…ë ¥ ì´ˆê¸°í™”
            input.value = '';
        }

        async function deletePhoto(photoId, photoType) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            if (photoType === 'gallery') {
                await FirebaseManager.deleteGalleryPhoto(photoId);
                console.log('âœ… ì‚¬ì§„ì²© ì‚¬ì§„ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } else {
                await FirebaseManager.deletePost(photoId);
                console.log('âœ… ê²Œì‹œë¬¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
            
            // UI ì—…ë°ì´íŠ¸
            if (currentRankingTab === 'gallery') {
                renderRanking();
            }
        }

        function renderProfile() {
            const userPosts = posts.filter(post => post.author === currentUser);
            const userMeetings = posts.filter(post => 
                post.type === 'meeting' && (post.author === currentUser || post.partner === currentUser)
            );
            const userLikes = posts.reduce((total, post) => {
                return total + (post.author === currentUser ? post.likes.length : 0);
            }, 0);

            document.getElementById('postCount').textContent = userPosts.length;
            document.getElementById('meetingCount').textContent = userMeetings.length;
            document.getElementById('likeCount').textContent = userLikes;

            document.getElementById('myPosts').innerHTML = `
                <div style="padding: 16px;">
                    <h3 style="margin-bottom: 16px; text-align: center;">ë‚´ ê²Œì‹œë¬¼</h3>
                    ${userPosts.length === 0 ? `
                        <div style="text-align: center; color: #8e8e8e; margin: 40px 0;">
                            ì•„ì§ ê²Œì‹œë¬¼ì´ ì—†ì–´ìš”<br>
                            ì²« ë²ˆì§¸ ê²Œì‹œë¬¼ì„ ì‘ì„±í•´ë³´ì„¸ìš”!
                        </div>
                    ` : userPosts.map(post => `
                        <div class="post" style="margin-bottom: 16px;">
                            <div class="post-header">
                                <div class="post-user">
                                    <div class="profile-pic">${post.author.substring(0, 2)}</div>
                                    <div class="user-info">
                                        <h4>${post.author}</h4>
                                        <div class="post-time">${formatTimeAgo(post.date)}</div>
                                    </div>
                                </div>
                                <button class="delete-btn" onclick="deletePost('${post.id}')">ì‚­ì œ</button>
                            </div>
                            
                            ${post.image ? `
                                <img src="${post.image}" class="post-image" alt="ê²Œì‹œë¬¼ ì´ë¯¸ì§€">
                            ` : ''}
                            
                            <div class="post-actions">
                                <button class="action-btn ${post.likes.includes(currentUser) ? 'liked' : ''}" 
                                        onclick="toggleLike('${post.id}')">
                                    ${post.likes.includes(currentUser) ? 'â¤ï¸' : 'ğŸ¤'}
                                </button>
                            </div>
                            
                            ${post.likes.length > 0 ? `
                                <div class="post-likes" onclick="showLikes('${post.id}')">
                                    ì¢‹ì•„ìš” ${post.likes.length}ê°œ
                                </div>
                            ` : ''}
                            
                            <div class="post-content">
                                <span class="username">${post.author}</span>
                                ${post.type === 'meeting' && post.partner ? 
                                    `<span style="color: #405de6;">@${post.partner}</span>ì™€ í•¨ê»˜ ` : ''}
                                ${post.content}
                                ${post.type === 'meeting' ? ' ğŸ‘¥' : ' ğŸ“'}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ëŒ“ê¸€ ê¸°ëŠ¥
        function openCommentModal(postId) {
            currentPostId = postId;
            const post = posts.find(p => p.id === postId);
            if (!post) return;

            renderComments(postId);
            document.getElementById('commentModal').classList.add('active');
            
            document.getElementById('commentProfilePic').textContent = currentUser.substring(0, 2);
        }

        function closeCommentModal() {
            document.getElementById('commentModal').classList.remove('active');
            document.getElementById('commentInput').value = '';
            currentPostId = null;
        }

        function renderComments(postId) {
            const postComments = comments[postId] || [];
            const commentsHtml = postComments.map(comment => {
                const commentAuthorProfile = profiles[comment.author] || {};
                const commentAuthorProfilePic = commentAuthorProfile.profileImage ? 
                    `style="background-image: url(${commentAuthorProfile.profileImage}); background-size: cover; background-position: center;"` :
                    ``;
                const commentAuthorInitials = commentAuthorProfile.profileImage ? '' : comment.author.substring(0, 2);
                
                return `
                <div class="comment-item">
                    <div class="profile-pic" ${commentAuthorProfilePic}>${commentAuthorInitials}</div>
                    <div class="comment-content">
                        <div class="comment-author">${comment.author}</div>
                        <div class="comment-text">${comment.text}</div>
                        <div class="comment-time">${formatTimeAgo(comment.date)}</div>
                    </div>
                    ${comment.author === currentUser ? `
                        <button class="comment-delete" onclick="deleteComment('${postId}', '${comment.id}')">ì‚­ì œ</button>
                    ` : ''}
                </div>
            `;
            }).join('');

            document.getElementById('commentsList').innerHTML = postComments.length === 0 ? 
                '<div style="text-align: center; color: #8e8e8e; padding: 20px;">ì²« ë²ˆì§¸ ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</div>' : 
                commentsHtml;
        }

        async function addComment() {
            if (!currentPostId) return;
            
            const commentText = document.getElementById('commentInput').value.trim();
            if (!commentText) return;

            const comment = {
                id: Date.now().toString(),
                author: currentUser,
                text: commentText,
                date: new Date().toISOString()
            };

            await FirebaseManager.addComment(currentPostId, comment);

            document.getElementById('commentInput').value = '';
            console.log('âœ… ëŒ“ê¸€ì´ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        async function deleteComment(postId, commentId) {
            try {
                if (db) {
                    await db.collection('comments').doc(commentId).delete();
                } else {
                    if (comments[postId]) {
                        comments[postId] = comments[postId].filter(c => c.id !== commentId);
                        localStorage.setItem('comments', JSON.stringify(comments));
                        renderComments(postId);
                        renderPostFeed();
                    }
                }
                console.log('âœ… ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('ëŒ“ê¸€ ì‚­ì œ ì‹¤íŒ¨:', error);
            }
        }

        function handleCommentKeyPress(event) {
            if (event.key === 'Enter') {
                addComment();
            }
        }

        // ì™•ë¹„í˜¸ íˆ¬í‘œ í•¨ìˆ˜ë“¤
        async function openBihoVoteModal() {
            const now = new Date();
            const currentMonth = `${now.getFullYear()}-${now.getMonth()}`;
            
            // Firebaseì—ì„œ ìµœì‹  íˆ¬í‘œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            try {
                await FirebaseManager.getBihoVotes();
            } catch (error) {
                console.log('íˆ¬í‘œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨, ë¡œì»¬ ë°ì´í„° ì‚¬ìš©');
            }
            
            const currentVotes = bihoVotes[currentMonth] || { votes: {}, voters: {} };
            
            // í˜„ì¬ ì‚¬ìš©ìì˜ íˆ¬í‘œ ì—¬ë¶€ í™•ì¸
            if (currentVotes.voters && currentVotes.voters[currentUser]) {
                alert('ì´ë²ˆë‹¬ì— ì´ë¯¸ íˆ¬í‘œí•˜ì…¨ìŠµë‹ˆë‹¤! ë‹¤ìŒë‹¬ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” ğŸ˜Š');
                return;
            }

            const votableFriends = friends.filter(f => f.name !== currentUser);
            
            const voteListHtml = votableFriends.map(friend => `
                <div class="biho-vote-item">
                    <div class="biho-vote-info">
                        <div class="profile-pic">${friend.name.substring(0, 2)}</div>
                        <div>
                            <div style="font-weight: 600;">${friend.name}</div>
                            <div style="font-size: 12px; color: #8e8e8e;">í˜„ì¬ ${currentVotes.votes[friend.name] || 0}í‘œ</div>
                        </div>
                    </div>
                    <button class="vote-btn" onclick="voteBiho('${friend.name}')">íˆ¬í‘œ</button>
                </div>
            `).join('');

            document.getElementById('bihoVoteList').innerHTML = voteListHtml;
            document.getElementById('bihoVoteModal').classList.add('active');
        }

        function closeBihoVoteModal() {
            document.getElementById('bihoVoteModal').classList.remove('active');
        }

        async function voteBiho(targetName) {
            if (confirm(`ì •ë§ ${targetName}ë‹˜ì—ê²Œ íˆ¬í‘œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ğŸ˜ˆ\nì´ë²ˆë‹¬ì—ëŠ” ë‹¤ì‹œ íˆ¬í‘œí•  ìˆ˜ ì—†ì–´ìš”!`)) {
                const now = new Date();
                const currentMonth = `${now.getFullYear()}-${now.getMonth()}`;
                
                if (!bihoVotes[currentMonth]) {
                    await initializeBihoVotes();
                }
                
                const currentVotes = { ...bihoVotes[currentMonth] };
                currentVotes.votes[targetName]++;
                currentVotes.voters[currentUser] = true;
                
                await FirebaseManager.updateBihoVotes(currentMonth, currentVotes);
                
                closeBihoVoteModal();
                
                alert(`${targetName}ë‹˜ì—ê²Œ íˆ¬í‘œ ì™„ë£Œ! ğŸ‘‘\nê²°ê³¼ëŠ” ë­í‚¹ì—ì„œ í™•ì¸í•˜ì„¸ìš”!`);
                console.log('âœ… ì™•ë¹„í˜¸ íˆ¬í‘œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        }

        function showProfile() {
            switchTab('profile');
        }

        function logout() {
            if (confirm('ì •ë§ ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                // ì €ì¥ëœ ë¡œê·¸ì¸ ì •ë³´ ì‚­ì œ
                localStorage.removeItem('currentUser');
                localStorage.removeItem('lastLoginTime');
                
                // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
                location.reload();
            }
        }

        function openEditProfileModal() {
            const userProfile = profiles[currentUser] || {};
            const editProfilePic = document.getElementById('editProfilePic');
            
            // ê¸°ì¡´ í”„ë¡œí•„ ì‚¬ì§„ í‘œì‹œ
            if (userProfile.profileImage) {
                editProfilePic.style.backgroundImage = `url(${userProfile.profileImage})`;
                editProfilePic.style.backgroundSize = 'cover';
                editProfilePic.style.backgroundPosition = 'center';
                editProfilePic.textContent = '';
                currentProfileImageData = userProfile.profileImage;
            } else {
                editProfilePic.style.backgroundImage = '';
                editProfilePic.textContent = currentUser.substring(0, 2);
                currentProfileImageData = null;
            }
            
            document.getElementById('editProfileModal').classList.add('active');
        }

        function closeEditProfileModal() {
            document.getElementById('editProfileModal').classList.remove('active');
            // í”„ë¡œí•„ ì‚¬ì§„ ì…ë ¥ ì´ˆê¸°í™”
            document.getElementById('profileImageInput').value = '';
            currentProfileImageData = null;
        }

        async function saveProfile() {
            const bio = document.getElementById('editBio').value.trim();
            
            const profileData = {
                bio: bio || 'ì•ˆë…•í•˜ì„¸ìš”! ê°€ì¡°ì¿ ì˜ ì¼ì›ì…ë‹ˆë‹¤ âœ¨',
                profileImage: currentProfileImageData || null
            };
            
            await FirebaseManager.updateProfile(currentUser, profileData);
            
            document.getElementById('profileBio').textContent = profileData.bio;
            
            // í”„ë¡œí•„ ì‚¬ì§„ ì—…ë°ì´íŠ¸
            updateProfilePics();
            
            closeEditProfileModal();
            
            console.log('âœ… í”„ë¡œí•„ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        function formatBirthday(birthday) {
            const date = new Date(birthday);
            return `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
        }

        function getDaysUntilBirthday(birthday) {
            const today = new Date();
            const birthDate = new Date(birthday);
            birthDate.setFullYear(today.getFullYear());
            
            if (birthDate < today) {
                birthDate.setFullYear(today.getFullYear() + 1);
            }
            
            const diffTime = birthDate - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        function getNextBirthday() {
            return friends
                .map(friend => ({
                    ...friend,
                    daysUntil: getDaysUntilBirthday(friend.birthday)
                }))
                .sort((a, b) => a.daysUntil - b.daysUntil)[0];
        }

        function formatMeetingDate(dateString) {
            const date = new Date(dateString);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'ì˜¤ëŠ˜ ë§Œë‚¨';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'ì–´ì œ ë§Œë‚¨';
            } else {
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${month}ì›” ${day}ì¼ ë§Œë‚¨`;
            }
        }

        function formatTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = now - date;
            const diffMinutes = Math.floor(diffTime / (1000 * 60));
            const diffHours = Math.floor(diffTime / (1000 * 60 * 60));
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffMinutes < 1) {
                return 'ë°©ê¸ˆ ì „';
            } else if (diffMinutes < 60) {
                return `${diffMinutes}ë¶„ ì „`;
            } else if (diffHours < 24) {
                return `${diffHours}ì‹œê°„ ì „`;
            } else if (diffDays === 1) {
                return 'ì–´ì œ';
            } else if (diffDays < 7) {
                return `${diffDays}ì¼ ì „`;
            } else {
                return `${date.getMonth() + 1}ì›” ${date.getDate()}ì¼`;
            }
        }

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });

        // í‚¤ë³´ë“œ ESCë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.classList.remove('active');
                });
            }
        });
    </script>
</body>
</html>
