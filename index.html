
</html><!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëˆ„ì  ê³„ì¢Œë‚´ì—­ ì™„ì „ ë¶„ì„ ì‹œìŠ¤í…œ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: #f5f7fa; line-height: 1.6; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
        
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; padding: 30px; border-radius: 15px; text-align: center; margin-bottom: 30px; 
        }
        .header h1 { margin-bottom: 10px; }
        .header-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
        .header-stat { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px; }
        .header-stat-number { font-size: 1.5em; font-weight: bold; }
        .header-stat-label { font-size: 0.9em; opacity: 0.9; }
        
        .upload-section { 
            background: white; padding: 25px; border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 25px; 
        }
        .file-drop { 
            border: 2px dashed #d1d5db; border-radius: 10px; padding: 40px 20px; 
            text-align: center; cursor: pointer; transition: all 0.2s; 
        }
        .file-drop:hover { border-color: #2563eb; background: #f8fafc; }
        .file-drop.active { border-color: #059669; background: #f0fdf4; }
        .file-input { display: none; }
        
        .tabs {
            display: flex; background: white; border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 25px; overflow: hidden;
        }
        .tab {
            padding: 15px 20px; background: #f9fafb; border: none; 
            cursor: pointer; font-weight: 500; flex: 1; transition: all 0.2s;
        }
        .tab.active { background: #2563eb; color: white; }
        .tab:hover:not(.active) { background: #e5e7eb; }
        
        .content-section { 
            background: white; border-radius: 15px; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 20px;
        }
        .section-header { 
            background: #f8fafc; padding: 20px; border-bottom: 1px solid #e5e7eb; 
            display: flex; justify-content: space-between; align-items: center; 
        }
        .section-title { font-size: 1.3em; font-weight: bold; color: #1f2937; }
        .section-body { padding: 20px; }
        
        .summary-grid { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; margin-bottom: 25px; 
        }
        .summary-card { 
            background: #f9fafb; padding: 20px; border-radius: 15px; 
            border-left: 4px solid #2563eb; 
        }
        .summary-title { font-weight: bold; color: #1f2937; margin-bottom: 8px; }
        .summary-value { color: #2563eb; font-size: 1.3em; font-weight: 600; margin-bottom: 5px; }
        .summary-detail { font-size: 0.9em; color: #6b7280; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 8px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        th { 
            background: #f9fafb; font-weight: 600; color: #374151; 
            position: sticky; top: 0; z-index: 10;
        }
        td { font-size: 14px; }
        
        .amount-positive { color: #059669; font-weight: 600; }
        .amount-negative { color: #dc2626; font-weight: 600; }
        .amount-large { color: #7c3aed; font-weight: bold; }
        
        .customer-row { cursor: pointer; transition: background 0.2s; }
        .customer-row:hover { background: #f9fafb; }
        .customer-row.expanded { background: #f0fdf4; }
        
        .detail-row { 
            background: #f8fafc; font-size: 0.9em; 
            border-left: 3px solid #2563eb; 
        }
        .detail-row td { padding: 8px 12px; }
        
        .status-badge { 
            padding: 4px 12px; border-radius: 20px; font-size: 0.8em; font-weight: 600; 
        }
        .status-unreturned { background: #fef2f2; color: #dc2626; }
        .status-returned { background: #f0fdf4; color: #059669; }
        .status-excluded { background: #fef3c7; color: #d97706; }
        .status-new { background: #ede9fe; color: #7c3aed; }
        .status-sales { background: #dbeafe; color: #2563eb; }
        .status-deposit { background: #fef3c7; color: #d97706; }
        
        .btn { 
            background: #2563eb; color: white; padding: 12px 24px; 
            border: none; border-radius: 8px; cursor: pointer; 
            font-weight: 500; transition: all 0.2s; margin: 0 5px;
        }
        .btn:hover { background: #1d4ed8; }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        
        .search-filter {
            display: flex; gap: 15px; margin-bottom: 20px; align-items: center;
        }
        .search-input {
            padding: 10px 15px; border: 1px solid #d1d5db; border-radius: 8px; 
            font-size: 14px; flex: 1; max-width: 300px;
        }
        
        .notification { 
            position: fixed; top: 20px; right: 20px; background: #059669; 
            color: white; padding: 15px 20px; border-radius: 8px; z-index: 1000; 
            transform: translateX(300px); transition: transform 0.3s ease; 
        }
        .notification.show { transform: translateX(0); }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .progress-bar {
            background: #e5e7eb; height: 4px; border-radius: 2px; overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            background: #2563eb; height: 100%; transition: width 0.3s ease;
        }
        
        .transaction-type-income { background: #f0fdf4; }
        .transaction-type-outcome { background: #fef2f2; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š ëˆ„ì  ê³„ì¢Œë‚´ì—­ ì™„ì „ ë¶„ì„ ì‹œìŠ¤í…œ</h1>
            <p>ì „ì²´ ê³„ì¢Œë‚´ì—­ ëˆ„ì  ë¶„ì„ â€¢ ë§¤ì¶œ/ë³´ì¦ê¸ˆ/í™˜ê¸‰ ì™„ì „ ì¶”ì  â€¢ ìƒì„¸ ê±°ë˜ë‚´ì—­ í™•ì¸</p>
            <div class="header-stats">
                <div class="header-stat">
                    <div class="header-stat-number" id="totalTransactions">0ê±´</div>
                    <div class="header-stat-label">ì´ ê±°ë˜ ê±´ìˆ˜</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-number" id="totalIncome">â‚©0</div>
                    <div class="header-stat-label">ì´ ì…ê¸ˆì•¡</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-number" id="totalCustomers">0ëª…</div>
                    <div class="header-stat-label">ì „ì²´ ê³ ê° ìˆ˜</div>
                </div>
                <div class="header-stat">
                    <div class="header-stat-number" id="finalSalesAmount">â‚©0</div>
                    <div class="header-stat-label">ìµœì¢… ë§¤ì¶œì•¡</div>
                </div>
            </div>
        </div>

        <div class="upload-section">
            <div class="file-drop" id="fileDrop">
                <h3>ğŸ“‚ ê³„ì¢Œë‚´ì—­ ì—…ë¡œë“œ (ëˆ„ì  ë¶„ì„)</h3>
                <p>ìƒˆë¡œìš´ ê³„ì¢Œë‚´ì—­ì„ ì—…ë¡œë“œí•˜ë©´ ê¸°ì¡´ ë°ì´í„°ì— ì¶”ê°€ë¡œ ëˆ„ì ë©ë‹ˆë‹¤</p>
                <div id="uploadStatus"></div>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
            </div>
            <div style="display: flex; gap: 15px; margin-top: 20px; align-items: center;">
                <button onclick="analyzeData()" class="btn" id="analyzeBtn" disabled>ğŸ” ì „ì²´ ë°ì´í„° ë¶„ì„</button>
                <button onclick="clearData()" class="btn btn-secondary">ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”</button>
                <button onclick="exportData()" class="btn btn-secondary">ğŸ“Š ë¶„ì„ ê²°ê³¼ ë‚´ë³´ë‚´ê¸°</button>
                <div id="processStatus" style="flex: 1; text-align: right;"></div>
            </div>
            <div class="progress-bar" id="progressContainer" style="display: none;">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('overview')">ğŸ“Š ì „ì²´ í˜„í™©</button>
            <button class="tab" onclick="showTab('customers')">ğŸ‘¥ ê³ ê°ë³„ ë¶„ì„</button>
            <button class="tab" onclick="showTab('deposits')">ğŸ’° ë³´ì¦ê¸ˆ ê´€ë¦¬</button>
            <button class="tab" onclick="showTab('sales')">ğŸ“ˆ ë§¤ì¶œ ë¶„ì„</button>
            <button class="tab" onclick="showTab('monthly')">ğŸ“… ì›”ë³„ ë¶„ì„</button>
            <button class="tab" onclick="showTab('transactions')">ğŸ“‹ ì „ì²´ ê±°ë˜</button>
        </div>

        <!-- ì „ì²´ í˜„í™© íƒ­ -->
        <div id="overview" class="content-section tab-content active">
            <div class="section-header">
                <div class="section-title">ğŸ“Š ì „ì²´ í˜„í™© ìš”ì•½</div>
            </div>
            <div class="section-body">
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-title">ğŸ’° ì´ ë³´ì¦ê¸ˆ</div>
                        <div class="summary-value" id="overviewTotalDeposits">â‚©0</div>
                        <div class="summary-detail" id="overviewDepositDetail">ë¯¸í™˜ê¸‰ + í™˜ê¸‰ì™„ë£Œ</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">ğŸ“ˆ ì´ ë§¤ì¶œ</div>
                        <div class="summary-value" id="overviewTotalSales">â‚©0</div>
                        <div class="summary-detail" id="overviewSalesDetail">ë³´ì¦ê¸ˆ ì œì™¸ ìˆœìˆ˜ ë§¤ì¶œ</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">ğŸš« ë§¤ì¶œ ì œì™¸</div>
                        <div class="summary-value" id="overviewExcludedAmount">â‚©0</div>
                        <div class="summary-detail" id="overviewExcludedDetail">í™©ìŠ¹í•˜, SENTBE ë“±</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">ğŸ‘¥ ì „ì²´ ê³ ê°</div>
                        <div class="summary-value" id="overviewTotalCustomerCount">0ëª…</div>
                        <div class="summary-detail" id="overviewCustomerDetail">ì…ê¸ˆ ê³ ê° ê¸°ì¤€</div>
                    </div>
                </div>

                <div id="recentUploads" style="margin-top: 30px;">
                    <h4 style="margin-bottom: 15px;">ğŸ“‚ ì—…ë¡œë“œëœ íŒŒì¼ í˜„í™©</h4>
                    <div id="uploadHistory"></div>
                </div>
            </div>
        </div>

        <!-- ê³ ê°ë³„ ë¶„ì„ íƒ­ -->
        <div id="customers" class="content-section tab-content">
            <div class="section-header">
                <div class="section-title">ğŸ‘¥ ê³ ê°ë³„ ìƒì„¸ ë¶„ì„</div>
                <div class="search-filter">
                    <input type="text" id="customerSearch" class="search-input" placeholder="ê³ ê°ëª… ê²€ìƒ‰...">
                    <select id="customerFilter" class="search-input" style="max-width: 200px;">
                        <option value="all">ì „ì²´</option>
                        <option value="deposit">ë³´ì¦ê¸ˆ ê³ ê°</option>
                        <option value="sales">ë§¤ì¶œë§Œ</option>
                        <option value="large">ëŒ€ëŸ‰ê±°ë˜ (1000ë§Œ+)</option>
                        <option value="excluded">ì œì™¸ ê³ ê°</option>
                    </select>
                </div>
            </div>
            <div class="section-body">
                <table id="customersTable">
                    <thead>
                        <tr>
                            <th>ê³ ê°ëª…</th>
                            <th>ì´ ì…ê¸ˆì•¡</th>
                            <th>ë³´ì¦ê¸ˆ</th>
                            <th>ë§¤ì¶œ</th>
                            <th>ê±°ë˜ê±´ìˆ˜</th>
                            <th>ê±°ë˜ê¸°ê°„</th>
                            <th>ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- ë³´ì¦ê¸ˆ ê´€ë¦¬ íƒ­ -->
        <div id="deposits" class="content-section tab-content">
            <div class="section-header">
                <div class="section-title">ğŸ’° ë³´ì¦ê¸ˆ ìƒì„¸ ê´€ë¦¬</div>
            </div>
            <div class="section-body">
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-title">ğŸ”´ ë¯¸í™˜ê¸‰ ë³´ì¦ê¸ˆ</div>
                        <div class="summary-value" id="unreturnedDepositAmount">â‚©0</div>
                        <div class="summary-detail" id="unreturnedDepositCount">0ëª… ê³ ê°</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-title">âœ… í™˜ê¸‰ì™„ë£Œ ë³´ì¦ê¸ˆ</div>
                        <div class="summary-value" id="returnedDepositAmount">â‚©0</div>
                        <div class="summary-detail" id="returnedDepositCount">0ëª… ê³ ê°</div>
                    </div>
                </div>
                
                <table id="depositsTable">
                    <thead>
                        <tr>
                            <th>ê³ ê°ëª…</th>
                            <th>ë³´ì¦ê¸ˆì•¡</th>
                            <th>ì…ê¸ˆì¼</th>
                            <th>í™˜ê¸‰ìƒíƒœ</th>
                            <th>í™˜ê¸‰ì¼</th>
                            <th>ì—°ê²°ë§¤ì¶œ</th>
                            <th>ë¹„ê³ </th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- ë§¤ì¶œ ë¶„ì„ íƒ­ -->
        <div id="sales" class="content-section tab-content">
            <div class="section-header">
                <div class="section-title">ğŸ“ˆ ë§¤ì¶œ ìƒì„¸ ë¶„ì„</div>
                <div class="search-filter">
                    <input type="text" id="salesSearch" class="search-input" placeholder="ê³ ê°ëª… ê²€ìƒ‰...">
                    <select id="salesFilter" class="search-input" style="max-width: 200px;">
                        <option value="all">ì „ì²´</option>
                        <option value="pure">ìˆœìˆ˜ ë§¤ì¶œ</option>
                        <option value="deposit-linked">ë³´ì¦ê¸ˆ ì—°ê²°</option>
                        <option value="large">ëŒ€ëŸ‰ ê±°ë˜</option>
                    </select>
                </div>
            </div>
            <div class="section-body">
                <table id="salesTable">
                    <thead>
                        <tr>
                            <th>ê³ ê°ëª…</th>
                            <th>ë§¤ì¶œì•¡</th>
                            <th>ê±°ë˜ê±´ìˆ˜</th>
                            <th>ê±°ë˜ê¸°ê°„</th>
                            <th>êµ¬ë¶„</th>
                            <th>ë³´ì¦ê¸ˆ</th>
                            <th>ìƒì„¸ë³´ê¸°</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- ì›”ë³„ ë¶„ì„ íƒ­ -->
        <div id="monthly" class="content-section tab-content">
            <div class="section-header">
                <div class="section-title">ğŸ“… ì›”ë³„ ê±°ë˜ í˜„í™©</div>
            </div>
            <div class="section-body">
                <div class="summary-grid">
                    <div class="summary-card">
                        <div class="summary-title">ğŸ“Š ì›”ë³„ ê±°ë˜ ê¸°ì¤€</div>
                        <div class="summary-value">ë§¤ì¶œ ê±°ë˜ë§Œ</div>
                        <div class="summary-detail">ë³´ì¦ê¸ˆ, í™˜ê¸‰, ì œì™¸í•­ëª© ì œì™¸í•œ ìˆœìˆ˜ ë§¤ì¶œ ê±°ë˜</div>
                    </div>
                </div>
                
                <table id="monthlyTable">
                    <thead>
                        <tr>
                            <th>ë…„ì›”</th>
                            <th>ë§¤ì¶œ ê±°ë˜ê±´ìˆ˜</th>
                            <th>ë§¤ì¶œì•¡</th>
                            <th>ì‹ ê·œê³ ê°</th>
                            <th>í‰ê· ê±°ë˜ì•¡</th>
                            <th>ì „ì›”ëŒ€ë¹„</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- ì „ì²´ ê±°ë˜ íƒ­ -->
        <div id="transactions" class="content-section tab-content">
            <div class="section-header">
                <div class="section-title">ğŸ“‹ ì „ì²´ ê±°ë˜ ë‚´ì—­</div>
                <div class="search-filter">
                    <input type="text" id="transactionSearch" class="search-input" placeholder="ê³ ê°ëª…/ë‚ ì§œ ê²€ìƒ‰...">
                    <select id="transactionFilter" class="search-input" style="max-width: 200px;">
                        <option value="all">ì „ì²´</option>
                        <option value="income">ì…ê¸ˆë§Œ</option>
                        <option value="outcome">ì¶œê¸ˆë§Œ</option>
                        <option value="large">100ë§Œì› ì´ìƒ</option>
                        <option value="recent">ìµœê·¼ 30ì¼</option>
                    </select>
                </div>
            </div>
            <div class="section-body">
                <table id="transactionsTable">
                    <thead>
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>ê³ ê°ëª…</th>
                            <th>ì…ê¸ˆì•¡</th>
                            <th>ì¶œê¸ˆì•¡</th>
                            <th>ë¶„ë¥˜</th>
                            <th>ë¹„ê³ </th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // ì „ì—­ ë°ì´í„° ì €ì¥ì†Œ
        let allTransactions = [];
        let allCustomers = {};
        let uploadHistory = [];
        let analysisComplete = false;

        // ì œì™¸ ê³ ê° ë° íŠ¹ë³„ ì²˜ë¦¬ ê·œì¹™
        const excludeCustomers = ['í™©ìŠ¹í•˜', 'í™©ìŠ¹í•˜(ì¿¨í‚¤ì¦ˆí´ëŸ½)', 'SENTBE', 'ì´ì°½í›ˆ', 'êµ­ê³ í™˜ê¸‰:ì€í‰ì„¸ë¬´ì„œ', 'ì£¼ì‹íšŒì‚¬í•„ì›¨ì´'];
        const specialCases = {
            'ì±„í˜': { type: 'deposit_management', note: 'ì˜ˆì¹˜ê¸ˆ í˜•íƒœ ìš´ì˜' },
            'í…Œì´ë°ë©': { type: 'full_refund', note: 'ì „ì•¡ í™˜ë¶ˆ' }
        };

        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ í‚¤
        const STORAGE_KEY = 'accountAnalysisData';

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            initializeEventListeners();
            loadStoredData();
        });

        function initializeEventListeners() {
            const fileDrop = document.getElementById('fileDrop');
            const fileInput = document.getElementById('fileInput');
            
            fileDrop.addEventListener('click', () => fileInput.click());
            fileDrop.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileDrop.classList.add('active');
            });
            fileDrop.addEventListener('dragleave', () => {
                fileDrop.classList.remove('active');
            });
            fileDrop.addEventListener('drop', (e) => {
                e.preventDefault();
                fileDrop.classList.remove('active');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });

            // ê²€ìƒ‰ í•„í„° ì´ë²¤íŠ¸
            ['customerSearch', 'customerFilter', 'salesSearch', 'salesFilter', 'transactionSearch', 'transactionFilter'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', () => filterTable(id));
                    element.addEventListener('change', () => filterTable(id));
                }
            });
        }

        function handleFile(file) {
            if (!file.name.match(/\.(xlsx|xls)$/)) {
                showNotification('âŒ Excel íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤!');
                return;
            }
            
            document.getElementById('uploadStatus').innerHTML = `
                <div style="color: #059669; margin-top: 10px;">
                    âœ… ${file.name} ì„ íƒë¨ (${(file.size / 1024 / 1024).toFixed(2)}MB)
                </div>
            `;
            document.getElementById('analyzeBtn').disabled = false;
            window.uploadedFile = file;
            showNotification('ğŸ“‚ íŒŒì¼ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ë¶„ì„ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”!');
        }

        async function analyzeData() {
            if (!window.uploadedFile) {
                showNotification('âŒ ë¨¼ì € íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”!');
                return;
            }

            try {
                showProgress(10, 'íŒŒì¼ ì½ëŠ” ì¤‘...');
                
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        showProgress(30, 'ë°ì´í„° íŒŒì‹± ì¤‘...');
                        
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
                        
                        showProgress(50, 'ê±°ë˜ ë‚´ì—­ ë¶„ì„ ì¤‘...');
                        
                        const newTransactions = parseTransactionData(jsonData);
                        
                        showProgress(70, 'ì¤‘ë³µ ì œê±° ë° ë°ì´í„° í†µí•© ì¤‘...');
                        
                        const beforeCount = allTransactions.length;
                        integrateTransactions(newTransactions);
                        const addedCount = allTransactions.length - beforeCount;
                        
                        showProgress(85, 'ê³ ê°ë³„ ë°ì´í„° ë¶„ì„ ì¤‘...');
                        
                        analyzeCustomerData();
                        
                        showProgress(100, 'ë¶„ì„ ì™„ë£Œ!');
                        
                        uploadHistory.push({
                            fileName: window.uploadedFile.name,
                            uploadTime: new Date(),
                            transactionCount: newTransactions.length,
                            addedCount: addedCount
                        });
                        
                        saveData();
                        updateAllTabs();
                        
                        analysisComplete = true;
                        showNotification(`âœ… ë¶„ì„ ì™„ë£Œ! ${addedCount}ê±´ì˜ ìƒˆë¡œìš´ ê±°ë˜ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        hideProgress();
                        
                    } catch (error) {
                        console.error('ë¶„ì„ ì˜¤ë¥˜:', error);
                        showNotification('âŒ íŒŒì¼ ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        hideProgress();
                    }
                };
                
                reader.readAsArrayBuffer(window.uploadedFile);
                
            } catch (error) {
                console.error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', error);
                showNotification('âŒ íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                hideProgress();
            }
        }

        function parseTransactionData(jsonData) {
            const transactionData = jsonData.slice(7).filter(row => row && row.length > 5);
            
            return transactionData.map((row, index) => {
                const dateStr = row[1];
                const customer = row[2];
                const outAmount = parseFloat(row[3]) || 0;
                const inAmount = parseFloat(row[4]) || 0;
                
                let parsedDate = null;
                if (dateStr && typeof dateStr === 'string') {
                    const dateMatch = dateStr.match(/(\d{4})\.(\d{2})\.(\d{2})/);
                    if (dateMatch) {
                        parsedDate = new Date(dateMatch[1], dateMatch[2] - 1, dateMatch[3]);
                    }
                }
                
                const uniqueId = `${dateStr}_${customer}_${inAmount}_${outAmount}_${index}`;
                
                return {
                    id: uniqueId,
                    date: dateStr,
                    parsedDate: parsedDate,
                    customer: customer,
                    outAmount: outAmount,
                    inAmount: inAmount,
                    type: inAmount > 0 ? 'ì…ê¸ˆ' : 'ì¶œê¸ˆ',
                    excluded: excludeCustomers.some(exclude => customer && customer.includes(exclude))
                };
            }).filter(t => t.parsedDate && t.customer);
        }

        function integrateTransactions(newTransactions) {
            const existingIds = new Set(allTransactions.map(t => t.id));
            
            newTransactions.forEach(transaction => {
                if (!existingIds.has(transaction.id)) {
                    allTransactions.push(transaction);
                }
            });
            
            allTransactions.sort((a, b) => b.parsedDate - a.parsedDate);
        }

        function analyzeCustomerData() {
            allCustomers = {};
            
            allTransactions.forEach(transaction => {
                const customer = transaction.customer;
                
                if (!allCustomers[customer]) {
                    allCustomers[customer] = {
                        name: customer,
                        transactions: [],
                        totalIncome: 0,
                        totalOutcome: 0,
                        salesAmount: 0,
                        depositAmount: 0,
                        depositStatus: 'none',
                        depositDate: null,
                        returnDate: null,
                        firstTransactionDate: null,
                        lastTransactionDate: null,
                        excluded: excludeCustomers.some(exclude => customer.includes(exclude))
                    };
                }
                
                const customerData = allCustomers[customer];
                customerData.transactions.push(transaction);
                
                if (transaction.type === 'ì…ê¸ˆ') {
                    customerData.totalIncome += transaction.inAmount;
                } else {
                    customerData.totalOutcome += transaction.outAmount;
                }
                
                if (!customerData.firstTransactionDate || transaction.parsedDate < customerData.firstTransactionDate) {
                    customerData.firstTransactionDate = transaction.parsedDate;
                }
                if (!customerData.lastTransactionDate || transaction.parsedDate > customerData.lastTransactionDate) {
                    customerData.lastTransactionDate = transaction.parsedDate;
                }
            });
            
            Object.values(allCustomers).forEach(customer => {
                if (customer.excluded) {
                    return;
                }
                
                const incomeTransactions = customer.transactions
                    .filter(t => t.type === 'ì…ê¸ˆ')
                    .sort((a, b) => a.parsedDate - b.parsedDate);
                
                if (incomeTransactions.length === 0) return;const firstTransaction = incomeTransactions[0];
                if (firstTransaction.inAmount >= 1000000) {
                    customer.depositAmount = firstTransaction.inAmount;
                    customer.depositDate = firstTransaction.date;
                    customer.depositStatus = 'unreturned';
                    
                    customer.salesAmount = customer.totalIncome - customer.depositAmount;
                    
                    const outcomeTransactions = customer.transactions.filter(t => t.type === 'ì¶œê¸ˆ');
                    const refundTransaction = outcomeTransactions.find(t => 
                        Math.abs(t.outAmount - customer.depositAmount) < 50000
                    );
                    
                    if (refundTransaction) {
                        customer.depositStatus = 'returned';
                        customer.returnDate = refundTransaction.date;
                    }
                } else {
                    customer.salesAmount = customer.totalIncome;
                }
                
                if (specialCases[customer.name]) {
                    const specialCase = specialCases[customer.name];
                    if (specialCase.type === 'full_refund') {
                        customer.salesAmount = 0;
                    } else if (specialCase.type === 'deposit_management') {
                        customer.salesAmount = customer.totalIncome - customer.totalOutcome;
                    }
                }
            });
        }

        function updateAllTabs() {
            updateHeaderStats();
            updateOverviewTab();
            updateCustomersTab();
            updateDepositsTab();
            updateSalesTab();
            updateMonthlyTab();
            updateTransactionsTab();
        }

        function updateHeaderStats() {
            const incomeTransactions = allTransactions.filter(t => t.type === 'ì…ê¸ˆ' && !t.excluded);
            const totalIncome = incomeTransactions.reduce((sum, t) => sum + t.inAmount, 0);
            const totalCustomers = Object.keys(allCustomers).filter(name => !allCustomers[name].excluded).length;
            
            const totalSales = Object.values(allCustomers)
                .filter(c => !c.excluded)
                .reduce((sum, c) => sum + c.salesAmount, 0);
            
            document.getElementById('totalTransactions').textContent = allTransactions.length.toLocaleString() + 'ê±´';
            document.getElementById('totalIncome').textContent = 'â‚©' + totalIncome.toLocaleString();
            document.getElementById('totalCustomers').textContent = totalCustomers + 'ëª…';
            document.getElementById('finalSalesAmount').textContent = 'â‚©' + totalSales.toLocaleString();
        }

        function updateOverviewTab() {
            const nonExcludedCustomers = Object.values(allCustomers).filter(c => !c.excluded);
            
            const totalDeposits = nonExcludedCustomers.reduce((sum, c) => sum + c.depositAmount, 0);
            const totalSales = nonExcludedCustomers.reduce((sum, c) => sum + c.salesAmount, 0);
            const excludedAmount = Object.values(allCustomers)
                .filter(c => c.excluded)
                .reduce((sum, c) => sum + c.totalIncome, 0);
            
            document.getElementById('overviewTotalDeposits').textContent = 'â‚©' + totalDeposits.toLocaleString();
            document.getElementById('overviewTotalSales').textContent = 'â‚©' + totalSales.toLocaleString();
            document.getElementById('overviewExcludedAmount').textContent = 'â‚©' + excludedAmount.toLocaleString();
            document.getElementById('overviewTotalCustomerCount').textContent = nonExcludedCustomers.length + 'ëª…';
            
            const depositCustomers = nonExcludedCustomers.filter(c => c.depositAmount > 0);
            document.getElementById('overviewDepositDetail').textContent = `ë³´ì¦ê¸ˆ ê³ ê° ${depositCustomers.length}ëª…`;
            document.getElementById('overviewSalesDetail').textContent = `ë§¤ì¶œ ê³ ê° ${nonExcludedCustomers.filter(c => c.salesAmount > 0).length}ëª…`;
            document.getElementById('overviewExcludedDetail').textContent = `ì œì™¸ ê³ ê° ${Object.values(allCustomers).filter(c => c.excluded).length}ëª…`;
            document.getElementById('overviewCustomerDetail').textContent = `ì „ì²´ ${Object.keys(allCustomers).length}ëª… ì¤‘ ìœ íš¨ ê³ ê°`;
            
            updateUploadHistory();
        }

        function updateUploadHistory() {
            const historyContainer = document.getElementById('uploadHistory');
            if (uploadHistory.length === 0) {
                historyContainer.innerHTML = '<p style="color: #6b7280;">ì•„ì§ ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            const historyHTML = uploadHistory.map((upload, index) => `
                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${upload.fileName}</strong>
                            <span style="color: #6b7280; margin-left: 10px;">
                                ${upload.uploadTime.toLocaleString()}
                            </span>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #059669;">+${upload.addedCount}ê±´ ì¶”ê°€</div>
                            <div style="font-size: 0.9em; color: #6b7280;">ì´ ${upload.transactionCount}ê±´</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            historyContainer.innerHTML = historyHTML;
        }

        function updateCustomersTab() {
            const tbody = document.querySelector('#customersTable tbody');
            tbody.innerHTML = '';
            
            const sortedCustomers = Object.values(allCustomers)
                .sort((a, b) => b.totalIncome - a.totalIncome);
            
            sortedCustomers.forEach(customer => {
                const row = tbody.insertRow();
                row.className = 'customer-row';
                row.setAttribute('data-customer', customer.name);
                
                const period = customer.firstTransactionDate && customer.lastTransactionDate ? 
                    `${customer.firstTransactionDate.toLocaleDateString()} ~ ${customer.lastTransactionDate.toLocaleDateString()}` : 
                    '-';
                
                let statusBadge = '';
                if (customer.excluded) {
                    statusBadge = '<span class="status-badge status-excluded">ì œì™¸</span>';
                } else if (customer.depositAmount > 0) {
                    if (customer.depositStatus === 'returned') {
                        statusBadge = '<span class="status-badge status-returned">í™˜ê¸‰ì™„ë£Œ</span>';
                    } else {
                        statusBadge = '<span class="status-badge status-unreturned">ë¯¸í™˜ê¸‰</span>';
                    }
                } else {
                    statusBadge = '<span class="status-badge status-sales">ë§¤ì¶œë§Œ</span>';
                }
                
                row.innerHTML = `
                    <td><strong>${customer.name}</strong></td>
                    <td class="amount-large">â‚©${customer.totalIncome.toLocaleString()}</td>
                    <td class="amount-negative">â‚©${customer.depositAmount.toLocaleString()}</td>
                    <td class="amount-positive">â‚©${customer.salesAmount.toLocaleString()}</td>
                    <td>${customer.transactions.filter(t => t.type === 'ì…ê¸ˆ').length}ê±´</td>
                    <td style="font-size: 0.9em;">${period}</td>
                    <td>${statusBadge}</td>
                `;
                
                row.addEventListener('click', () => toggleCustomerDetails(customer.name, row));
            });
        }

        function toggleCustomerDetails(customerName, row) {
            const customer = allCustomers[customerName];
            const existingDetailRow = row.nextElementSibling;
            
            if (existingDetailRow && existingDetailRow.classList.contains('detail-row')) {
                existingDetailRow.remove();
                row.classList.remove('expanded');
                return;
            }
            
            const detailRow = row.parentNode.insertRow(row.rowIndex + 1);
            detailRow.className = 'detail-row';
            detailRow.innerHTML = `
                <td colspan="7">
                    <div style="padding: 15px;">
                        <h5 style="margin-bottom: 10px;">${customerName} ìƒì„¸ ê±°ë˜ ë‚´ì—­</h5>
                        <table style="width: 100%; font-size: 0.9em;">
                            <thead>
                                <tr>
                                    <th>ë‚ ì§œ</th>
                                    <th>ìœ í˜•</th>
                                    <th>ê¸ˆì•¡</th>
                                    <th>ë¶„ë¥˜</th>
                                    <th>ë¹„ê³ </th>
                                </tr>
                            </thead>
                            <tbody>
                                ${customer.transactions.map(t => {
                                    let classification = '';
                                    let note = '';
                                    
                                    if (t.type === 'ì…ê¸ˆ') {
                                        if (customer.depositAmount > 0 && t.inAmount === customer.depositAmount && t.date === customer.depositDate) {
                                            classification = '<span class="status-badge status-deposit">ë³´ì¦ê¸ˆ</span>';
                                            note = 'ì²« ì…ê¸ˆ (ë³´ì¦ê¸ˆ)';
                                        } else {
                                            classification = '<span class="status-badge status-sales">ë§¤ì¶œ</span>';
                                            note = 'ë§¤ì¶œ ì…ê¸ˆ';
                                        }
                                    } else {
                                        if (customer.returnDate && t.date === customer.returnDate) {
                                            classification = '<span class="status-badge status-returned">í™˜ê¸‰</span>';
                                            note = 'ë³´ì¦ê¸ˆ í™˜ê¸‰';
                                        } else {
                                            classification = '<span class="status-badge">ì¶œê¸ˆ</span>';
                                            note = 'ì¼ë°˜ ì¶œê¸ˆ';
                                        }
                                    }
                                    
                                    return `
                                        <tr class="transaction-type-${t.type === 'ì…ê¸ˆ' ? 'income' : 'outcome'}">
                                            <td>${t.date.substring(0, 10)}</td>
                                            <td>${t.type}</td>
                                            <td class="amount-${t.type === 'ì…ê¸ˆ' ? 'positive' : 'negative'}">â‚©${(t.inAmount || t.outAmount).toLocaleString()}</td>
                                            <td>${classification}</td>
                                            <td>${note}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </td>
            `;
            
            row.classList.add('expanded');
        }

        function updateDepositsTab() {
            const tbody = document.querySelector('#depositsTable tbody');
            tbody.innerHTML = '';
            
            const depositCustomers = Object.values(allCustomers).filter(c => c.depositAmount > 0);
            let unreturnedAmount = 0;
            let returnedAmount = 0;
            let unreturnedCount = 0;
            let returnedCount = 0;
            
            depositCustomers.forEach(customer => {
                const row = tbody.insertRow();
                
                let statusBadge, returnDateText;
                if (customer.depositStatus === 'returned') {
                    statusBadge = '<span class="status-badge status-returned">í™˜ê¸‰ì™„ë£Œ</span>';
                    returnDateText = customer.returnDate ? customer.returnDate.substring(0, 10) : '-';
                    returnedAmount += customer.depositAmount;
                    returnedCount++;
                } else {
                    statusBadge = '<span class="status-badge status-unreturned">ë¯¸í™˜ê¸‰</span>';
                    returnDateText = '-';
                    unreturnedAmount += customer.depositAmount;
                    unreturnedCount++;
                }
                
                row.innerHTML = `
                    <td><strong>${customer.name}</strong></td>
                    <td class="amount-negative">â‚©${customer.depositAmount.toLocaleString()}</td>
                    <td>${customer.depositDate ? customer.depositDate.substring(0, 10) : '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${returnDateText}</td>
                    <td class="amount-positive">â‚©${customer.salesAmount.toLocaleString()}</td>
                    <td>${specialCases[customer.name]?.note || 'ì¼ë°˜ ë³´ì¦ê¸ˆ'}</td>
                `;
            });
            
            document.getElementById('unreturnedDepositAmount').textContent = 'â‚©' + unreturnedAmount.toLocaleString();
            document.getElementById('returnedDepositAmount').textContent = 'â‚©' + returnedAmount.toLocaleString();
            document.getElementById('unreturnedDepositCount').textContent = unreturnedCount + 'ëª… ê³ ê°';
            document.getElementById('returnedDepositCount').textContent = returnedCount + 'ëª… ê³ ê°';
        }

        function updateSalesTab() {
            const tbody = document.querySelector('#salesTable tbody');
            tbody.innerHTML = '';
            
            const salesCustomers = Object.values(allCustomers)
                .filter(c => !c.excluded && c.salesAmount > 0)
                .sort((a, b) => b.salesAmount - a.salesAmount);
            
            salesCustomers.forEach(customer => {
                const row = tbody.insertRow();
                row.className = 'customer-row';
                
                const period = customer.firstTransactionDate && customer.lastTransactionDate ? 
                    `${customer.firstTransactionDate.toLocaleDateString()} ~ ${customer.lastTransactionDate.toLocaleDateString()}` : 
                    '-';
                
                const incomeCount = customer.transactions.filter(t => t.type === 'ì…ê¸ˆ').length;
                
                let typeClass = customer.depositAmount > 0 ? 'deposit-linked' : 'pure';
                let typeBadge = customer.depositAmount > 0 ? 
                    '<span class="status-badge status-deposit">ë³´ì¦ê¸ˆì—°ê²°</span>' : 
                    '<span class="status-badge status-sales">ìˆœìˆ˜ë§¤ì¶œ</span>';
                
                row.innerHTML = `
                    <td><strong>${customer.name}</strong></td>
                    <td class="amount-large">â‚©${customer.salesAmount.toLocaleString()}</td>
                    <td>${incomeCount}ê±´</td>
                    <td style="font-size: 0.9em;">${period}</td>
                    <td>${typeBadge}</td>
                    <td>${customer.depositAmount > 0 ? 'â‚©' + customer.depositAmount.toLocaleString() : '-'}</td>
                    <td><button class="btn" style="padding: 5px 10px; font-size: 0.8em;" onclick="showSalesDetails('${customer.name}')">ìƒì„¸ë³´ê¸°</button></td>
                `;
                
                row.setAttribute('data-type', typeClass);
                row.setAttribute('data-customer', customer.name);
            });
        }

        function showSalesDetails(customerName) {
            const customer = allCustomers[customerName];
            const salesTransactions = customer.transactions.filter(t => t.type === 'ì…ê¸ˆ');
            
            let detailHTML = `
                <h4>${customerName} ë§¤ì¶œ ìƒì„¸</h4>
                <p>ì´ ë§¤ì¶œ: â‚©${customer.salesAmount.toLocaleString()} (${salesTransactions.length}ê±´)</p>
                <table style="width: 100%; margin-top: 15px;">
                    <thead>
                        <tr><th>ë‚ ì§œ</th><th>ê¸ˆì•¡</th><th>ë¶„ë¥˜</th></tr>
                    </thead>
                    <tbody>
            `;
            
            salesTransactions.forEach(t => {
                const isDeposit = customer.depositAmount > 0 && t.inAmount === customer.depositAmount && t.date === customer.depositDate;
                detailHTML += `
                    <tr>
                        <td>${t.date.substring(0, 10)}</td>
                        <td class="amount-positive">â‚©${t.inAmount.toLocaleString()}</td>
                        <td>${isDeposit ? '<span class="status-badge status-deposit">ë³´ì¦ê¸ˆ</span>' : '<span class="status-badge status-sales">ë§¤ì¶œ</span>'}</td>
                    </tr>
                `;
            });
            
            detailHTML += '</tbody></table>';
            
            showNotification(`${customerName} ìƒì„¸ ì •ë³´ë¥¼ ì½˜ì†”ì—ì„œ í™•ì¸í•˜ì„¸ìš”.`);
            console.log(detailHTML);
        }

        function updateMonthlyTab() {
            const tbody = document.querySelector('#monthlyTable tbody');
            tbody.innerHTML = '';
            
            const salesTransactions = allTransactions.filter(t => {
                if (t.type !== 'ì…ê¸ˆ' || t.excluded) return false;
                
                const customer = allCustomers[t.customer];
                if (!customer) return false;
                
                if (customer.depositAmount > 0 && t.inAmount === customer.depositAmount && t.date === customer.depositDate) {
                    return false;
                }
                
                return true;
            });
            
            const monthlyData = {};
            const newCustomersByMonth = {};
            
            salesTransactions.forEach(t => {
                const yearMonth = `${t.parsedDate.getFullYear()}-${String(t.parsedDate.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[yearMonth]) {
                    monthlyData[yearMonth] = {
                        transactions: 0,
                        amount: 0,
                        customers: new Set()
                    };
                }
                
                monthlyData[yearMonth].transactions++;
                monthlyData[yearMonth].amount += t.inAmount;
                monthlyData[yearMonth].customers.add(t.customer);
                
                const customer = allCustomers[t.customer];
                if (customer && customer.firstTransactionDate && 
                    customer.firstTransactionDate.getFullYear() === t.parsedDate.getFullYear() &&
                    customer.firstTransactionDate.getMonth() === t.parsedDate.getMonth()) {
                    
                    if (!newCustomersByMonth[yearMonth]) {
                        newCustomersByMonth[yearMonth] = new Set();
                    }
                    newCustomersByMonth[yearMonth].add(t.customer);
                }
            });
            
            const sortedMonths = Object.keys(monthlyData).sort();
            let previousAmount = 0;
            
            sortedMonths.forEach(month => {
                const data = monthlyData[month];
                const newCustomers = newCustomersByMonth[month] ? newCustomersByMonth[month].size : 0;
                const avgAmount = data.transactions > 0 ? data.amount / data.transactions : 0;
                const growthRate = previousAmount > 0 ? ((data.amount - previousAmount) / previousAmount * 100).toFixed(1) : '0.0';
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${month}</strong></td>
                    <td>${data.transactions}ê±´</td>
                    <td class="amount-positive">â‚©${data.amount.toLocaleString()}</td>
                    <td>${newCustomers}ëª…</td>
                    <td>â‚©${avgAmount.toLocaleString()}</td>
                    <td style="color: ${parseFloat(growthRate) >= 0 ? '#059669' : '#dc2626'}">${growthRate > 0 ? '+' : ''}${growthRate}%</td>
                `;
                
                previousAmount = data.amount;
            });
        }

        function updateTransactionsTab() {
            const tbody = document.querySelector('#transactionsTable tbody');
            tbody.innerHTML = '';
            
            const recentTransactions = allTransactions.slice(0, 100);
            
            recentTransactions.forEach(t => {
                const row = tbody.insertRow();
                row.className = `transaction-type-${t.type === 'ì…ê¸ˆ' ? 'income' : 'outcome'}`;
                
                let classification = '';
                if (t.excluded) {
                    classification = '<span class="status-badge status-excluded">ì œì™¸</span>';
                } else {
                    const customer = allCustomers[t.customer];
                    if (customer && t.type === 'ì…ê¸ˆ') {
                        if (customer.depositAmount > 0 && t.inAmount === customer.depositAmount && t.date === customer.depositDate) {
                            classification = '<span class="status-badge status-deposit">ë³´ì¦ê¸ˆ</span>';
                        } else {
                            classification = '<span class="status-badge status-sales">ë§¤ì¶œ</span>';
                        }
                    } else if (customer && t.type === 'ì¶œê¸ˆ' && customer.returnDate && t.date === customer.returnDate) {
                        classification = '<span class="status-badge status-returned">í™˜ê¸‰</span>';
                    } else {
                        classification = '<span class="status-badge">ì¼ë°˜</span>';
                    }
                }
                
                row.innerHTML = `
                    <td>${t.date.substring(0, 10)}</td>
                    <td><strong>${t.customer}</strong></td>
                    <td class="amount-positive">${t.type === 'ì…ê¸ˆ' ? 'â‚©' + t.inAmount.toLocaleString() : '-'}</td>
                    <td class="amount-negative">${t.type === 'ì¶œê¸ˆ' ? 'â‚©' + t.outAmount.toLocaleString() : '-'}</td>
                    <td>${classification}</td>
                    <td style="font-size: 0.9em;">${t.type === 'ì…ê¸ˆ' ? 'ì…ê¸ˆ' : 'ì¶œê¸ˆ'}</td>
                `;
                
                row.setAttribute('data-type', t.type);
                row.setAttribute('data-customer', t.customer);
                row.setAttribute('data-amount', t.inAmount || t.outAmount);
            });
        }

        function filterTable(filterId) {
            const searchTerm = document.getElementById(filterId)?.value.toLowerCase() || '';
            const filterValue = filterId.includes('Filter') ? searchTerm : 
                               document.getElementById(filterId.replace('Search', 'Filter'))?.value || 'all';
            
            if (filterId.includes('customer')) {
                filterCustomersTable(searchTerm, filterValue);
            } else if (filterId.includes('sales')) {
                filterSalesTable(searchTerm, filterValue);
            } else if (filterId.includes('transaction')) {
                filterTransactionsTable(searchTerm, filterValue);
            }
        }

        function filterCustomersTable(searchTerm, filterValue) {
            const rows = document.querySelectorAll('#customersTable tbody tr:not(.detail-row)');
            
            rows.forEach(row => {
                const customerName = row.cells[0].textContent.toLowerCase();
                const totalAmount = parseInt(row.cells[1].textContent.replace(/[â‚©,]/g, ''));
                const depositAmount = parseInt(row.cells[2].textContent.replace(/[â‚©,]/g, ''));
                const excluded = row.cells[6].textContent.includes('ì œì™¸');
                
                let showRow = true;
                
                if (searchTerm && !customerName.includes(searchTerm)) {
                    showRow = false;
                }
                
                switch (filterValue) {
                    case 'deposit':
                        if (depositAmount === 0) showRow = false;
                        break;
                    case 'sales':
                        if (depositAmount > 0) showRow = false;
                        break;
                    case 'large':
                        if (totalAmount < 10000000) showRow = false;
                        break;
                    case 'excluded':
                        if (!excluded) showRow = false;
                        break;
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }

        function filterSalesTable(searchTerm, filterValue) {
            const rows = document.querySelectorAll('#salesTable tbody tr');
            
            rows.forEach(row => {
                const customerName = row.cells[0].textContent.toLowerCase();
                const salesAmount = parseInt(row.cells[1].textContent.replace(/[â‚©,]/g, ''));
                const type = row.getAttribute('data-type');
                
                let showRow = true;
                
                if (searchTerm && !customerName.includes(searchTerm)) {
                    showRow = false;
                }
                
                switch (filterValue) {
                    case 'pure':
                        if (type !== 'pure') showRow = false;
                        break;
                    case 'deposit-linked':
                        if (type !== 'deposit-linked') showRow = false;
                        break;
                    case 'large':
                        if (salesAmount < 5000000) showRow = false;
                        break;
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }

        function filterTransactionsTable(searchTerm, filterValue) {
            const rows = document.querySelectorAll('#transactionsTable tbody tr');
            
            rows.forEach(row => {
                const date = row.cells[0].textContent;
                const customerName = row.cells[1].textContent.toLowerCase();
                const type = row.getAttribute('data-type');
                const amount = parseInt(row.getAttribute('data-amount'));
                
                let showRow = true;
                
                if (searchTerm && !customerName.includes(searchTerm) && !date.includes(searchTerm)) {
                    showRow = false;
                }
                
                switch (filterValue) {
                    case 'income':
                        if (type !== 'ì…ê¸ˆ') showRow = false;
                        break;
                    case 'outcome':
                        if (type !== 'ì¶œê¸ˆ') showRow = false;
                        break;
                    case 'large':
                        if (amount < 1000000) showRow = false;
                        break;
                    case 'recent':
                        const transactionDate = new Date(date);
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        if (transactionDate < thirtyDaysAgo) showRow = false;
                        break;
                }
                
                row.style.display = showRow ? '' : 'none';
            });
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function clearData() {
            if (confirm('ì •ë§ë¡œ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                allTransactions = [];
                allCustomers = {};
                uploadHistory = [];
                analysisComplete = false;
                
                localStorage.removeItem(STORAGE_KEY);
                
                updateAllTabs();
                document.getElementById('uploadStatus').innerHTML = '';
                document.getElementById('analyzeBtn').disabled = true;
                
                showNotification('âœ… ëª¨ë“  ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        }

        function saveData() {
            const dataToSave = {
                transactions: allTransactions,
                customers: allCustomers,
                uploadHistory: uploadHistory,
                timestamp: new Date().toISOString()
            };
            
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
            } catch (error) {
                console.warn('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
                showNotification('âš ï¸ ë°ì´í„°ê°€ ë„ˆë¬´ ì»¤ì„œ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function loadStoredData() {
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    const data = JSON.parse(storedData);
                    
                    allTransactions = data.transactions || [];
                    allCustomers = data.customers || {};
                    uploadHistory = data.uploadHistory || [];
                    
                    allTransactions.forEach(t => {
                        if (t.parsedDate) {
                            t.parsedDate = new Date(t.parsedDate);
                        }
                    });
                    
                    Object.values(allCustomers).forEach(customer => {
                        if (customer.firstTransactionDate) {
                            customer.firstTransactionDate = new Date(customer.firstTransactionDate);
                        }
                        if (customer.lastTransactionDate) {
                            customer.lastTransactionDate = new Date(customer.lastTransactionDate);
                        }
                        if (customer.transactions) {
                            customer.transactions.forEach(t => {
                                if (t.parsedDate) {
                                    t.parsedDate = new Date(t.parsedDate);
                                }
                            });
                        }
                    });
                    
                    uploadHistory.forEach(upload => {
                        upload.uploadTime = new Date(upload.uploadTime);
                    });
                    
                    if (allTransactions.length > 0) {
                        analysisComplete = true;
                        updateAllTabs();
                        showNotification('ğŸ’¾ ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                    }
                }
            } catch (error) {
                console.warn('ì €ì¥ëœ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                showNotification('âš ï¸ ì €ì¥ëœ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function exportData() {
            if (!analysisComplete || allTransactions.length === 0) {
                showNotification('âŒ ë¨¼ì € ë°ì´í„°ë¥¼ ë¶„ì„í•˜ì„¸ìš”!');
                return;
            }
            
            const nonExcludedCustomers = Object.values(allCustomers).filter(c => !c.excluded);
            const totalDeposits = nonExcludedCustomers.reduce((sum, c) => sum + c.depositAmount, 0);
            const totalSales = nonExcludedCustomers.reduce((sum, c) => sum + c.salesAmount, 0);
            const excludedAmount = Object.values(allCustomers).filter(c => c.excluded).reduce((sum, c) => sum + c.totalIncome, 0);
            
            const exportData = {
                timestamp: new Date().toISOString(),
                summary: {
                    totalTransactions: allTransactions.length,
                    totalCustomers: Object.keys(allCustomers).length,
                    totalIncome: allTransactions.filter(t => t.type === 'ì…ê¸ˆ').reduce((sum, t) => sum + t.inAmount, 0),
                    totalDeposits: totalDeposits,
                    excludedAmount: excludedAmount,
                    depositCustomers: nonExcludedCustomers.filter(c => c.depositAmount > 0).length,
                    unreturnedDeposits: nonExcludedCustomers.filter(c => c.depositStatus === 'unreturned').length,
                    returnedDeposits: nonExcludedCustomers.filter(c => c.depositStatus === 'returned').length
                },
                customers: allCustomers,
                uploadHistory: uploadHistory,
                topCustomers: nonExcludedCustomers
                    .sort((a, b) => b.totalIncome - a.totalIncome)
                    .slice(0, 20)
                    .map(c => ({
                        name: c.name,
                        totalIncome: c.totalIncome,
                        depositAmount: c.depositAmount,
                        salesAmount: c.salesAmount,
                        transactionCount: c.transactions.filter(t => t.type === 'ì…ê¸ˆ').length
                    }))
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ê³„ì¢Œë‚´ì—­_ì™„ì „ë¶„ì„_${new Date().toISOString().substring(0, 10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showNotification('âœ… ë¶„ì„ ê²°ê³¼ê°€ ë‚´ë³´ë‚´ì¡ŒìŠµë‹ˆë‹¤!');
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 3000);
        }

        function showProgress(percentage, message) {
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('processStatus').textContent = message;
        }

        function hideProgress() {
            setTimeout(() => {
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('processStatus').textContent = '';
            }, 1000);
        }
    </script>
</body>

              
